<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viaggio in Giappone 2024</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase -->
    <script type="module">
        // Importa le funzioni necessarie dai moduli Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Importazioni corrette per Firestore
        import { getFirestore, collection, doc, addDoc, onSnapshot, query, where, getDocs, writeBatch, deleteDoc, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Importazioni corrette per Auth
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // =================================================================================
        // CONFIGURAZIONE INIZIALE
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDF6KbJueQwWaeEVGRfI2AKqJ8or-AVjIk",
            authDomain: "giappini2025.firebaseapp.com",
            projectId: "giappini2025",
            storageBucket: "giappini2025.appspot.com",
            messagingSenderId: "733326492471",
            appId: "1:733326492471:web:09c93b1a6e5d4543b550b2",
            measurementId: "G-D9LKF6YET3"
        };
        // =================================================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Variabili globali
        let tripData = [];
        let currentDayUnsubscribeNotes = null;
        let currentDayUnsubscribeExpenses = null;
        let currentDayUnsubscribePlannerItems = null; 
        let currentDayUnsubscribeUnassignedItems = null;
        let itineraryUnsubscribe = null;
        let backpackUnsubscribe = null;
        let plannerItemsUnsubscribe = null; 
        let chatUnsubscribe = null;
        let clockInterval = null;
        let italianClockInterval = null;
        let currentActiveDate = null;
        let currentBackpackUser = 'pino';
        let currentBackpackFilter = 'Tutti';
        let map;
        let modalMap;
        let dayDetailMap;
        let modalMarker;
        let dayDetailMapMarkers = [];
        let currentMapCity = 'Tokyo';
        let mapMarkers = [];
        let googleMapsApiLoaded = false;
        let editingItemId = null; 
        let currentUnassignedFilter = 'Tutti';

        let currentPlannerItemTagFilter = 'Tutti';
        let currentPlannerItemBookedFilter = 'Tutti';
        let currentPlannerItemDateFilter = '';

        // Elementi UI
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const homeView = document.getElementById('home-view');
        const dayDetailView = document.getElementById('day-detail-view');
        const backpackView = document.getElementById('backpack-view');
        const mapView = document.getElementById('map-view');
        const chatView = document.getElementById('chat-view');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const itemModal = document.getElementById('item-modal');


        // Gestione autenticazione
        onAuthStateChanged(auth, user => {
            if (user) {
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loadGoogleMapsScript(); // FIX: Carica le mappe subito
                setupInitialItinerary().then(() => {
                    loadItineraryAndInitApp();
                    setupAppEventListeners();
                });
            } else {
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                // Cleanup dei listener
                if (itineraryUnsubscribe) itineraryUnsubscribe();
                if (currentDayUnsubscribeNotes) currentDayUnsubscribeNotes();
                if (currentDayUnsubscribeExpenses) currentDayUnsubscribeExpenses();
                if (currentDayUnsubscribePlannerItems) currentDayUnsubscribePlannerItems();
                if (currentDayUnsubscribeUnassignedItems) currentDayUnsubscribeUnassignedItems();
                if (backpackUnsubscribe) backpackUnsubscribe();
                if (plannerItemsUnsubscribe) plannerItemsUnsubscribe();
                if (chatUnsubscribe) chatUnsubscribe();
                if(clockInterval) clearInterval(clockInterval);
                if(italianClockInterval) clearInterval(italianClockInterval);
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            loginError.textContent = '';
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    console.error("Login failed:", error);
                    loginError.textContent = 'Credenziali non valide. Riprova.';
                });
        });

        function setupAppEventListeners() {
            // Navigation
            document.getElementById('nav-itinerary-btn').addEventListener('click', () => navigateTo('home'));
            document.getElementById('nav-backpack-btn').addEventListener('click', () => { navigateTo('backpack'); loadAndDisplayBackpackItems(); });
            document.getElementById('nav-map-btn').addEventListener('click', () => { navigateTo('map'); populateMapCityDropdown(); });
            document.getElementById('nav-chat-btn').addEventListener('click', () => {
                navigateTo('chat');
                populateChatDateDropdown();
                if (currentActiveDate) {
                    document.getElementById('chat-date-select').value = currentActiveDate;
                    loadAndDisplayChatMessages(currentActiveDate);
                } else if (tripData.length > 0) {
                    document.getElementById('chat-date-select').value = tripData[0].date;
                    loadAndDisplayChatMessages(tripData[0].date);
                }
            });
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

            // Day Detail View
            document.getElementById('current-location-weather-btn').onclick = () => getGeolocationWeather();
            document.getElementById('save-expense-btn').onclick = () => saveExpense(currentActiveDate);
            document.getElementById('go-to-chat-btn').onclick = () => {
                navigateTo('chat');
                document.getElementById('chat-date-select').value = currentActiveDate;
                loadAndDisplayChatMessages(currentActiveDate);
            };

            // Backpack View
            document.getElementById('add-backpack-item-btn').onclick = saveBackpackItem;
            document.getElementById('select-pino-backpack-btn').onclick = () => switchBackpack('pino');
            document.getElementById('select-pina-backpack-btn').onclick = () => switchBackpack('pina');
            document.getElementById('filter-tutti-btn').onclick = () => filterBackpackItems('Tutti');
            document.getElementById('filter-abbigliamento-btn').onclick = () => filterBackpackItems('Abbigliamento');
            document.getElementById('filter-elettronica-btn').onclick = () => filterBackpackItems('Elettronica');
            document.getElementById('filter-igiene-personale-btn').onclick = () => filterBackpackItems('Igiene Personale');
            document.getElementById('filter-documenti-btn').onclick = () => filterBackpackItems('Documenti');
            document.getElementById('filter-farmaci-btn').onclick = () => filterBackpackItems('Farmaci');
            document.getElementById('filter-varie-btn').onclick = () => filterBackpackItems('Varie');

            // Map View
            document.getElementById('map-city-select').addEventListener('change', changeMapCity);
            document.getElementById('open-item-modal-map-btn').addEventListener('click', () => openItemModal({ city: currentMapCity }));

            // Planner items filters
            document.getElementById('filter-tag-tutti-btn').addEventListener('click', () => filterPlannerItemsByTag('Tutti'));
            document.getElementById('filter-tag-attrazione-btn').addEventListener('click', () => filterPlannerItemsByTag('Attrazione'));
            document.getElementById('filter-tag-ristorante-btn').addEventListener('click', () => filterPlannerItemsByTag('Ristorante'));
            document.getElementById('filter-tag-trasporto-btn').addEventListener('click', () => filterPlannerItemsByTag('Trasporto'));
            document.getElementById('filter-tag-alloggio-btn').addEventListener('click', () => filterPlannerItemsByTag('Alloggio'));
            document.getElementById('filter-tag-evento-btn').addEventListener('click', () => filterPlannerItemsByTag('Evento'));
            document.getElementById('filter-booked-tutti-btn').addEventListener('click', () => filterPlannerItemsByBookedStatus('Tutti'));
            document.getElementById('filter-booked-prenotati-btn').addEventListener('click', () => filterPlannerItemsByBookedStatus('Prenotati'));
            document.getElementById('filter-booked-non-prenotati-btn').addEventListener('click', () => filterPlannerItemsByBookedStatus('Non Prenotati'));
            document.getElementById('filter-planner-item-date-input').addEventListener('change', filterPlannerItemsByDate);
            document.getElementById('clear-planner-item-date-filter-btn').addEventListener('click', clearPlannerItemDateFilter);

            // Chat View
            const chatInput = document.getElementById('chat-input');
            const sendChatMessageBtn = document.getElementById('send-chat-message-btn');
            const translateInput = document.getElementById('translate-input-chat');
            const translateBtn = document.getElementById('translate-and-add-chat-btn');

            chatInput.addEventListener('input', () => { sendChatMessageBtn.disabled = chatInput.value.trim() === ''; });
            translateInput.addEventListener('input', () => { translateBtn.disabled = translateInput.value.trim() === ''; });

            sendChatMessageBtn.addEventListener('click', sendChatMessage);
            translateBtn.addEventListener('click', translateAndAddChat);
            document.getElementById('chat-date-select').addEventListener('change', (e) => loadAndDisplayChatMessages(e.target.value));
            document.getElementById('toggle-keyboard-chat-btn').addEventListener('click', toggleKeyboardLanguageChat);
            document.getElementById('clear-translation-chat-btn').addEventListener('click', clearTranslationBoxesChat);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(); } });
            translateInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); translateAndAddChat(); } });

            // Import JSON & Migration
            document.getElementById('import-json-btn').addEventListener('click', () => document.getElementById('import-json-input').click());
            document.getElementById('import-json-input').addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            if (Array.isArray(jsonData)) {
                                await importItineraryFromJson(jsonData);
                                showCustomAlert('Itinerario importato con successo!');
                            } else {
                                showCustomAlert('Errore: Il file JSON non contiene un array valido.');
                            }
                        } catch (error) {
                            console.error("Errore importazione JSON:", error);
                            showCustomAlert('Errore durante l\'importazione del file JSON.');
                        }
                    };
                    reader.readAsText(file);
                }
            });
            document.getElementById('migrate-data-btn').addEventListener('click', migrateOldData);
            
            // =================================================================
            // GESTIONE DEGLI EVENTI GLOBALE (EVENT DELEGATION)
            // =================================================================
            appContainer.addEventListener('click', async (e) => {
                const dayData = tripData.find(d => d.date === currentActiveDate);
                
                // Home View Card Click
                const dayCard = e.target.closest('.day-card-btn');
                if (dayCard && dayCard.dataset.date) {
                    renderDayDetailView(dayCard.dataset.date);
                    navigateTo('day-detail');
                    return;
                }

                // Planner Items (Modifica / Elimina)
                const editPlannerBtn = e.target.closest('.edit-planner-item-btn');
                if (editPlannerBtn) {
                    openItemModal({ id: editPlannerBtn.dataset.id });
                    return;
                }
                const deletePlannerBtn = e.target.closest('.delete-planner-item-btn');
                if (deletePlannerBtn) {
                    deletePlannerItem(deletePlannerBtn.dataset.id);
                    return;
                }

                // Day Detail View
                if (dayDetailView.contains(e.target) && dayData) {
                    // Alloggio
                    if (e.target.closest('.edit-accommodation-btn')) editAccommodation(dayData);
                    if (e.target.closest('.save-accommodation-btn')) await saveEditedAccommodation(dayData.date);
                    if (e.target.closest('.cancel-accommodation-btn')) renderDayDetailView(dayData.date);

                    // Spostamenti
                    if (e.target.closest('.add-travel-btn')) addTravelItem(dayData);
                    if (e.target.closest('.edit-travel-btn')) editTravelItem(dayData, e.target.closest('.edit-travel-btn').dataset.index);
                    if (e.target.closest('.save-travel-btn')) await saveEditedTravelItem(dayData.date, e.target.closest('.save-travel-btn').dataset.index);
                    if (e.target.closest('.cancel-travel-btn')) renderDayDetailView(dayData.date);
                    if (e.target.closest('.delete-travel-btn')) {
                        if (await showCustomConfirm("Sei sicuro di voler eliminare questo spostamento?")) {
                            await deleteTravelItem(dayData.date, e.target.closest('.delete-travel-btn').dataset.index);
                        }
                    }

                    // Planner Items (Aggiungi nuovo)
                    if (e.target.closest('.add-planner-item-btn')) {
                        openItemModal({ city: dayData.location.split('/')[0].trim(), giornoIndicativo: currentActiveDate });
                    }
                    
                    // Filtri Luoghi da Esplorare
                    const unassignedFilterBtn = e.target.closest('.unassigned-filter-btn');
                    if (unassignedFilterBtn) {
                        currentUnassignedFilter = unassignedFilterBtn.dataset.filter;
                        loadAndDisplayUnassignedItemsForDay(dayData.location.split('/')[0].trim());
                    }
                }
            });

            // Modali
            document.getElementById('save-item-btn').addEventListener('click', saveItem);
            document.getElementById('close-item-modal-btn').addEventListener('click', closeItemModal);
            document.getElementById('item-modal-search-btn').addEventListener('click', searchPlacesForItemModal);
            document.getElementById('item-bookable').addEventListener('change', toggleBookingFields);
            document.getElementById('item-booked').addEventListener('change', toggleBookingFields);

            // Initial setup calls
            setupCollapsibleBoxesDelegation();
            switchBackpack('pino'); 
            filterBackpackItems('Tutti');
            filterPlannerItemsByTag(currentPlannerItemTagFilter);
            filterPlannerItemsByBookedStatus(currentPlannerItemBookedFilter);
        }

        function navigateTo(viewName) {
            const views = { 'home': homeView, 'day-detail': dayDetailView, 'backpack': backpackView, 'map': mapView, 'chat': chatView };
            Object.values(views).forEach(view => {
                view.classList.add('opacity-0', 'pointer-events-none');
                view.classList.remove('opacity-100');
            });
            setTimeout(() => {
                Object.values(views).forEach(view => view.classList.add('hidden'));
                const nextView = views[viewName];
                if (nextView) {
                    nextView.classList.remove('hidden');
                    void nextView.offsetWidth; 
                    nextView.classList.remove('opacity-0', 'pointer-events-none');
                    nextView.classList.add('opacity-100');
                    nextView.querySelectorAll('.fade-in-up').forEach((el, index) => {
                        el.style.animationDelay = `${index * 0.1}s`;
                        el.classList.remove('fade-in-up');
                        void el.offsetWidth;
                        el.classList.add('fade-in-up');
                    });
                }
            }, 300);
        }

        async function setupInitialItinerary() {
            const itineraryCol = collection(db, 'itinerary');
            const snapshot = await getDocs(itineraryCol);
            if (snapshot.empty) {
                console.log("Populating itinerary from JSON...");
                try {
                    const response = await fetch('tripData.json');
                    if (!response.ok) throw new Error('Failed to load tripData.json');
                    const initialData = await response.json();
                    const batch = writeBatch(db);
                    initialData.forEach(day => batch.set(doc(db, "itinerary", day.date), day));
                    await batch.commit();
                    console.log("Itinerary populated successfully.");
                } catch (error) {
                    console.error("Error populating initial itinerary:", error);
                }
            }
        }
        
        function loadItineraryAndInitApp() {
            const itineraryCol = collection(db, 'itinerary');
            if (itineraryUnsubscribe) itineraryUnsubscribe();
            itineraryUnsubscribe = onSnapshot(query(itineraryCol), (snapshot) => {
                tripData = [];
                snapshot.forEach(doc => tripData.push({ id: doc.id, ...doc.data() }));
                tripData.sort((a, b) => new Date(a.date) - new Date(b.date));
                populateCityTagDropdown();
                populateMapCityDropdown();
                populateChatDateDropdown();
                renderHomeView();
                navigateTo('home');
            });
        }
        
        const locationImages = {
            "Tokyo": "images/tokyo.jpg",
            "Ryokan (Takaragawa Onsen)": "images/takaragawaonsen.jpg",
            "Kanazawa": "images/kanazawa.jpg",
            "Shirakawa-go": "images/shirakawago.jpg",
            "Kyoto": "images/kyoto.jpg",
            "Osaka": "images/osaka.jpeg",
            "Nara": "images/nara.jpg",
            "Volo di Ritorno": "images/tokyo2.jpg",
            "default": "images/giappone.jpg"
        };

        const cityCoordinates = {
            "Tokyo": { latitude: 35.6895, longitude: 139.6917, zoom: 12 },
            "Ryokan (Takaragawa Onsen)": { latitude: 36.8528, longitude: 139.0287, zoom: 12 },
            "Kanazawa": { latitude: 36.5612, longitude: 136.6562, zoom: 12 },
            "Shirakawa-go": { latitude: 36.2575, longitude: 136.8973, zoom: 14 },
            "Kyoto": { latitude: 35.0116, longitude: 135.7681, zoom: 12 },
            "Osaka": { latitude: 34.6937, longitude: 135.5022, zoom: 12 },
            "Nara": { latitude: 34.6851, longitude: 135.8048, zoom: 13 },
            "Volo di Ritorno": { latitude: 0, longitude: 0, zoom: 1 },
            "default": { latitude: 35.6895, longitude: 139.6917, zoom: 12 }
        };

        function renderHomeView() {
            const itineraryListContainer = document.getElementById('itinerary-list-container');
            itineraryListContainer.innerHTML = '';
            const homeImageEl = document.getElementById('home-title-image');
            if (homeImageEl) {
                homeImageEl.src = locationImages["default"];
                homeImageEl.alt = "Paesaggio Giapponese";
            }
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let firstDayBeforeTripFound = false;
            let firstDayDate = tripData.length > 0 ? new Date(tripData[0].date) : null;
            if (firstDayDate) firstDayDate.setHours(0, 0, 0, 0);
            tripData.forEach(day => {
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card-btn bg-gray-800 p-4 rounded-lg border border-gray-700 hover:bg-gray-700/50 cursor-pointer transition-colors duration-200 flex items-center gap-4';
                dayCard.dataset.date = day.date;
                const dayDate = new Date(day.date);
                dayDate.setHours(0, 0, 0, 0);
                let isPast = dayDate < today;
                let isToday = dayDate.getTime() === today.getTime();
                let isHighlighted = false;
                if (isToday) {
                    isHighlighted = true;
                } else if (!firstDayBeforeTripFound && firstDayDate && today < firstDayDate && dayDate.getTime() === firstDayDate.getTime()) {
                    isHighlighted = true;
                    firstDayBeforeTripFound = true;
                }
                if (isHighlighted) { dayCard.classList.add('bg-green-700/30', 'border-green-500'); }
                else if (isPast) { dayCard.classList.add('text-gray-500'); }
                else { dayCard.classList.add('text-gray-200'); }

                dayCard.innerHTML = `
                    <div class="flex-grow grid grid-cols-1 sm:grid-cols-3 gap-x-4 gap-y-2">
                        <div>
                            <span class="sm:hidden font-bold text-xs text-gray-400">Data</span>
                            <p>${dayDate.toLocaleDateString('it-IT', { weekday: 'long', day: '2-digit', month: '2-digit' })}</p>
                        </div>
                        <div>
                            <span class="sm:hidden font-bold text-xs text-gray-400">Luogo</span>
                            <p>${day.location}</p>
                        </div>
                        <div>
                            <span class="sm:hidden font-bold text-xs text-gray-400">Alloggio</span>
                            <p class="truncate">${day.accommodation.name}</p>
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <i data-lucide="chevron-right" class="w-5 h-5 inline-block ${isHighlighted ? 'text-green-400' : (isPast ? 'text-gray-600' : 'text-red-400')}"></i>
                    </div>
                `;
                itineraryListContainer.appendChild(dayCard);
            });
            lucide.createIcons();
        }

        function renderDayDetailView(dateString, direction = 'none') {
            const dayData = tripData.find(d => d.date === dateString);
            if (!dayData) return;

            currentActiveDate = dateString;
            // Clear all listeners
            if (currentDayUnsubscribeNotes) currentDayUnsubscribeNotes();
            if (currentDayUnsubscribeExpenses) currentDayUnsubscribeExpenses();
            if (currentDayUnsubscribePlannerItems) currentDayUnsubscribePlannerItems();
            if (currentDayUnsubscribeUnassignedItems) currentDayUnsubscribeUnassignedItems();
            if (backpackUnsubscribe) backpackUnsubscribe();
            if (plannerItemsUnsubscribe) plannerItemsUnsubscribe();
            if (chatUnsubscribe) chatUnsubscribe();
            if (clockInterval) clearInterval(clockInterval);
            if (italianClockInterval) clearInterval(italianClockInterval);

            // Render static info
            document.getElementById('location').textContent = dayData.location;
            document.getElementById('date').textContent = new Date(dayData.date).toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const dayDetailImageEl = document.getElementById('day-detail-title-image');
            if (dayDetailImageEl) {
                const imageUrl = locationImages[dayData.location.split('/')[0].trim()] || locationImages["default"];
                dayDetailImageEl.src = imageUrl;
                dayDetailImageEl.alt = `Immagine di ${dayData.location}`;
            }

            // Weather and Clocks
            const cityKey = dayData.location.split('/')[0].trim();
            const coords = cityCoordinates[cityKey] || cityCoordinates.default;
            getWeather(coords.latitude, coords.longitude, cityKey);
            updateClock('Asia/Tokyo', 'local-time');
            updateClock('Europe/Rome', 'italian-local-time');

            // Render Accommodation
            const accommodationEl = document.getElementById('accommodation-widget');
            const acc = dayData.accommodation;
            accommodationEl.innerHTML = `
                <div id="accommodation-display">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-semibold text-white">${acc.name}</div>
                            ${acc.details ? `<div class="text-sm text-gray-300">${acc.details}</div>` : ''}
                            ${acc.price ? `<div class="text-sm text-gray-300 mt-1">Prezzo: <span class="font-semibold">${acc.price}</span></div>` : ''}
                            ${acc.phone ? `<div class="text-sm text-gray-300 flex items-center gap-1 mt-1"><i data-lucide="phone" class="w-3 h-3"></i> ${acc.phone}</div>` : ''}
                            ${acc.numero_conferma ? `<div class="text-sm text-gray-300 mt-1">N. Conferma: <span class="font-semibold">${acc.numero_conferma}</span></div>` : ''}
                            ${acc.pin ? `<div class="text-sm text-gray-300 mt-1">PIN: <span class="font-semibold">${acc.pin}</span></div>` : ''}
                        </div>
                        <button class="edit-accommodation-btn p-2 rounded-full bg-red-600/80 hover:bg-red-700 text-white transition-colors duration-200">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="flex gap-4 mt-2">
                        ${acc.mapLink ? `<a href="${acc.mapLink}" target="_blank" class="text-blue-400 hover:underline text-sm flex items-center gap-1"><i data-lucide="map-pin" class="w-4 h-4"></i>Mappa</a>` : ''}
                        ${acc.reservationLink ? `<a href="${acc.reservationLink}" target="_blank" class="text-blue-400 hover:underline text-sm flex items-center gap-1"><i data-lucide="link" class="w-4 h-4"></i>Prenotazione</a>` : ''}
                    </div>
                </div>
                <div id="accommodation-edit" class="hidden"></div>
            `;

            // Render Spostamenti
            const travelListEl = document.getElementById('travel-list');
            travelListEl.innerHTML = ''; 
            document.getElementById('travel-form-container').innerHTML = '';

            if (!dayData.travel || dayData.travel.length === 0) {
                travelListEl.innerHTML = `<div class="text-gray-400 text-center">Nessuno spostamento per oggi.</div>`;
            } else {
                dayData.travel.forEach((item, index) => {
                    travelListEl.innerHTML += `
                        <div class="p-3 rounded-lg bg-gray-700/30" id="travel-display-${index}">
                            <div class="flex items-start gap-3">
                                <i data-lucide="train-front" class="w-5 h-5 text-red-400 mt-1 flex-shrink-0"></i>
                                <div class="flex-grow">
                                    <div class="font-medium text-white">${item.type}</div>
                                    <div class="text-gray-300 text-sm">${item.description}</div>
                                    ${item.price ? `<div class="text-gray-400 text-xs mt-1">Costo: ${item.price}</div>` : ''}
                                    ${item.start && item.end ? `<div class="text-gray-400 text-xs">Orario: ${item.start} - ${item.end}</div>` : ''}
                                    <div class="flex gap-4 mt-2">
                                        ${item.tickets_link ? `<a href="${item.tickets_link}" target="_blank" class="text-blue-400 hover:underline text-xs flex items-center gap-1"><i data-lucide="ticket" class="w-3 h-3"></i>Biglietti</a>` : ''}
                                        ${item.tickets_receipt ? `<a href="${item.tickets_receipt}" target="_blank" class="text-blue-400 hover:underline text-xs flex items-center gap-1"><i data-lucide="receipt" class="w-3 h-3"></i>Ricevuta</a>` : ''}
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <button data-index="${index}" class="edit-travel-btn p-2 rounded-full bg-red-600/80 hover:bg-red-700 text-white transition-colors duration-200">
                                        <i data-lucide="pencil" class="w-4 h-4"></i>
                                    </button>
                                    <button data-index="${index}" class="delete-travel-btn p-2 rounded-full bg-red-800/80 hover:bg-red-900 text-white transition-colors duration-200">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            // Load other dynamic sections
            loadAndDisplayExpenses(dateString);
            loadAndDisplayPlannerItemsForDay(dateString);
            loadAndDisplayUnassignedItemsForDay(cityKey);
            renderTodaysBackpackItems(cityKey);
            
            // Navigation buttons
            const currentIndex = tripData.findIndex(d => d.date === dateString);
            const prevDayBtn = document.getElementById('prev-day-btn');
            const nextDayBtn = document.getElementById('next-day-btn');
            if (prevDayBtn) {
                if (currentIndex > 0) {
                    prevDayBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    prevDayBtn.onclick = () => navigateDay(currentIndex - 1);
                } else {
                    prevDayBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    prevDayBtn.onclick = null;
                }
            }
            if (nextDayBtn) {
                if (currentIndex < tripData.length - 1) {
                    nextDayBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    nextDayBtn.onclick = () => navigateDay(currentIndex + 1);
                } else {
                    nextDayBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    nextDayBtn.onclick = null;
                }
            }

            lucide.createIcons();

            // Animation
            const dayContentWrapper = document.getElementById('day-content-wrapper');
            if (dayContentWrapper) {
                dayContentWrapper.classList.remove('slide-left-in', 'slide-right-in');
                void dayContentWrapper.offsetWidth;
                if (direction === 'next') { dayContentWrapper.classList.add('slide-right-in'); }
                else if (direction === 'prev') { dayContentWrapper.classList.add('slide-left-in'); }
                setTimeout(() => { dayContentWrapper.classList.remove('slide-right-in', 'slide-left-in'); }, 300);
            }
        }

        function editAccommodation(dayData) {
            const displayDiv = document.getElementById('accommodation-display');
            const editDiv = document.getElementById('accommodation-edit');
            const acc = dayData.accommodation;

            displayDiv.classList.add('hidden');
            editDiv.classList.remove('hidden');
            editDiv.innerHTML = `
                <div class="flex flex-col gap-2 w-full text-sm">
                    <input type="text" id="edit-acc-name" class="form-input p-2 rounded-md" value="${acc.name || ''}" placeholder="Nome Alloggio">
                    <input type="text" id="edit-acc-details" class="form-input p-2 rounded-md" value="${acc.details || ''}" placeholder="Dettagli">
                    <input type="text" id="edit-acc-price" class="form-input p-2 rounded-md" value="${acc.price || ''}" placeholder="Prezzo">
                    <input type="text" id="edit-acc-phone" class="form-input p-2 rounded-md" value="${acc.phone || ''}" placeholder="Telefono">
                    <input type="text" id="edit-acc-confirm" class="form-input p-2 rounded-md" value="${acc.numero_conferma || ''}" placeholder="N. Conferma">
                    <input type="text" id="edit-acc-pin" class="form-input p-2 rounded-md" value="${acc.pin || ''}" placeholder="PIN">
                    <input type="url" id="edit-acc-maplink" class="form-input p-2 rounded-md" value="${acc.mapLink || ''}" placeholder="Link Mappa">
                    <input type="url" id="edit-acc-reslink" class="form-input p-2 rounded-md" value="${acc.reservationLink || ''}" placeholder="Link Prenotazione">
                    <div class="flex gap-2 mt-2">
                        <button class="save-accommodation-btn flex-1 bg-green-600 hover:bg-green-700 text-white p-2 rounded-md">Salva</button>
                        <button class="cancel-accommodation-btn flex-1 bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md">Annulla</button>
                    </div>
                </div>
            `;
        }

        async function saveEditedAccommodation(dateString) {
            const updatedAccommodation = {
                name: document.getElementById('edit-acc-name').value,
                details: document.getElementById('edit-acc-details').value,
                price: document.getElementById('edit-acc-price').value,
                phone: document.getElementById('edit-acc-phone').value,
                numero_conferma: document.getElementById('edit-acc-confirm').value,
                pin: document.getElementById('edit-acc-pin').value,
                mapLink: document.getElementById('edit-acc-maplink').value,
                reservationLink: document.getElementById('edit-acc-reslink').value,
            };

            const dayRef = doc(db, "itinerary", dateString);
            try {
                await updateDoc(dayRef, { accommodation: updatedAccommodation });
                showCustomAlert("Alloggio aggiornato con successo!");
            } catch (error) {
                console.error("Errore aggiornamento alloggio:", error);
                showCustomAlert("Errore durante l'aggiornamento dell'alloggio.");
            }
        }

        function addTravelItem(dayData) {
            editTravelItem(dayData, -1);
        }

        function editTravelItem(dayData, index) {
            const isNew = index == -1;
            const item = isNew ? {} : dayData.travel[index];
            const formContainer = document.getElementById('travel-form-container');

            if (!isNew) {
                document.getElementById(`travel-display-${index}`).classList.add('hidden');
            }
            
            formContainer.innerHTML = `
                <div class="p-3 rounded-lg bg-gray-700/50 border border-red-500 mt-3">
                    <h4 class="font-semibold text-white mb-2">${isNew ? 'Nuovo Spostamento' : 'Modifica Spostamento'}</h4>
                    <div class="flex flex-col gap-2 w-full text-sm">
                        <input type="text" id="edit-travel-type" class="form-input p-2 rounded-md" value="${item.type || ''}" placeholder="Tipo (es. Treno)">
                        <input type="text" id="edit-travel-desc" class="form-input p-2 rounded-md" value="${item.description || ''}" placeholder="Descrizione">
                        <input type="text" id="edit-travel-price" class="form-input p-2 rounded-md" value="${item.price || ''}" placeholder="Prezzo">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="edit-travel-start" class="form-input p-2 rounded-md" value="${item.start || ''}" placeholder="Inizio (es. 10:00)">
                            <input type="text" id="edit-travel-end" class="form-input p-2 rounded-md" value="${item.end || ''}" placeholder="Fine (es. 11:30)">
                        </div>
                        <input type="url" id="edit-travel-tlink" class="form-input p-2 rounded-md" value="${item.tickets_link || ''}" placeholder="Link Biglietti">
                        <input type="url" id="edit-travel-rlink" class="form-input p-2 rounded-md" value="${item.tickets_receipt || ''}" placeholder="Link Ricevuta">
                        <div class="flex gap-2 mt-2">
                            <button data-index="${index}" class="save-travel-btn flex-1 bg-green-600 hover:bg-green-700 text-white p-2 rounded-md">Salva</button>
                            <button data-index="${index}" class="cancel-travel-btn flex-1 bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md">Annulla</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveEditedTravelItem(dateString, index) {
            const isNew = index == -1;
            const dayData = tripData.find(d => d.date === dateString);
            const travelArray = dayData.travel ? [...dayData.travel] : [];

            const updatedItem = {
                type: document.getElementById('edit-travel-type').value,
                description: document.getElementById('edit-travel-desc').value,
                price: document.getElementById('edit-travel-price').value,
                start: document.getElementById('edit-travel-start').value,
                end: document.getElementById('edit-travel-end').value,
                tickets_link: document.getElementById('edit-travel-tlink').value,
                tickets_receipt: document.getElementById('edit-travel-rlink').value,
            };

            if (isNew) {
                travelArray.push(updatedItem);
            } else {
                travelArray[index] = updatedItem;
            }

            const dayRef = doc(db, "itinerary", dateString);
            try {
                await updateDoc(dayRef, { travel: travelArray });
                showCustomAlert(`Spostamento ${isNew ? 'aggiunto' : 'aggiornato'} con successo!`);
            } catch (error) {
                console.error("Errore salvataggio spostamento:", error);
                showCustomAlert("Errore durante il salvataggio.");
            }
        }

        async function deleteTravelItem(dateString, index) {
            const dayData = tripData.find(d => d.date === dateString);
            const travelArray = dayData.travel ? [...dayData.travel] : [];
            travelArray.splice(index, 1);

            const dayRef = doc(db, "itinerary", dateString);
            try {
                await updateDoc(dayRef, { travel: travelArray });
                showCustomAlert("Spostamento eliminato con successo!");
            } catch (error) {
                console.error("Errore eliminazione spostamento:", error);
                showCustomAlert("Errore durante l'eliminazione.");
            }
        }
        
        function navigateDay(index) {
            if (index >= 0 && index < tripData.length) {
                const newDate = tripData[index].date;
                const currentDayContentWrapper = document.getElementById('day-content-wrapper');
                const currentIndex = tripData.findIndex(d => d.date === currentActiveDate);
                const direction = index > currentIndex ? 'next' : 'prev';
                if (currentDayContentWrapper) {
                    currentDayContentWrapper.classList.remove('slide-left-out', 'slide-right-out');
                    void currentDayContentWrapper.offsetWidth;
                    currentDayContentWrapper.classList.add(direction === 'next' ? 'slide-left-out' : 'slide-right-out');
                    setTimeout(() => {
                        renderDayDetailView(newDate, direction);
                        currentDayContentWrapper.classList.remove('slide-left-out', 'slide-right-out');
                    }, 300);
                } else {
                    renderDayDetailView(newDate, direction);
                }
            }
        }
        
        async function getWeather(latitude, longitude, locationName = 'Posizione attuale') {
            const weatherWidget = document.getElementById('weather-widget');
            weatherWidget.innerHTML = `<div class="text-gray-400">Caricamento meteo per ${locationName}...</div>`;
            try {
                const response = await fetch('/.netlify/functions/getWeather', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude: latitude, longitude: longitude })
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`Errore server (Meteo): ${errorBody.message || 'Sconosciuto'}`);
                }
                const data = await response.json();
                
                weatherWidget.innerHTML = `
                    <h4 class="font-semibold text-lg mb-2 text-white">${locationName}</h4>
                    <div class="flex items-center gap-4 mb-4">
                        <img src="${getWeatherIcon(data.current.weathercode)}" alt="weather icon" class="w-16 h-16 -my-2">
                        <div>
                            <div class="text-3xl font-bold text-white">${Math.round(data.current.temperature)}°C</div>
                            <div class="text-gray-300 capitalize">${data.current.description}</div>
                        </div>
                        <div class="text-sm text-gray-400">
                            <div>Umidità: ${data.current.relativehumidity_2m}%</div>
                            <div>Vento: ${data.current.windspeed_10m} km/h</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center text-sm">
                        <div><p class="font-medium text-white">Mattino</p><img src="${getWeatherIcon(data.morning.weathercode)}" alt="morning" class="w-10 h-10 mx-auto"><p class="text-gray-300">${Math.round(data.morning.temperature_2m_max)}°C</p></div>
                        <div><p class="font-medium text-white">Pomeriggio</p><img src="${getWeatherIcon(data.afternoon.weathercode)}" alt="afternoon" class="w-10 h-10 mx-auto"><p class="text-gray-300">${Math.round(data.afternoon.temperature_2m_max)}°C</p></div>
                        <div><p class="font-medium text-white">Sera</p><img src="${getWeatherIcon(data.evening.weathercode)}" alt="evening" class="w-10 h-10 mx-auto"><p class="text-gray-300">${Math.round(data.evening.temperature_2m_max)}°C</p></div>
                    </div>`;
            } catch (error) {
                console.error("Weather error:", error);
                weatherWidget.innerHTML = `<div class="text-red-400">Meteo non disponibile. ${error.message}</div>`;
            }
        }

        async function getGeolocationWeather() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const response = await fetch('/.netlify/functions/getWeather', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ latitude: lat, longitude: lon, reverseGeocode: true })
                        });
                        const data = await response.json();
                        const locationName = data.locationName || 'La tua posizione';
                        getWeather(lat, lon, locationName);
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        document.getElementById('weather-widget').innerHTML = `<div class="text-red-400">Impossibile ottenere la tua posizione.</div>`;
                    }
                );
            } else {
                document.getElementById('weather-widget').innerHTML = `<div class="text-red-400">Geolocalizzazione non supportata.</div>`;
            }
        }

        function getWeatherIcon(code) {
            const icons = { 0: "01d", 1: "02d", 2: "02d", 3: "02d", 45: "50d", 48: "50d", 51: "09d", 53: "09d", 55: "09d", 61: "10d", 63: "10d", 65: "10d", 71: "13d", 73: "13d", 75: "13d", 80: "09d", 81: "09d", 82: "09d", 95: "11d", 96: "11d", 99: "11d" };
            return `https://openweathermap.org/img/wn/${icons[code] || '01d'}@2x.png`;
        }

        function updateClock(timezone, elementId) {
            const el = document.getElementById(elementId);
            if (!el) return;
            const intervalId = setInterval(() => { el.textContent = new Date().toLocaleTimeString('it-IT', { timeZone: timezone, hour: '2-digit', minute: '2-digit', second: '2-digit' }); }, 1000);
            if (elementId === 'local-time') { if(clockInterval) clearInterval(clockInterval); clockInterval = intervalId; }
            else { if(italianClockInterval) clearInterval(italianClockInterval); italianClockInterval = intervalId; }
        }

        function loadAndDisplayExpenses(dateString) {
            const listEl = document.getElementById('expenses-list');
            const totalEl = document.getElementById('total-expenses');
            listEl.innerHTML = '<li>Caricamento...</li>';
            const q = query(collection(db, "trip-expenses"), where("date", "==", dateString));
            currentDayUnsubscribeExpenses = onSnapshot(q, (snapshot) => {
                listEl.innerHTML = '';
                let total = 0;
                let expenses = [];
                snapshot.forEach(doc => expenses.push(doc.data()));
                expenses.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());
                if (expenses.length === 0) {
                    listEl.innerHTML = '<li class="text-gray-400">Nessuna spesa.</li>';
                } else {
                    expenses.forEach(expense => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center text-sm text-gray-300';
                        li.innerHTML = `<span>${expense.description}</span> <span class="font-semibold text-white">${expense.amount} ¥</span>`;
                        listEl.appendChild(li);
                        total += parseFloat(expense.amount);
                    });
                }
                totalEl.textContent = `${total.toLocaleString('ja-JP')} ¥`;
            });
        }

        async function saveExpense(dateString) {
            const descInput = document.getElementById('expense-description');
            const amountInput = document.getElementById('expense-amount');
            if (descInput.value.trim() && amountInput.value.trim() && !isNaN(amountInput.value)) {
                await addDoc(collection(db, "trip-expenses"), { date: dateString, description: descInput.value.trim(), amount: parseFloat(amountInput.value), createdAt: new Date() });
                descInput.value = '';
                amountInput.value = '';
            }
        }
        
        function loadAndDisplayPlannerItemsForDay(dateString) {
            const listEl = document.getElementById('day-planner-items-list');
            listEl.innerHTML = '<li class="text-gray-400">Caricamento...</li>';
            if (currentDayUnsubscribePlannerItems) currentDayUnsubscribePlannerItems();
            
            const q = query(collection(db, "planner_items"), where("giornoIndicativo", "==", dateString));
            
            currentDayUnsubscribePlannerItems = onSnapshot(q, (snapshot) => {
                listEl.innerHTML = '';
                let items = [];
                snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                
                items.sort((a, b) => (a.orarioInizio || '99:99').localeCompare(b.orarioInizio || '99:99'));

                if (items.length === 0) {
                    listEl.innerHTML = '<li class="text-gray-400">Nessun evento o luogo per oggi.</li>';
                } else {
                    items.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'bg-gray-700/30 p-3 rounded-lg text-sm mb-2';
                        li.innerHTML = renderPlannerItem(item, true); // Render con controlli
                        listEl.appendChild(li);
                    });
                }
                lucide.createIcons();
            });
        }
        
        async function loadAndDisplayBackpackItems() {
            const backpackListEl = document.getElementById('backpack-items-list');
            backpackListEl.innerHTML = '<li>Caricamento...</li>';
            const backpackQuery = query(collection(db, "backpacks", currentBackpackUser, "items")); 
            if (backpackUnsubscribe) backpackUnsubscribe();
            backpackUnsubscribe = onSnapshot(backpackQuery, (snapshot) => {
                backpackListEl.innerHTML = '';
                let items = [];
                snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                items.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());
                const filteredItems = currentBackpackFilter === 'Tutti' ? items : items.filter(item => item.type === currentBackpackFilter);
                if (filteredItems.length === 0) {
                    backpackListEl.innerHTML = '<li class="text-gray-400">Nessun oggetto per questa tipologia.</li>';
                } else {
                    filteredItems.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'flex items-center justify-between bg-gray-700/30 p-3 rounded-lg text-sm mb-2 hover-shadow-effect';
                        li.dataset.id = item.id;
                        li.dataset.editing = 'false';
                        li.innerHTML = `
                            <div class="flex items-center flex-grow" id="item-display-${item.id}">
                                <input type="checkbox" data-id="${item.id}" ${item.inBackpack ? 'checked' : ''} class="form-checkbox h-5 w-5 text-green-500 rounded-md border-gray-600 bg-gray-800 cursor-pointer">
                                <div class="ml-3">
                                    <span class="font-semibold text-white">${item.name}</span>
                                    <span class="text-gray-400"> (${item.quantity})</span>
                                    <span class="text-red-300 text-xs block">${item.type}</span>
                                    ${item.cityTag ? `<span class="text-gray-500 text-xs block">Città: ${item.cityTag}</span>` : ''}
                                    ${item.fileUrl ? `<a href="${item.fileUrl}" target="_blank" class="text-blue-400 hover:underline text-xs block mt-1">Allegato <i data-lucide="external-link" class="w-3 h-3 inline-block"></i></a>` : ''}
                                </div>
                            </div>
                            <div id="item-edit-${item.id}" class="hidden flex-grow ml-3"></div>
                            <div class="flex items-center">
                                <button data-id="${item.id}" class="edit-item-btn ml-4 p-2 rounded-full bg-red-600 hover:bg-red-700 text-white"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                <button data-id="${item.id}" class="delete-item-btn ml-2 p-2 rounded-full bg-red-600 hover:bg-red-700 text-white"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        `;
                        backpackListEl.appendChild(li);
                    });
                    backpackListEl.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.addEventListener('change', (e) => toggleBackpackItem(e.target.dataset.id, e.target.checked)));
                    backpackListEl.querySelectorAll('.edit-item-btn').forEach(btn => btn.addEventListener('click', (e) => editBackpackItem(e.currentTarget.dataset.id, items)));
                    backpackListEl.querySelectorAll('.delete-item-btn').forEach(btn => btn.addEventListener('click', (e) => deleteBackpackItem(e.currentTarget.dataset.id)));
                }
                lucide.createIcons();
            });
        }
        async function saveBackpackItem() {
            const nameInput = document.getElementById('backpack-item-name');
            const typeSelect = document.getElementById('backpack-item-type');
            const quantityInput = document.getElementById('backpack-item-quantity');
            const cityTagSelect = document.getElementById('backpack-item-city-tag');
            const fileUrlInput = document.getElementById('backpack-item-file-url');

            const name = nameInput.value.trim();
            const type = typeSelect.value;
            const quantity = parseInt(quantityInput.value, 10);
            const cityTag = cityTagSelect.value;
            const fileUrl = fileUrlInput.value.trim();

            if (name && type && !isNaN(quantity) && quantity > 0) {
                await addDoc(collection(db, "backpacks", currentBackpackUser, "items"), {
                    name: name, type: type, quantity: quantity, cityTag: cityTag, fileUrl: fileUrl, inBackpack: false, createdAt: new Date()
                });
                nameInput.value = '';
                quantityInput.value = '1';
                typeSelect.value = 'Abbigliamento';
                cityTagSelect.value = 'None';
                fileUrlInput.value = '';
            }
        }
        async function toggleBackpackItem(itemId, status) {
            const itemRef = doc(db, "backpacks", currentBackpackUser, "items", itemId);
            await updateDoc(itemRef, { inBackpack: status });
        }
        async function deleteBackpackItem(itemId) {
            if (await showCustomConfirm("Sei sicuro di voler eliminare questo oggetto?")) {
                await deleteDoc(doc(db, "backpacks", currentBackpackUser, "items", itemId));
            }
        }
        function editBackpackItem(itemId, items) {
            const itemToEdit = items.find(item => item.id === itemId);
            if (!itemToEdit) return;

            const listItem = document.querySelector(`li[data-id="${itemId}"]`);
            const displayDiv = listItem.querySelector(`#item-display-${itemId}`);
            const editDiv = listItem.querySelector(`#item-edit-${itemId}`);
            const editButton = listItem.querySelector(`.edit-item-btn`);
            const deleteButton = listItem.querySelector(`.delete-item-btn`);

            if (listItem.dataset.editing === 'true') return;

            listItem.dataset.editing = 'true';
            displayDiv.classList.add('hidden');
            editDiv.classList.remove('hidden');
            editButton.classList.add('hidden');
            deleteButton.classList.add('hidden');

            editDiv.innerHTML = `
                <div class="flex flex-col gap-2 w-full">
                    <input type="text" id="edit-name-${itemId}" class="form-input p-2 rounded-md text-sm" value="${itemToEdit.name}">
                    <select id="edit-type-${itemId}" class="form-select p-2 rounded-md text-sm">
                        ${['Abbigliamento', 'Elettronica', 'Igiene Personale', 'Documenti', 'Farmaci', 'Varie'].map(type => `<option value="${type}" ${itemToEdit.type === type ? 'selected' : ''}>${type}</option>`).join('')}
                    </select>
                    <input type="number" id="edit-quantity-${itemId}" class="form-input p-2 rounded-md text-sm" value="${itemToEdit.quantity}" min="1">
                    <select id="edit-city-tag-${itemId}" class="form-select p-2 rounded-md text-sm"></select>
                    <input type="url" id="edit-file-url-${itemId}" class="form-input p-2 rounded-md text-sm" value="${itemToEdit.fileUrl || ''}" placeholder="Link Allegato (URL)">
                    <div class="flex gap-2 mt-2">
                        <button data-id="${itemId}" class="save-edit-btn flex-1 bg-green-600 hover:bg-green-700 text-white p-2 rounded-md">Salva</button>
                        <button data-id="${itemId}" class="cancel-edit-btn flex-1 bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md">Annulla</button>
                    </div>
                </div>
            `;
            
            const editCityTagSelect = document.getElementById(`edit-city-tag-${itemId}`);
            populateCityTagDropdown(editCityTagSelect); // Pass the element to populate
            editCityTagSelect.value = itemToEdit.cityTag || 'None';

            listItem.querySelector(`.save-edit-btn`).onclick = () => saveEditedBackpackItem(itemId);
            listItem.querySelector(`.cancel-edit-btn`).onclick = () => cancelEditBackpackItem(itemId);
        }
        async function saveEditedBackpackItem(itemId) {
            const newName = document.getElementById(`edit-name-${itemId}`).value.trim();
            const newType = document.getElementById(`edit-type-${itemId}`).value;
            const newQuantity = parseInt(document.getElementById(`edit-quantity-${itemId}`).value, 10);
            const newCityTag = document.getElementById(`edit-city-tag-${itemId}`).value;
            const newFileUrl = document.getElementById(`edit-file-url-${itemId}`).value.trim();

            if (newName && newType && !isNaN(newQuantity) && newQuantity > 0) {
                const itemRef = doc(db, "backpacks", currentBackpackUser, "items", itemId);
                await updateDoc(itemRef, { name: newName, type: newType, quantity: newQuantity, cityTag: newCityTag, fileUrl: newFileUrl });
                cancelEditBackpackItem(itemId);
            }
        }
        function cancelEditBackpackItem(itemId) {
            const listItem = document.querySelector(`li[data-id="${itemId}"]`);
            listItem.dataset.editing = 'false';
            listItem.querySelector(`#item-display-${itemId}`).classList.remove('hidden');
            listItem.querySelector(`#item-edit-${itemId}`).classList.add('hidden');
            listItem.querySelector(`.edit-item-btn`).classList.remove('hidden');
            listItem.querySelector(`.delete-item-btn`).classList.remove('hidden');
            listItem.querySelector(`#item-edit-${itemId}`).innerHTML = '';
        }
        function switchBackpack(user) {
            currentBackpackUser = user;
            document.getElementById('select-pino-backpack-btn').classList.remove('scale-105', 'ring-2', 'ring-blue-400', 'z-10');
            document.getElementById('select-pina-backpack-btn').classList.remove('scale-105', 'ring-2', 'ring-amber-400', 'z-10');
            const selectedButton = document.getElementById(`select-${user}-backpack-btn`);
            if (user === 'pino') { selectedButton.classList.add('scale-105', 'ring-2', 'ring-blue-400', 'z-10'); }
            else { selectedButton.classList.add('scale-105', 'ring-2', 'ring-amber-400', 'z-10'); }
            document.getElementById('current-backpack-name').textContent = user === 'pino' ? 'Zaino di Pino' : 'Zaino di Pina';
            const backpackImageEl = document.getElementById('backpack-image');
            if (backpackImageEl) {
                backpackImageEl.src = user === 'pino' ? 'images/zaino_pino.png' : 'images/zaino_pina.png';
                backpackImageEl.alt = user === 'pino' ? 'Zaino di Pino' : 'Zaino di Pina';
            }
            loadAndDisplayBackpackItems();
            if (!dayDetailView.classList.contains('hidden') && currentActiveDate) {
                const dayData = tripData.find(d => d.date === currentActiveDate);
                if (dayData) renderTodaysBackpackItems(dayData.location.split('/')[0].trim());
            }
        }
        function populateCityTagDropdown(selectElement = document.getElementById('backpack-item-city-tag')) {
            const oldValue = selectElement.value;
            selectElement.innerHTML = '';
            const uniqueCities = new Set();
            tripData.forEach(day => {
                const city = day.location.split('/')[0].trim();
                if (city && city !== "Volo di Ritorno") uniqueCities.add(city);
            });
            selectElement.innerHTML = `
                <option value="None">Nessuna città specifica</option>
                <option value="All">Tutte le città</option>
                ${Array.from(uniqueCities).sort().map(city => `<option value="${city}">${city}</option>`).join('')}
            `;
            selectElement.value = oldValue;
        }
        function filterBackpackItems(type) {
            currentBackpackFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('bg-red-500', 'ring-2', 'ring-red-300'));
            document.getElementById(`filter-${type.toLowerCase().replace(/\s/g, '-')}-btn`).classList.add('bg-red-500', 'ring-2', 'ring-red-300');
            loadAndDisplayBackpackItems();
        }
        async function renderTodaysBackpackItems(currentLocation) {
            const todaysBackpackEl = document.getElementById('todays-backpack-widget');
            todaysBackpackEl.innerHTML = '<div class="text-gray-400">Caricamento...</div>';
            const pinoItems = await getDocs(collection(db, "backpacks", "pino", "items"));
            const pinaItems = await getDocs(collection(db, "backpacks", "pina", "items"));
            let allItems = [];
            pinoItems.forEach(doc => allItems.push({ user: 'pino', ...doc.data() }));
            pinaItems.forEach(doc => allItems.push({ user: 'pina', ...doc.data() }));
            const relevantItems = allItems.filter(item => item.inBackpack && (item.cityTag === currentLocation || item.cityTag === 'All'));
            if (relevantItems.length === 0) {
                todaysBackpackEl.innerHTML = '<div class="text-gray-400">Nessun oggetto utile per oggi.</div>';
            } else {
                todaysBackpackEl.innerHTML = relevantItems.map(item => `
                    <div class="flex items-start gap-3 bg-gray-700/30 p-3 rounded-lg text-sm mb-2">
                        <i data-lucide="check-circle" class="w-5 h-5 text-green-400 mt-1 flex-shrink-0"></i>
                        <div>
                            <div class="font-medium text-white">${item.name}</div>
                            ${item.type ? `<div class="text-red-300 text-xs">${item.type}</div>` : ''}
                            <div class="text-gray-500 text-xs mt-1">Zaino: ${item.user === 'pino' ? 'Pino' : 'Pina'}</div>
                            ${item.fileUrl ? `<a href="${item.fileUrl}" target="_blank" class="text-blue-400 hover:underline text-xs block mt-2">Apri Allegato <i data-lucide="external-link" class="w-3 h-3 inline-block"></i></a>` : ''}
                        </div>
                    </div>`).join('');
            }
            lucide.createIcons();
        }
        
        window.initMap = function() {
            const center = { lat: 35.6895, lng: 139.6917 };
            // Main map
            map = new google.maps.Map(document.getElementById('map'), { center, zoom: 12, mapId: 'DEMO_MAP_ID' });
            loadAndDisplayPlannerItems(currentMapCity);

            // Modal map
            modalMap = new google.maps.Map(document.getElementById('item-modal-map'), { center, zoom: 15, mapId: 'DEMO_MAP_ID_MODAL' });
            modalMarker = new google.maps.Marker({ map: modalMap });
            
            modalMap.addListener('click', (e) => {
                const lat = e.latLng.lat();
                const lng = e.latLng.lng();
                document.getElementById('item-lat').value = lat.toFixed(6);
                document.getElementById('item-lng').value = lng.toFixed(6);
                modalMarker.setPosition(e.latLng);
                modalMarker.setVisible(true);
            });

            // Day Detail Map
            dayDetailMap = new google.maps.Map(document.getElementById('day-detail-map'), { center, zoom: 12, mapId: 'DEMO_MAP_ID_DAY' });
        };
        async function loadGoogleMapsScript() {
            if (googleMapsApiLoaded) return;
            try {
                const response = await fetch('/.netlify/functions/getGoogleMapsApiKey');
                const data = await response.json();
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${data.apiKey}&callback=initMap&libraries=places`;
                script.async = true;
                document.head.appendChild(script);
                googleMapsApiLoaded = true;
            } catch (error) {
                console.error("Errore caricamento API Google Maps:", error);
                showCustomAlert(`Errore caricamento mappa.`);
            }
        }
        function populateMapCityDropdown() {
            const mapCitySelect = document.getElementById('map-city-select');
            const uniqueCities = new Set(tripData.map(day => day.location.split('/')[0].trim()).filter(city => city && city !== "Volo di Ritorno"));
            mapCitySelect.innerHTML = Array.from(uniqueCities).sort().map(city => `<option value="${city}">${city}</option>`).join('');
            mapCitySelect.value = currentMapCity;
        }
        function changeMapCity() {
            currentMapCity = document.getElementById('map-city-select').value;
            const coords = cityCoordinates[currentMapCity] || cityCoordinates.default;
            if (map) { map.setCenter({ lat: coords.latitude, lng: coords.longitude }); map.setZoom(coords.zoom); }
            loadAndDisplayPlannerItems(currentMapCity);
        }
        
        function loadAndDisplayPlannerItems(city) {
            const listEl = document.getElementById('planner-items-list');
            listEl.innerHTML = '<li class="text-gray-400">Caricamento...</li>';
            document.getElementById('current-map-city-display').textContent = city;
            if (plannerItemsUnsubscribe) plannerItemsUnsubscribe();
            
            let q = query(collection(db, "planner_items"), where("city", "==", city));

            if (currentPlannerItemTagFilter !== 'Tutti') {
                q = query(q, where("tag", "==", currentPlannerItemTagFilter));
            }
            if (currentPlannerItemBookedFilter === 'Prenotati') {
                q = query(q, where("prenotato", "==", true));
            } else if (currentPlannerItemBookedFilter === 'Non Prenotati') {
                q = query(q, where("prenotabile", "==", true), where("prenotato", "==", false));
            }
            if (currentPlannerItemDateFilter) {
                q = query(q, where("giornoIndicativo", "==", currentPlannerItemDateFilter));
            }
            
            plannerItemsUnsubscribe = onSnapshot(q, (snapshot) => {
                listEl.innerHTML = '';
                clearMapMarkers();
                let items = [];
                snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                
                if (items.length === 0) {
                    listEl.innerHTML = '<li class="text-gray-400">Nessun elemento con i filtri selezionati.</li>';
                } else {
                    items.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'bg-gray-700/30 p-3 rounded-lg text-sm mb-2';
                        li.dataset.id = item.id;
                        li.innerHTML = renderPlannerItem(item, true); // Render con controlli edit/delete
                        listEl.appendChild(li);
                        if(item.coordinates && item.coordinates.lat && item.coordinates.lng) {
                            addMapMarker(item.coordinates.lat, item.coordinates.lng, item.nome);
                        }
                    });
                }
                lucide.createIcons();
            });
        }

        function renderPlannerItem(item, includeControls = false) {
            const tagColors = {
                'Ristorante': 'bg-orange-500/20 text-orange-300', 'Attrazione': 'bg-blue-500/20 text-blue-300',
                'Trasporto': 'bg-purple-500/20 text-purple-300', 'Alloggio': 'bg-teal-500/20 text-teal-300',
                'Evento': 'bg-pink-500/20 text-pink-300',
            };
            const tagColor = tagColors[item.tag] || 'bg-gray-500/20 text-gray-300';

            let priceHtml = '';
            if (item.prezzo && item.prezzo.valore) {
                const currencySymbols = { 'Yen': '¥', 'Euro': '€', 'Dollaro': '$' };
                priceHtml = `<div class="text-sm mt-1">
                    <span class="font-semibold">${currencySymbols[item.prezzo.valuta] || ''}${item.prezzo.valore}</span>
                    <span class="text-xs text-gray-400">${item.prezzo.indicativo ? ' (indicativo)' : ''}${item.prezzo.perPersona ? ' a persona' : ''}</span>
                </div>`;
            }

            const controlsHtml = includeControls ? `
                <div class="flex flex-col gap-2 flex-shrink-0">
                    <button data-id="${item.id}" class="edit-planner-item-btn p-2 rounded-full bg-red-600/80 hover:bg-red-700 text-white"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                    <button data-id="${item.id}" class="delete-planner-item-btn p-2 rounded-full bg-red-800/80 hover:bg-red-900 text-white"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            ` : '';

            return `
                <div class="flex justify-between items-start gap-3">
                    <div class="flex-grow">
                        <div class="flex items-center gap-2 flex-wrap">
                            <span class="font-semibold text-white">${item.nome}</span>
                            <span class="text-xs px-2 py-1 rounded-full ${tagColor}">${item.tag}</span>
                        </div>
                        ${item.descrizione ? `<p class="text-gray-300 text-sm mt-1">${item.descrizione}</p>` : ''}
                        
                        <div class="text-xs text-gray-400 mt-2 space-y-1">
                            ${item.giornoIndicativo ? `<div><i data-lucide="calendar" class="w-3 h-3 inline-block mr-1"></i> Giorno: ${item.giornoIndicativo}</div>` : ''}
                            ${(item.orarioInizio || item.orarioFine) ? `<div><i data-lucide="clock" class="w-3 h-3 inline-block mr-1"></i> Orario: ${item.orarioInizio || 'N/A'} - ${item.orarioFine || 'N/A'}</div>` : ''}
                        </div>
                        
                        ${item.prenotabile ? `
                            <div class="mt-2 p-2 rounded-md ${item.prenotato ? 'bg-green-500/20' : 'bg-yellow-500/20'}">
                                <div class="font-bold text-sm ${item.prenotato ? 'text-green-300' : 'text-yellow-300'}">${item.prenotato ? 'PRENOTATO' : 'DA PRENOTARE'}</div>
                                ${item.prenotato && (item.dataPrenotazione || item.orarioPrenotazione) ? `
                                    <div class="text-xs text-gray-300 mt-1">
                                        <i data-lucide="calendar-check" class="w-3 h-3 inline-block mr-1"></i>
                                        ${item.dataPrenotazione || ''} ${item.orarioPrenotazione || ''}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        ${priceHtml}

                        <div class="flex flex-wrap gap-x-4 gap-y-2 mt-3 text-xs">
                            ${item.linkMappa ? `<a href="${item.linkMappa}" target="_blank" class="text-blue-400 hover:underline flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i>Vedi su Mappa</a>` : ''}
                            ${item.linkPrenotazione ? `<a href="${item.linkPrenotazione}" target="_blank" class="text-blue-400 hover:underline flex items-center gap-1"><i data-lucide="ticket" class="w-3 h-3"></i>Link Prenotazione</a>` : ''}
                            ${item.linkEsterno ? `<a href="${item.linkEsterno}" target="_blank" class="text-blue-400 hover:underline flex items-center gap-1"><i data-lucide="external-link" class="w-3 h-3"></i>Link Esterno</a>` : ''}
                        </div>

                        ${item.note ? `<div class="mt-2 text-xs text-gray-400 border-l-2 border-gray-600 pl-2 italic">${item.note}</div>` : ''}
                    </div>
                    ${controlsHtml}
                </div>
            `;
        }


        function filterPlannerItemsByTag(tag) { currentPlannerItemTagFilter = tag; loadAndDisplayPlannerItems(currentMapCity); }
        function filterPlannerItemsByBookedStatus(status) { currentPlannerItemBookedFilter = status; loadAndDisplayPlannerItems(currentMapCity); }
        function filterPlannerItemsByDate() { currentPlannerItemDateFilter = document.getElementById('filter-planner-item-date-input').value; loadAndDisplayPlannerItems(currentMapCity); }
        function clearPlannerItemDateFilter() { document.getElementById('filter-planner-item-date-input').value = ''; currentPlannerItemDateFilter = ''; loadAndDisplayPlannerItems(currentMapCity); }
        
        function addMapMarker(lat, lng, title) {
            if (!map || lat === undefined || lng === undefined) return;
            const marker = new google.maps.Marker({ position: { lat, lng }, map, title });
            mapMarkers.push(marker);
        }
        function clearMapMarkers() { mapMarkers.forEach(marker => marker.setMap(null)); mapMarkers = []; }
        
        async function deletePlannerItem(id) {
            if (await showCustomConfirm("Sei sicuro di voler eliminare questo elemento? L'azione è irreversibile.")) {
                await deleteDoc(doc(db, "planner_items", id));
                showCustomAlert("Elemento eliminato.");
            }
        }
        
        async function searchPlacesForItemModal() {
            const query = document.getElementById('item-modal-search-query').value.trim();
            if (!query || !modalMap) return;
            const resultsList = document.getElementById('item-modal-search-results');
            resultsList.innerHTML = '<li class="text-gray-400 p-2">Ricerca...</li>';
            try {
                const response = await fetch('/.netlify/functions/searchPlaces', {
                    method: 'POST',
                    body: JSON.stringify({ query, latitude: modalMap.getCenter().lat(), longitude: modalMap.getCenter().lng() })
                });
                const data = await response.json();
                resultsList.innerHTML = '';
                if (data.results.length === 0) {
                    resultsList.innerHTML = '<li class="text-gray-400 p-2">Nessun risultato.</li>';
                } else {
                    data.results.forEach(place => {
                        const li = document.createElement('li');
                        li.className = 'p-2 hover:bg-gray-600 cursor-pointer rounded-md';
                        li.textContent = place.name;
                        li.onclick = () => {
                            document.getElementById('item-name').value = place.name;
                            const lat = place.geometry.location.lat;
                            const lng = place.geometry.location.lng;
                            document.getElementById('item-lat').value = lat;
                            document.getElementById('item-lng').value = lng;
                            document.getElementById('item-map-link').value = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                            
                            const location = { lat, lng };
                            modalMap.setCenter(location);
                            modalMarker.setPosition(location);
                            modalMarker.setVisible(true);

                            resultsList.innerHTML = ''; 
                        };
                        resultsList.appendChild(li);
                    });
                }
            } catch (error) {
                resultsList.innerHTML = '<li class="text-red-400 p-2">Errore ricerca.</li>';
            }
        }
        
        // ========================================================================
        // LOGICA PER IL MODALE UNIFICATO E RIUTILIZZO ITEMS
        // ========================================================================

        function closeItemModal() {
            itemModal.classList.add('hidden');
            editingItemId = null;
        }

        async function openItemModal(options = {}) {
            const { id = null, city = '', giornoIndicativo = '' } = options;
            editingItemId = id;

            document.getElementById('item-modal-title').textContent = id ? 'Modifica Elemento' : 'Nuovo Elemento';
            document.getElementById('item-form').reset();
            document.getElementById('item-modal-search-results').innerHTML = '';
            document.getElementById('item-city').value = city || currentMapCity;
            document.getElementById('item-indicative-day').value = giornoIndicativo;

            // Centra la mini-mappa sulla città corrente
            const cityKey = city || currentMapCity;
            const coords = cityCoordinates[cityKey] || cityCoordinates.default;
            if (modalMap) {
                modalMap.setCenter({ lat: coords.latitude, lng: coords.longitude });
                modalMarker.setVisible(false);
            }

            if (id) {
                const itemDoc = await getDoc(doc(db, "planner_items", id));
                if (itemDoc.exists()) {
                    const data = itemDoc.data();
                    document.getElementById('item-name').value = data.nome || '';
                    document.getElementById('item-description').value = data.descrizione || '';
                    document.getElementById('item-tag').value = data.tag || 'Attrazione';
                    document.getElementById('item-indicative-day').value = data.giornoIndicativo || '';
                    document.getElementById('item-start-time').value = data.orarioInizio || '';
                    document.getElementById('item-end-time').value = data.orarioFine || '';
                    document.getElementById('item-bookable').checked = data.prenotabile || false;
                    document.getElementById('item-booked').checked = data.prenotato || false;
                    document.getElementById('item-booking-date').value = data.dataPrenotazione || '';
                    document.getElementById('item-booking-time').value = data.orarioPrenotazione || '';
                    document.getElementById('item-booking-link').value = data.linkPrenotazione || '';
                    document.getElementById('item-external-link').value = data.linkEsterno || '';
                    document.getElementById('item-map-link').value = data.linkMappa || '';
                    if (data.coordinates && data.coordinates.lat) {
                        const location = { lat: data.coordinates.lat, lng: data.coordinates.lng };
                        document.getElementById('item-lat').value = location.lat;
                        document.getElementById('item-lng').value = location.lng;
                        if(modalMap) {
                            modalMap.setCenter(location);
                            modalMarker.setPosition(location);
                            modalMarker.setVisible(true);
                        }
                    }
                    if(data.prezzo) {
                        document.getElementById('item-price').value = data.prezzo.valore || '';
                        document.getElementById('item-price-currency').value = data.prezzo.valuta || 'Yen';
                        document.getElementById('item-price-indicative').checked = data.prezzo.indicativo || false;
                        document.getElementById('item-price-per-person').checked = data.prezzo.perPersona || false;
                    }
                    document.getElementById('item-notes').value = data.note || '';
                    document.getElementById('item-city').value = data.city || currentMapCity;
                }
            }
            
            toggleBookingFields();
            itemModal.classList.remove('hidden');
            // FIX: Trigger resize per la mappa del modale
            setTimeout(() => {
                if(google && modalMap) {
                    google.maps.event.trigger(modalMap, 'resize');
                    const cityKey = city || currentMapCity;
                    const coords = cityCoordinates[cityKey] || cityCoordinates.default;
                    modalMap.setCenter({ lat: coords.latitude, lng: coords.longitude });
                }
            }, 10);
        }

        async function saveItem() {
            const nome = document.getElementById('item-name').value.trim();
            if (!nome) {
                showCustomAlert("Il campo 'Nome' è obbligatorio.");
                return;
            }

            const latVal = document.getElementById('item-lat').value;
            const lngVal = document.getElementById('item-lng').value;

            const itemData = {
                nome: nome,
                descrizione: document.getElementById('item-description').value.trim(),
                tag: document.getElementById('item-tag').value,
                giornoIndicativo: document.getElementById('item-indicative-day').value || null,
                orarioInizio: document.getElementById('item-start-time').value,
                orarioFine: document.getElementById('item-end-time').value,
                prenotabile: document.getElementById('item-bookable').checked,
                prenotato: document.getElementById('item-booked').checked,
                dataPrenotazione: document.getElementById('item-booking-date').value,
                orarioPrenotazione: document.getElementById('item-booking-time').value,
                linkPrenotazione: document.getElementById('item-booking-link').value.trim(),
                linkEsterno: document.getElementById('item-external-link').value.trim(),
                linkMappa: document.getElementById('item-map-link').value.trim(),
                coordinates: {
                    lat: latVal ? parseFloat(latVal) : null,
                    lng: lngVal ? parseFloat(lngVal) : null,
                },
                prezzo: {
                    valore: parseFloat(document.getElementById('item-price').value) || null,
                    valuta: document.getElementById('item-price-currency').value,
                    indicativo: document.getElementById('item-price-indicative').checked,
                    perPersona: document.getElementById('item-price-per-person').checked,
                },
                note: document.getElementById('item-notes').value.trim(),
                city: document.getElementById('item-city').value,
            };

            if(itemData.prenotabile && itemData.prenotato) {
                if(!itemData.dataPrenotazione) {
                    showCustomAlert("Il campo 'Data Prenotazione' è obbligatorio quando l'elemento è prenotato.");
                    return;
                }
            }

            try {
                if (editingItemId) {
                    const itemRef = doc(db, "planner_items", editingItemId);
                    await updateDoc(itemRef, itemData);
                    showCustomAlert("Elemento aggiornato con successo!");
                } else {
                    itemData.createdAt = new Date();
                    await addDoc(collection(db, "planner_items"), itemData);
                    showCustomAlert("Elemento creato con successo!");
                }
                closeItemModal();
            } catch (error) {
                console.error("Errore salvataggio elemento:", error);
                showCustomAlert("Si è verificato un errore durante il salvataggio.");
            }
        }

        function toggleBookingFields() {
            const isBookable = document.getElementById('item-bookable').checked;
            const isBooked = document.getElementById('item-booked').checked;
            const bookedFields = document.getElementById('item-booked-fields');
            const bookingDetails = document.getElementById('item-booking-details');

            bookedFields.style.display = isBookable ? 'block' : 'none';
            bookingDetails.style.display = isBookable && isBooked ? 'grid' : 'none';
        }
        
        function loadAndDisplayUnassignedItemsForDay(city) {
            const listEl = document.getElementById('unassigned-items-list-day');
            listEl.innerHTML = `<li>Caricamento...</li>`;
            
            if (dayDetailMap) {
                const coords = cityCoordinates[city] || cityCoordinates.default;
                dayDetailMap.setCenter({ lat: coords.latitude, lng: coords.longitude });
                dayDetailMapMarkers.forEach(m => m.setMap(null));
                dayDetailMapMarkers = [];
            }

            document.querySelectorAll('.unassigned-filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'ring-2', 'ring-blue-300');
                if (btn.dataset.filter === currentUnassignedFilter) {
                    btn.classList.add('bg-blue-500', 'ring-2', 'ring-blue-300');
                }
            });

            let tagsToQuery = ['Ristorante', 'Attrazione'];
            if (currentUnassignedFilter !== 'Tutti') {
                tagsToQuery = [currentUnassignedFilter];
            }

            const q = query(
                collection(db, "planner_items"), 
                where("city", "==", city), 
                where("giornoIndicativo", "==", null),
                where("tag", "in", tagsToQuery)
            );
            
            if (currentDayUnsubscribeUnassignedItems) currentDayUnsubscribeUnassignedItems();
            currentDayUnsubscribeUnassignedItems = onSnapshot(q, (snapshot) => {
                listEl.innerHTML = '';
                dayDetailMapMarkers.forEach(m => m.setMap(null));
                dayDetailMapMarkers = [];

                if (snapshot.empty) {
                    listEl.innerHTML = `<li class="text-gray-400 text-center p-2">Nessun luogo da esplorare.</li>`;
                    return;
                }

                snapshot.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    const li = document.createElement('li');
                    li.className = 'p-2 bg-gray-700/50 rounded-md cursor-pointer hover:bg-gray-600/50';
                    li.dataset.id = item.id;
                    li.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-white text-sm">${item.nome}</p>
                                <p class="text-xs text-gray-400">${item.tag}</p>
                            </div>
                            <button data-id="${item.id}" class="edit-planner-item-btn bg-green-600 hover:bg-green-700 text-white text-xs py-1 px-2 rounded-md">Modifica/Assegna</button>
                        </div>
                    `;
                    listEl.appendChild(li);

                    if (item.coordinates && item.coordinates.lat && dayDetailMap) {
                        const marker = new google.maps.Marker({
                            position: item.coordinates,
                            map: dayDetailMap,
                            title: item.nome,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 8,
                                fillColor: item.tag === 'Ristorante' ? '#F97316' : '#3B82F6',
                                fillOpacity: 0.9,
                                strokeColor: 'white',
                                strokeWeight: 2,
                            }
                        });
                        marker.set('id', item.id);
                        dayDetailMapMarkers.push(marker);

                        li.addEventListener('mouseenter', () => {
                            marker.setIcon({...marker.getIcon(), scale: 12});
                        });
                        li.addEventListener('mouseleave', () => {
                            marker.setIcon({...marker.getIcon(), scale: 8});
                        });
                    }
                });
            });
        }


        function populateChatDateDropdown() {
            const select = document.getElementById('chat-date-select');
            select.innerHTML = tripData.map(day => `<option value="${day.date}">${new Date(day.date).toLocaleDateString('it-IT', { weekday: 'short', day: '2-digit', month: '2-digit' })}</option>`).join('');
        }
        
        function loadAndDisplayChatMessages(dateString) {
            const el = document.getElementById('chat-messages');
            el.innerHTML = '<div class="text-gray-400 text-center">Caricamento...</div>';
            if (chatUnsubscribe) chatUnsubscribe();
            const q = query(collection(db, "trip-notes"), where("date", "==", dateString));
            chatUnsubscribe = onSnapshot(q, (snapshot) => {
                el.innerHTML = '';
                let messages = [];
                snapshot.forEach(doc => messages.push(doc.data()));
                messages.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());
                if (messages.length === 0) {
                    el.innerHTML = '<div class="text-center p-4">Nessun messaggio per oggi.</div>';
                } else {
                    messages.forEach(msg => {
                        const div = document.createElement('div');
                        const time = msg.createdAt.toDate().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                        
                        if (msg.source === 'translation' && msg.original && msg.translation) {
                            div.className = `flex flex-col mb-2 items-end`;
                            div.innerHTML = `
                                <div class="chat-bubble chat-message-grouped-translation">
                                    <p class="text-sm font-semibold">${msg.original}</p>
                                    <hr class="border-gray-400/50 my-2">
                                    <p class="text-sm">${msg.translation}</p>
                                    <span class="text-xs opacity-70 block mt-2 text-right">Traduzione - ${time}</span>
                                </div>`;
                        } else {
                            div.className = `flex flex-col mb-2 items-start`;
                            div.innerHTML = `
                                <div class="chat-bubble chat-message-manual">
                                    <p class="text-sm">${msg.text}</p>
                                    <span class="text-xs opacity-70 block mt-1">Appunto - ${time}</span>
                                </div>`;
                        }
                        el.appendChild(div);
                    });
                    el.scrollTop = el.scrollHeight;
                }
            });
        }
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const date = document.getElementById('chat-date-select').value;
            if (input.value.trim() && date) {
                await addDoc(collection(db, "trip-notes"), { date, text: input.value.trim(), source: 'manual', createdAt: new Date() });
                input.value = '';
                input.dispatchEvent(new Event('input')); 
            }
        }

        async function translateAndAddChat() {
            const input = document.getElementById('translate-input-chat');
            const output = document.getElementById('translate-output-chat');
            const date = document.getElementById('chat-date-select').value;
            const originalText = input.value.trim();
            if (!originalText || !date) return;

            output.value = "Traduzione...";
            const isJapanese = /[一-龠ぁ-ゔァ-ヴー]/.test(originalText);
            const prompt = `Traduci in ${isJapanese ? "Italiano" : "Giapponese"}: "${originalText}", rispondi esclusivamente con la traduzione, senza aggiungere altro testo.`;
            try {
                const response = await fetch('/.netlify/functions/translate', { method: 'POST', body: JSON.stringify({ prompt }) });
                const result = await response.json();
                if (result.translation) {
                    output.value = result.translation;
                    await addDoc(collection(db, "trip-notes"), { 
                        date, 
                        original: originalText,
                        translation: result.translation,
                        source: 'translation', 
                        createdAt: new Date() 
                    });
                    input.value = '';
                    output.value = '';
                    input.dispatchEvent(new Event('input')); 
                }
            } catch (error) {
                output.value = `Errore di traduzione.`;
            }
        }
        function toggleKeyboardLanguageChat() {
            const input = document.getElementById('translate-input-chat');
            const btn = document.getElementById('toggle-keyboard-chat-btn');
            input.lang = input.lang === 'ja' ? 'it' : 'ja';
            input.placeholder = input.lang === 'ja' ? 'Scrivi in Giapponese...' : 'Scrivi in Italiano...';
            btn.innerHTML = `<i data-lucide="keyboard" class="w-4 h-4"></i><span class="hidden sm:inline">Tastiera: ${input.lang === 'ja' ? 'Giapponese' : 'Italiano'}</span>`;
            lucide.createIcons();
        }
        function clearTranslationBoxesChat() { 
            const input = document.getElementById('translate-input-chat');
            const output = document.getElementById('translate-output-chat');
            input.value = '';
            output.value = '';
            input.dispatchEvent(new Event('input'));
        }

        function showCustomAlert(message) {
            const modal = document.getElementById('custom-alert-modal');
            document.getElementById('custom-alert-message').textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('custom-alert-close-btn').onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); };
        }
        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-confirm-modal');
                document.getElementById('custom-confirm-message').textContent = message;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                const cleanup = (result) => { modal.classList.add('hidden'); modal.classList.remove('flex'); resolve(result); };
                document.getElementById('custom-confirm-yes-btn').onclick = () => cleanup(true);
                document.getElementById('custom-confirm-no-btn').onclick = () => cleanup(false);
            });
        }
        function setupCollapsibleBoxesDelegation() {
            appContainer.addEventListener('click', (event) => {
                const header = event.target.closest('.collapsible-header');
                if (header) {
                    const content = document.getElementById(header.dataset.target);
                    const icon = header.querySelector('.toggle-icon');
                    if (content && icon) {
                        const isCollapsed = content.classList.contains('collapsed');
                        content.classList.toggle('collapsed');
                        icon.setAttribute('data-lucide', isCollapsed ? 'chevron-up' : 'chevron-down');
                        lucide.createIcons();
                        
                        // FIX: Trigger resize per la mappa del dettaglio giorno quando viene aperta
                        if (isCollapsed && content.id === 'unassigned-items-content') {
                            setTimeout(() => {
                                if(google && dayDetailMap) {
                                    google.maps.event.trigger(dayDetailMap, 'resize');
                                }
                            }, 10); // Small delay to allow container to get dimensions
                        }
                    }
                }
            });
        }
        async function importItineraryFromJson(data) {
            const batch = writeBatch(db);
            data.forEach(day => batch.set(doc(db, "itinerary", day.date), day, { merge: true }));
            await batch.commit();
        }
        
        // ========================================================================
        // FUNZIONE DI MIGRAZIONE DATI
        // ========================================================================
        async function migrateOldData() {
            if (!await showCustomConfirm("Sei sicuro di voler avviare la migrazione dei dati? Questa operazione è da eseguire una sola volta e sposterà i vecchi 'eventi' e 'luoghi pinnati' nella nuova struttura dati. L'operazione non è reversibile.")) {
                return;
            }

            const migrationStatusRef = doc(db, "_meta", "migrationStatus");
            const migrationStatusDoc = await getDoc(migrationStatusRef);

            if (migrationStatusDoc.exists() && migrationStatusDoc.data().completed) {
                showCustomAlert("La migrazione è già stata completata in precedenza.");
                return;
            }

            showCustomAlert("Avvio migrazione... L'operazione potrebbe richiedere qualche istante. Riceverai un messaggio al termine.");

            const batch = writeBatch(db);
            let itemsMigrated = 0;

            try {
                // 1. Migrazione da 'pinned-places'
                const pinnedPlacesSnapshot = await getDocs(collection(db, "pinned-places"));
                pinnedPlacesSnapshot.forEach(placeDoc => { // <-- CORREZIONE: rinominato 'doc' in 'placeDoc'
                    const oldPlace = placeDoc.data();
                    const newItem = {
                        nome: oldPlace.name || 'Senza nome',
                        descrizione: '',
                        tag: oldPlace.tag || 'Attrazione',
                        giornoIndicativo: oldPlace.reservationDate || null,
                        orarioInizio: oldPlace.isBooked ? oldPlace.reservationTime : null,
                        orarioFine: null,
                        prenotabile: typeof oldPlace.isBooked !== 'undefined',
                        prenotato: oldPlace.isBooked || false,
                        dataPrenotazione: oldPlace.isBooked ? oldPlace.reservationDate : null,
                        orarioPrenotazione: oldPlace.isBooked ? oldPlace.reservationTime : null,
                        linkPrenotazione: oldPlace.bookingFileLink || '',
                        linkEsterno: '',
                        linkMappa: oldPlace.mapUrl || '',
                        coordinates: {
                            lat: oldPlace.latitude || null,
                            lng: oldPlace.longitude || null,
                        },
                        prezzo: { valore: null, valuta: 'Yen', indicativo: false, perPersona: false },
                        note: oldPlace.notes || '',
                        city: oldPlace.city || 'Sconosciuta',
                        createdAt: oldPlace.createdAt || new Date(),
                    };
                    const newPlannerItemRef = doc(collection(db, "planner_items"));
                    batch.set(newPlannerItemRef, newItem);
                    itemsMigrated++;
                });

                // 2. Migrazione da 'itinerary.events'
                const itinerarySnapshot = await getDocs(collection(db, "itinerary"));
                itinerarySnapshot.forEach(dayDoc => {
                    const dayData = dayDoc.data();
                    if (dayData.events && Array.isArray(dayData.events)) {
                        dayData.events.forEach(oldEvent => {
                            const newItem = {
                                nome: oldEvent.name || 'Senza nome',
                                descrizione: oldEvent.details || '',
                                tag: 'Evento',
                                giornoIndicativo: dayDoc.id,
                                orarioInizio: oldEvent.start || null,
                                orarioFine: oldEvent.end || null,
                                prenotabile: false,
                                prenotato: false,
                                dataPrenotazione: null,
                                orarioPrenotazione: null,
                                linkPrenotazione: '',
                                linkEsterno: oldEvent.link || '',
                                linkMappa: '',
                                coordinates: { lat: null, lng: null },
                                prezzo: { 
                                    valore: oldEvent.price ? parseFloat(oldEvent.price) : null, 
                                    valuta: 'Yen', indicativo: true, perPersona: false 
                                },
                                note: '',
                                city: dayData.location.split('/')[0].trim(),
                                createdAt: new Date(),
                            };
                            const newPlannerItemRef = doc(collection(db, "planner_items"));
                            batch.set(newPlannerItemRef, newItem);
                            itemsMigrated++;
                        });
                    }
                });

                // Commit del batch e aggiornamento dello stato
                batch.set(migrationStatusRef, { completed: true, completedAt: new Date() });
                await batch.commit();

                showCustomAlert(`Migrazione completata con successo! ${itemsMigrated} elementi sono stati migrati. Ora puoi rimuovere la vecchia collection 'pinned-places' e il campo 'events' dai documenti dell'itinerario da Firebase Console.`);

            } catch (error) {
                console.error("Errore durante la migrazione:", error);
                showCustomAlert(`Errore durante la migrazione: ${error.message}`);
            }
        }

    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f8f8f8; padding-top: 64px; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #ef4444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #dc2626; }
        .form-input, .form-select { background-color: #374151; border-color: #4b5563; color: #f8f8f8; border-radius: 0.375rem; padding: 0.5rem 0.75rem; border-width: 1px; }
        .form-input:focus, .form-select:focus { --tw-ring-color: #ef4444; border-color: #ef4444; outline: none; box-shadow: 0 0 0 2px var(--tw-ring-color); }
        .form-checkbox { background-color: #374151; border-color: #4b5563;}
        .form-checkbox:checked { background-color: #ef4444; }
        .view-transition { transition: opacity 0.3s ease-in-out; }
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .slide-left-out { animation: slideLeftOut 0.3s ease-out forwards; }
        .slide-right-in { animation: slideRightIn 0.3s ease-out forwards; }
        .slide-right-out { animation: slideRightOut 0.3s ease-out forwards; }
        .slide-left-in { animation: slideLeftIn 0.3s ease-out forwards; }
        @keyframes slideLeftOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(-100%); } }
        @keyframes slideRightIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideRightOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
        @keyframes slideLeftIn { from { opacity: 0; transform: translateX(-100%); } to { opacity: 1; transform: translateX(0); } }
        #map, #item-modal-map, #day-detail-map { height: 400px; width: 100%; border-radius: 0.5rem; background-color: #4b5563; }
        #item-modal-map { height: 200px; }
        #day-detail-map { height: 250px; }
        .collapsible-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .collapsible-content { max-height: 1000px; overflow: hidden; transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out, padding 0.4s ease-in-out, margin 0.4s ease-in-out; opacity: 1; }
        .collapsible-content.collapsed { max-height: 0; opacity: 0; padding-top: 0 !important; padding-bottom: 0 !important; margin-top: 0 !important; margin-bottom: 0 !important; }
        
        #chat-messages.paper-style {
            background-color: #efe1c4; color: #3a3a3a; border: 1px solid #e0d9c6; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-family: 'Lora', serif;
            overflow-y: auto; display: flex; flex-direction: column; padding: 1rem; border-radius: 0.5rem;
        }
        .chat-bubble { padding: 0.75rem; border-radius: 1rem; max-width: 80%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; }
        .chat-message-manual { background-color: #e3cba9; color: #000000; border-bottom-left-radius: 0.25rem; }
        .chat-message-grouped-translation { background-color: #afd19e; color: #3a3a3a; border-bottom-right-radius: 0.25rem; }
        .chat-bubble::after { content: ''; position: absolute; bottom: 0; height: 20px; width: 20px; }
        .items-start .chat-bubble::after { left: -10px; background-color: inherit; clip-path: polygon(100% 100%, 0 0, 100% 0); }
        .items-end .chat-bubble::after { right: -10px; background-color: inherit; clip-path: polygon(0 0, 100% 0, 0 100%); }
    </style>
</head>
<body class="text-gray-300">

    <div id="login-container" class="min-h-screen flex items-center justify-center bg-gray-900">
        <div class="w-full max-w-sm">
            <div class="bg-gray-800 shadow-2xl rounded-lg p-8 border border-gray-700">
                <h2 class="text-2xl font-bold text-center mb-6 text-white">Viaggio in Giappone 2024</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="email" class="block text-gray-400 text-sm font-bold mb-2">Email</label>
                        <input type="email" id="email" name="email" class="form-input shadow w-full py-2 px-3 leading-tight" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-400 text-sm font-bold mb-2">Password</label>
                        <input type="password" id="password" name="password" class="form-input shadow w-full py-2 px-3 mb-3 leading-tight" required>
                    </div>
                    <div id="login-error" class="text-red-400 text-xs italic mb-4 h-4"></div>
                    <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200">Accedi</button>
                </form>
            </div>
        </div>
    </div>

    <div id="app-container" class="w-full h-full bg-gray-900 hidden">
        <!-- Barra di Navigazione Fissa -->
        <nav class="fixed top-0 left-0 right-0 bg-gray-800 p-4 border-b border-gray-700 z-50 flex justify-between items-center shadow-lg">
            <div class="flex items-center gap-2 sm:gap-4">
                <button id="nav-itinerary-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 sm:px-4 rounded-lg transition-colors flex items-center gap-2"><i data-lucide="list-checks" class="w-5 h-5"></i><span class="hidden sm:inline">Itinerario</span></button>
                <button id="nav-backpack-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 sm:px-4 rounded-lg transition-colors flex items-center gap-2"><i data-lucide="backpack" class="w-5 h-5"></i><span class="hidden sm:inline">Zaino</span></button>
                <button id="nav-map-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 sm:px-4 rounded-lg transition-colors flex items-center gap-2"><i data-lucide="map" class="w-5 h-5"></i><span class="hidden sm:inline">Mappa</span></button>
                <button id="nav-chat-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 sm:px-4 rounded-lg transition-colors flex items-center gap-2"><i data-lucide="messages-square" class="w-5 h-5"></i><span class="hidden sm:inline">Diario</span></button>
            </div>
            <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 sm:px-4 rounded-lg transition-colors flex items-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i><span class="hidden sm:inline">Logout</span></button>
        </nav>

        <!-- Home View -->
        <div id="home-view" class="view-transition opacity-0">
            <header class="p-4 sm:p-6 text-center"><h1 class="text-2xl sm:text-3xl font-bold text-white">Itinerario di Viaggio</h1><p class="text-gray-400">Giappone 2024</p></header>
            <main class="p-4 sm:p-6">
                <img id="home-title-image" src="" alt="Paesaggio Giapponese" class="w-full max-w-3xl mx-auto aspect-video object-cover rounded-lg mb-6 shadow-md">
                <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700 p-4">
                    <div class="hidden sm:grid grid-cols-3 gap-4 font-bold text-white mb-2 px-4">
                        <div>Data</div>
                        <div>Luogo</div>
                        <div>Alloggio</div>
                    </div>
                    <div id="itinerary-list-container" class="space-y-2"></div>
                </div>
                <div class="mt-6 bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up">
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white"><i data-lucide="settings-2" class="w-5 h-5 text-red-400"></i>Impostazioni Avanzate</h3>
                    <div class="space-y-3">
                         <div>
                            <p class="text-gray-400 text-sm mb-2">Aggiorna l'itinerario caricando un file JSON.</p>
                            <button id="import-json-btn" class="w-full bg-red-600 hover:bg-red-700 text-white p-2 rounded-md">Importa Itinerario da JSON</button>
                            <input type="file" id="import-json-input" accept=".json" class="hidden">
                        </div>
                        <div>
                            <p class="text-gray-400 text-sm mb-2">Esegui la migrazione una tantum dei vecchi dati (eventi e luoghi pinnati) alla nuova struttura dati.</p>
                            <button id="migrate-data-btn" class="w-full bg-amber-600 hover:bg-amber-700 text-white p-2 rounded-md">Avvia Migrazione Dati</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Day Detail View -->
        <div id="day-detail-view" class="view-transition opacity-0 hidden">
            <header class="p-4 sm:p-6 border-b border-gray-700 flex justify-center items-center relative">
                <button id="prev-day-btn" class="absolute left-4 p-2 rounded-full text-white hover:bg-gray-700/30"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                <div class="flex-grow text-center mx-10"><h2 id="location" class="text-3xl font-bold text-white"></h2><p id="date" class="text-red-600"></p><div class="flex flex-col sm:flex-row gap-2 sm:gap-4 justify-center items-center mt-2"><div><div id="local-time" class="text-2xl font-semibold text-white"></div><p class="text-sm text-gray-400">Ora Giappone</p></div><div><div id="italian-local-time" class="text-2xl font-semibold text-white"></div><p class="text-sm text-gray-400">Ora Italia</p></div></div></div>
                <button id="next-day-btn" class="absolute right-4 p-2 rounded-full text-white hover:bg-gray-700/30"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
            </header>
            <main id="day-detail-main" class="p-4 sm:p-6">
                <img id="day-detail-title-image" src="" alt="Immagine del luogo" class="w-full max-w-3xl mx-auto aspect-video object-cover rounded-lg mb-6 shadow-md">
                <div id="day-content-wrapper">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up"><div class="collapsible-header" data-target="weather-content"><h3 class="font-semibold text-lg flex items-center gap-2 text-white flex-grow"><i data-lucide="cloud-sun" class="w-5 h-5 text-red-400"></i>Meteo</h3><i data-lucide="chevron-up" class="w-5 h-5 text-gray-400 toggle-icon"></i></div><div id="weather-content" class="collapsible-content pt-4"><div id="weather-widget"></div><button id="current-location-weather-btn" class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-md flex items-center justify-center gap-2 text-sm"><i data-lucide="map-pin" class="w-4 h-4"></i><span class="hidden sm:inline">Posizione Attuale</span></button></div></div>
                        <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up"><div class="collapsible-header" data-target="accommodation-content"><h3 class="font-semibold text-lg flex items-center gap-2 text-white flex-grow"><i data-lucide="bed-double" class="w-5 h-5 text-red-400"></i>Alloggio</h3><i data-lucide="chevron-up" class="w-5 h-5 text-gray-400 toggle-icon"></i></div><div id="accommodation-content" class="collapsible-content pt-4"><div id="accommodation-widget"></div></div></div>
                        
                        <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 lg:col-span-2 fade-in-up">
                            <div class="collapsible-header" data-target="travel-content"><h3 class="font-semibold text-lg flex items-center gap-2 text-white flex-grow"><i data-lucide="map" class="w-5 h-5 text-red-400"></i>Spostamenti</h3><i data-lucide="chevron-up" class="w-5 h-5 text-gray-400 toggle-icon"></i></div>
                            <div id="travel-content" class="collapsible-content pt-4">
                                <div id="travel-list" class="space-y-4 max-h-96 overflow-y-auto pr-2 mb-4"></div>
                                <div id="travel-form-container"></div>
                                <div id="travel-actions" class="flex gap-2 mt-4">
                                    <button class="add-travel-btn flex-1 bg-red-600 hover:bg-red-700 text-white p-2 rounded-md transition-colors duration-200 flex items-center justify-center gap-2 text-sm"><i data-lucide="plus-circle" class="w-4 h-4"></i> Aggiungi Spostamento</button>
                                </div>
                            </div>
                        </div>

                         <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 lg:col-span-2 fade-in-up">
                            <div class="collapsible-header" data-target="planner-items-content"><h3 class="font-semibold text-lg flex items-center gap-2 text-white flex-grow"><i data-lucide="calendar-check" class="w-5 h-5 text-green-400"></i>Eventi e Luoghi di Oggi</h3><i data-lucide="chevron-up" class="w-5 h-5 text-gray-400 toggle-icon"></i></div>
                            <div id="planner-items-content" class="collapsible-content pt-4">
                                <div id="day-planner-items-list" class="space-y-2 max-h-96 overflow-y-auto pr-2 mb-4"></div>
                                <div id="planner-item-actions" class="flex flex-col sm:flex-row gap-2 mt-4">
                                    <button class="add-planner-item-btn flex-1 bg-green-600 hover:bg-green-700 text-white p-2 rounded-md transition-colors duration-200 flex items-center justify-center gap-2 text-sm"><i data-lucide="plus-circle" class="w-4 h-4"></i> Crea Nuovo</button>
                                </div>
                            </div>
                        </div>

                        <!-- NUOVO BOX: Luoghi da Esplorare -->
                        <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 lg:col-span-2 fade-in-up">
                            <div class="collapsible-header" data-target="unassigned-items-content"><h3 class="font-semibold text-lg flex items-center gap-2 text-white flex-grow"><i data-lucide="compass" class="w-5 h-5 text-blue-400"></i>Luoghi da Esplorare in Zona</h3><i data-lucide="chevron-up" class="w-5 h-5 text-gray-400 toggle-icon"></i></div>
                            <div id="unassigned-items-content" class="collapsible-content pt-4">
                                <div class="flex flex-col md:flex-row gap-4">
                                    <div class="md:w-1/2 lg:w-2/3">
                                        <div id="day-detail-map"></div>
                                    </div>
                                    <div class="md:w-1/2 lg:w-1/3">
                                        <div class="flex gap-2 mb-3">
                                            <button data-filter="Tutti" class="unassigned-filter-btn flex-1 bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-xs">Tutti</button>
                                            <button data-filter="Ristorante" class="unassigned-filter-btn flex-1 bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-xs">Ristoranti</button>
                                            <button data-filter="Attrazione" class="unassigned-filter-btn flex-1 bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-xs">Attrazioni</button>
                                        </div>
                                        <ul id="unassigned-items-list-day" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up"><div class="collapsible-header" data-target="todays-backpack-content"><h3 class="font-semibold text-lg flex items-center gap-2 text-white flex-grow"><i data-lucide="backpack" class="w-5 h-5 text-red-400"></i>Zaino di Oggi</h3><i data-lucide="chevron-up" class="w-5 h-5 text-gray-400 toggle-icon"></i></div><div id="todays-backpack-content" class="collapsible-content pt-4"><div id="todays-backpack-widget" class="space-y-2"></div></div></div>
                        <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up"><div class="collapsible-header" data-target="expenses-content"><h3 class="font-semibold text-lg flex items-center gap-2 text-white flex-grow"><i data-lucide="wallet" class="w-5 h-5 text-red-400"></i>Spese del Giorno</h3><i data-lucide="chevron-up" class="w-5 h-5 text-gray-400 toggle-icon"></i></div><div id="expenses-content" class="collapsible-content pt-4"><ul id="expenses-list" class="space-y-2 mb-3 max-h-48 overflow-y-auto pr-2"></ul><div class="border-t border-gray-700 pt-3 mt-3 flex justify-between font-bold text-white"><span>Totale Giorno:</span><span id="total-expenses">0 ¥</span></div><div class="mt-4 flex gap-2"><input type="text" id="expense-description" placeholder="Descrizione" class="form-input w-2/3 p-2 text-sm"><input type="number" id="expense-amount" placeholder="Yen" class="form-input w-1/3 p-2 text-sm"></div><button id="save-expense-btn" class="mt-3 w-full bg-green-600 hover:bg-green-700 text-white p-2 rounded-md">Aggiungi Spesa</button></div></div>
                        <div class="lg:col-span-2 text-center mt-6 fade-in-up"><button id="go-to-chat-btn" class="w-full bg-red-600 hover:bg-red-700 text-white p-3 rounded-md flex items-center justify-center gap-2 text-lg"><i data-lucide="messages-square" class="w-6 h-6"></i>Vai al Diario di Oggi</button></div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Backpack View -->
        <div id="backpack-view" class="view-transition opacity-0 hidden">
            <header class="p-4 sm:p-6 text-center">
                <h1 class="text-2xl sm:text-3xl font-bold text-white">Il Mio Zaino</h1>
                <p class="text-gray-400">Gestisci gli oggetti per il viaggio</p>
            </header>
            <main class="p-4 sm:p-6">
                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up">
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white">
                        <i data-lucide="users" class="w-5 h-5 text-red-400"></i>Seleziona Zaino: <span id="current-backpack-name" class="ml-2"></span>
                    </h3>
                    <div class="flex flex-col items-center gap-4 mb-4">
                        <img id="backpack-image" src="" alt="Immagine Zaino" class="w-12 h-12 object-contain rounded-md shadow-md">
                        <div class="flex gap-4 w-full">
                            <button id="select-pino-backpack-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-md transition-all duration-300 transform">Zaino di Pino</button>
                            <button id="select-pina-backpack-btn" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white p-2 rounded-md transition-all duration-300 transform">Zaino di Pina</button>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 mt-6 fade-in-up">
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white"><i data-lucide="package" class="w-5 h-5 text-red-400"></i>Aggiungi Nuovo Oggetto</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div><label for="backpack-item-name" class="block text-sm font-medium text-gray-400 mb-1">Nome</label><input type="text" id="backpack-item-name" class="form-input w-full p-2 text-sm" placeholder="Es. Adattatore"></div>
                        <div><label for="backpack-item-type" class="block text-sm font-medium text-gray-400 mb-1">Tipologia</label><select id="backpack-item-type" class="form-select w-full p-2 text-sm"><option>Abbigliamento</option><option>Elettronica</option><option>Igiene Personale</option><option>Documenti</option><option>Farmaci</option><option>Varie</option></select></div>
                        <div><label for="backpack-item-quantity" class="block text-sm font-medium text-gray-400 mb-1">Quantità</label><input type="number" id="backpack-item-quantity" class="form-input w-full p-2 text-sm" value="1" min="1"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><label for="backpack-item-city-tag" class="block text-sm font-medium text-gray-400 mb-1">Città</label><select id="backpack-item-city-tag" class="form-select w-full p-2 text-sm"></select></div>
                        <div><label for="backpack-item-file-url" class="block text-sm font-medium text-gray-400 mb-1">Link Allegato</label><input type="url" id="backpack-item-file-url" class="form-input w-full p-2 text-sm" placeholder="https://link.al/documento.pdf"></div>
                    </div>
                    <button id="add-backpack-item-btn" class="mt-3 w-full bg-red-600 hover:bg-red-700 text-white p-2 rounded-md">Aggiungi Oggetto</button>
                </div>
                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 mt-6 fade-in-up">
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white"><i data-lucide="filter" class="w-5 h-5 text-red-400"></i>Filtra per Tipologia</h3>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button id="filter-tutti-btn" class="filter-btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-sm">Tutti</button>
                        <button id="filter-abbigliamento-btn" class="filter-btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-sm">Abbigliamento</button>
                        <button id="filter-elettronica-btn" class="filter-btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-sm">Elettronica</button>
                        <button id="filter-igiene-personale-btn" class="filter-btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-sm">Igiene Personale</button>
                        <button id="filter-documenti-btn" class="filter-btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-sm">Documenti</button>
                        <button id="filter-farmaci-btn" class="filter-btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-sm">Farmaci</button>
                        <button id="filter-varie-btn" class="filter-btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-sm">Varie</button>
                    </div>
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white"><i data-lucide="list-todo" class="w-5 h-5 text-red-400"></i>Lista Oggetti</h3>
                    <ul id="backpack-items-list" class="space-y-2 max-h-96 overflow-y-auto pr-2"></ul>
                </div>
            </main>
        </div>

        <!-- Map View -->
        <div id="map-view" class="view-transition opacity-0 hidden">
            <header class="p-4 sm:p-6 text-center">
                <h1 class="text-2xl sm:text-3xl font-bold text-white">Mappa e Luoghi</h1>
                <p class="text-gray-400">Esplora e salva i tuoi punti di interesse</p>
            </header>
            <main class="p-4 sm:p-6">
                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up">
                    <div class="collapsible-header" data-target="map-controls-content"><h3 class="font-semibold text-lg flex items-center gap-2 text-white flex-grow"><i data-lucide="map-pin" class="w-5 h-5 text-red-400"></i>Controlli Mappa</h3><i data-lucide="chevron-up" class="w-5 h-5 text-gray-400 toggle-icon"></i></div>
                    <div id="map-controls-content" class="collapsible-content pt-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div><label for="map-city-select" class="block text-sm font-medium text-gray-400 mb-1">Seleziona Città</label><select id="map-city-select" class="form-select w-full p-2 text-sm"></select></div>
                            <button id="open-item-modal-map-btn" class="md:col-start-1 md:col-span-2 w-full bg-red-600 hover:bg-red-700 text-white p-2 rounded-md flex items-center justify-center gap-2"><i data-lucide="plus" class="w-5 h-5"></i>Aggiungi Nuovo Luogo/Evento</button>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 mt-6 fade-in-up">
                    <div class="collapsible-header" data-target="map-content"><h3 class="font-semibold text-lg flex items-center gap-2 text-white flex-grow"><i data-lucide="map" class="w-5 h-5 text-red-400"></i>Mappa</h3><i data-lucide="chevron-up" class="w-5 h-5 text-gray-400 toggle-icon"></i></div>
                    <div id="map-content" class="collapsible-content pt-4"><div id="map"></div></div>
                </div>
                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 mt-6 fade-in-up">
                    <div class="collapsible-header" data-target="planner-items-list-content"><h3 class="font-semibold text-lg flex items-center gap-2 text-white flex-grow"><i data-lucide="list-checks" class="w-5 h-5 text-red-400"></i>Luoghi ed Eventi per <span id="current-map-city-display" class="ml-1 font-bold"></span></h3><i data-lucide="chevron-up" class="w-5 h-5 text-gray-400 toggle-icon"></i></div>
                    <div id="planner-items-list-content" class="collapsible-content pt-4">
                        <div class="mb-4">
                            <h4 class="font-semibold text-md mb-2 text-white">Filtra per Tag:</h4>
                            <div class="flex flex-wrap gap-2 mb-4">
                                <button id="filter-tag-tutti-btn" class="filter-tag-btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-sm">Tutti</button>
                                <button id="filter-tag-attrazione-btn" class="filter-tag-btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-sm">Attrazione</button>
                                <button id="filter-tag-ristorante-btn" class="filter-tag-btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-sm">Ristorante</button>
                                <button id="filter-tag-trasporto-btn" class="filter-tag-btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-sm">Trasporto</button>
                                <button id="filter-tag-alloggio-btn" class="filter-tag-btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-sm">Alloggio</button>
                                <button id="filter-tag-evento-btn" class="filter-tag-btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-sm">Evento</button>
                            </div>
                            <h4 class="font-semibold text-md mb-2 text-white">Filtra per Stato:</h4>
                            <div class="flex flex-wrap gap-2 mb-4">
                                <button id="filter-booked-tutti-btn" class="filter-booked-btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-sm">Tutti</button>
                                <button id="filter-booked-prenotati-btn" class="filter-booked-btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-sm">Prenotati</button>
                                <button id="filter-booked-non-prenotati-btn" class="filter-booked-btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md text-sm">Non Prenotati</button>
                            </div>
                            <h4 class="font-semibold text-md mb-2 text-white">Filtra per Giorno:</h4>
                            <div class="flex gap-2"><input type="date" id="filter-planner-item-date-input" class="form-input flex-1 p-2 text-sm"><button id="clear-planner-item-date-filter-btn" class="bg-gray-500 hover:bg-gray-600 text-white p-2 rounded-md text-sm"><i data-lucide="x" class="w-4 h-4"></i></button></div>
                        </div>
                        <ul id="planner-items-list" class="space-y-2 max-h-[40rem] overflow-y-auto pr-2"></ul>
                    </div>
                </div>
            </main>
        </div>

        <!-- Chat View -->
        <div id="chat-view" class="view-transition opacity-0 hidden">
            <header class="p-4 sm:p-6 text-center">
                <h1 class="text-2xl sm:text-3xl font-bold text-white">Diario</h1>
                <p class="text-gray-400">Appunti e traduzioni per ogni giorno</p>
            </header>
            <main class="p-4 sm:p-6 flex flex-col h-[calc(100vh-128px)]">
                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up mb-6">
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white"><i data-lucide="calendar" class="w-5 h-5 text-red-400"></i>Seleziona Giorno</h3>
                    <select id="chat-date-select" class="form-select w-full p-2 text-sm"></select>
                </div>
                <div class="fade-in-up">
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white"><i data-lucide="book-open" class="w-5 h-5 text-red-400"></i>Diario di oggi</h3>
                    <div id="chat-messages" class="paper-style"></div>
                </div>
                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up mt-6">
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white"><i data-lucide="message-square-plus" class="w-5 h-5 text-red-400"></i>Annotazione</h3>
                    <textarea id="chat-input" rows="2" class="form-input w-full p-2 text-sm" placeholder="Scrivi un appunto..."></textarea>
                    <button id="send-chat-message-btn" class="mt-3 w-full bg-red-600 hover:bg-red-700 text-white p-2 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>Invia</button>
                </div>
                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up mt-6">
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white"><i data-lucide="languages" class="w-5 h-5 text-red-400"></i>Messaggio</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="text-sm font-medium">Italiano / Giapponese</label><textarea id="translate-input-chat" rows="3" class="form-input w-full mt-1 p-2" lang="it"></textarea></div>
                        <div><label class="text-sm font-medium">Traduzione</label><textarea id="translate-output-chat" rows="3" class="form-input w-full mt-1 p-2" readonly></textarea></div>
                    </div>
                    <button id="translate-and-add-chat-btn" class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white p-2 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>Traduci e Aggiungi</button>
                    <div class="flex gap-2 mt-3">
                        <button id="toggle-keyboard-chat-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md flex items-center justify-center gap-2"><i data-lucide="keyboard" class="w-4 h-4"></i><span class="hidden sm:inline">Tastiera: Italiano</span></button>
                        <button id="clear-translation-chat-btn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white p-2 rounded-md text-sm"><i data-lucide="eraser" class="w-4 h-4 inline-block"></i> Pulisci</button>
                    </div>
                </div>
            </main>
        </div>

    </div>
    <!-- Modali Custom -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 max-w-sm w-full text-center"><p id="custom-alert-message" class="text-white mb-4"></p><button id="custom-alert-close-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">OK</button></div></div>
    <div id="custom-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 max-w-sm w-full text-center"><p id="custom-confirm-message" class="text-white mb-4"></p><div class="flex justify-center gap-4"><button id="custom-confirm-yes-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Sì</button><button id="custom-confirm-no-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">No</button></div></div></div>

    <!-- MODALE UNIFICATO PER AGGIUNGERE/MODIFICARE ELEMENTI -->
    <div id="item-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl border border-gray-700 w-full max-w-3xl max-h-full overflow-y-auto">
            <form id="item-form" onsubmit="return false;">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="item-modal-title" class="text-xl font-bold text-white">Nuovo Elemento</h3>
                        <button type="button" id="close-item-modal-btn" class="p-2 rounded-full hover:bg-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-6">
                        <!-- Colonna sinistra: Form -->
                        <div class="space-y-4">
                            <!-- Dettagli Principali -->
                            <div><label for="item-name" class="block text-sm font-medium text-gray-300 mb-1">Nome*</label><input type="text" id="item-name" class="form-input w-full" required></div>
                            <div><label for="item-description" class="block text-sm font-medium text-gray-300 mb-1">Descrizione</label><textarea id="item-description" rows="2" class="form-input w-full"></textarea></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="item-tag" class="block text-sm font-medium text-gray-300 mb-1">TAG</label><select id="item-tag" class="form-select w-full"><option>Ristorante</option><option>Attrazione</option><option>Trasporto</option><option>Alloggio</option><option>Evento</option></select></div>
                                <div><label for="item-indicative-day" class="block text-sm font-medium text-gray-300 mb-1">Giorno Indicativo</label><input type="date" id="item-indicative-day" class="form-input w-full"></div>
                                <div><label for="item-start-time" class="block text-sm font-medium text-gray-300 mb-1">Orario Inizio</label><input type="time" id="item-start-time" class="form-input w-full"></div>
                                <div><label for="item-end-time" class="block text-sm font-medium text-gray-300 mb-1">Orario Fine</label><input type="time" id="item-end-time" class="form-input w-full"></div>
                            </div>
                        </div>
                        <!-- Colonna destra: Mappa e Ricerca -->
                        <div class="space-y-4 row-start-1 lg:row-start-auto">
                            <div class="bg-gray-700/50 p-3 rounded-lg">
                                <label for="item-modal-search-query" class="block text-sm font-medium text-gray-300 mb-1">Cerca luogo per precompilare</label>
                                <div class="flex gap-2">
                                    <input type="text" id="item-modal-search-query" class="form-input flex-grow" placeholder="Es. Tokyo Skytree...">
                                    <button type="button" id="item-modal-search-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 rounded-md"><i data-lucide="search" class="w-5 h-5"></i></button>
                                </div>
                                <ul id="item-modal-search-results" class="mt-2 bg-gray-800 rounded-md max-h-32 overflow-y-auto"></ul>
                            </div>
                            <div id="item-modal-map"></div>
                        </div>
                    </div>

                    <!-- Sezioni aggiuntive -->
                    <div class="mt-4 border-t border-gray-700 pt-4">
                        <div class="flex items-center gap-3"><input type="checkbox" id="item-bookable" class="form-checkbox h-5 w-5"><label for="item-bookable" class="font-medium text-gray-300">Prenotabile</label></div>
                        <div id="item-booked-fields" class="mt-3 pl-8 space-y-3">
                             <div class="flex items-center gap-3"><input type="checkbox" id="item-booked" class="form-checkbox h-5 w-5"><label for="item-booked" class="font-medium text-gray-300">Prenotato</label></div>
                             <div id="item-booking-details" class="grid grid-cols-1 md:grid-cols-2 gap-4 pl-8">
                                <div><label for="item-booking-date" class="block text-sm font-medium text-gray-300 mb-1">Data Prenotazione*</label><input type="date" id="item-booking-date" class="form-input w-full"></div>
                                <div><label for="item-booking-time" class="block text-sm font-medium text-gray-300 mb-1">Orario Prenotazione</label><input type="time" id="item-booking-time" class="form-input w-full"></div>
                                <div class="md:col-span-2"><label for="item-booking-link" class="block text-sm font-medium text-gray-300 mb-1">Link Prenotazione</label><input type="url" id="item-booking-link" class="form-input w-full" placeholder="https://..."></div>
                             </div>
                        </div>
                    </div>
                    <div class="mt-4 border-t border-gray-700 pt-4">
                        <label class="font-medium text-gray-300">Prezzo</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">
                            <input type="number" id="item-price" class="form-input" placeholder="Valore">
                            <select id="item-price-currency" class="form-select"><option>Yen</option><option>Euro</option><option>Dollaro</option></select>
                            <div class="flex items-center gap-2"><input type="checkbox" id="item-price-indicative" class="form-checkbox"><label for="item-price-indicative" class="text-sm">Indicativo</label></div>
                            <div class="flex items-center gap-2"><input type="checkbox" id="item-price-per-person" class="form-checkbox"><label for="item-price-per-person" class="text-sm">Per Persona</label></div>
                        </div>
                    </div>
                     <div class="mt-4 border-t border-gray-700 pt-4">
                        <label class="font-medium text-gray-300">Dettagli Aggiuntivi</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                            <div><label for="item-external-link" class="block text-sm font-medium text-gray-300 mb-1">Link Esterno</label><input type="url" id="item-external-link" class="form-input w-full" placeholder="https://..."></div>
                            <div><label for="item-map-link" class="block text-sm font-medium text-gray-300 mb-1">Link Google Maps</label><input type="url" id="item-map-link" class="form-input w-full" placeholder="https://maps.app.goo.gl/..."></div>
                            <div><label for="item-lat" class="block text-sm font-medium text-gray-300 mb-1">Latitudine</label><input type="number" step="any" id="item-lat" class="form-input w-full"></div>
                            <div><label for="item-lng" class="block text-sm font-medium text-gray-300 mb-1">Longitudine</label><input type="number" step="any" id="item-lng" class="form-input w-full"></div>
                            <div class="hidden"><input type="text" id="item-city" class="form-input w-full"></div>
                        </div>
                    </div>
                    <div class="mt-4 border-t border-gray-700 pt-4">
                        <label for="item-notes" class="block text-sm font-medium text-gray-300 mb-1">Note</label>
                        <textarea id="item-notes" rows="3" class="form-input w-full"></textarea>
                    </div>
                </div>
                <div class="bg-gray-700/50 px-6 py-4 flex justify-end gap-3">
                    <button type="button" onclick="closeItemModal()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Annulla</button>
                    <button type="button" id="save-item-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Salva</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        lucide.createIcons();
    </script>
</body>
</html>
