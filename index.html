<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viaggio in Giappone 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase -->
    <script type="module">
        // Importa le funzioni necessarie dai moduli Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Importazioni corrette per Firestore
        import { getFirestore, collection, doc, addDoc, onSnapshot, query, where, getDocs, writeBatch, deleteDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Importazioni corrette per Auth
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // =================================================================================
        // CONFIGURAZIONE INIZIALE
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDF6KbJueQwWaeEVGRfI2AKqJ8or-AVjIk",
            authDomain: "giappini2025.firebaseapp.com",
            projectId: "giappini2025",
            storageBucket: "giappini2025.appspot.com",
            messagingSenderId: "733326492471",
            appId: "1:733326492471:web:09c93b1a6e5d4543b550b2",
            measurementId: "G-D9LKF6YET3"
        };
        // Le API Key di OpenWeatherMap e Gemini verranno gestite tramite Netlify Functions
        const GEMINI_MODEL_NAME = 'gemini-1.5-flash'; // Questo può essere impostato come variabile d'ambiente anche nella Netlify Function
        // =================================================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // initialTripData verrà caricato da un file JSON
        let tripData = [];
        let currentDayUnsubscribeNotes = null;
        let currentDayUnsubscribeExpenses = null;
        let currentDayUnsubscribeReservations = null; // Nuovo unsubscribe per le prenotazioni
        let itineraryUnsubscribe = null;
        let backpackUnsubscribe = null; // New unsubscribe for backpack
        let pinnedPlacesUnsubscribe = null; // New unsubscribe for pinned places
        let clockInterval = null;
        let italianClockInterval = null; // New interval for Italian time
        let currentActiveDate = null; // Global variable to store the currently active date
        let currentBackpackUser = 'pino'; // Default backpack user
        let currentBackpackFilter = 'Tutti'; // Default backpack filter
        let map; // Google Map instance
        let currentMapCity = 'Tokyo'; // Default map city
        let mapMarkers = []; // Array to store map markers
        let googleMapsApiLoaded = false; // Flag to ensure API loads only once


        // Variabili per la gestione dello swipe
        let touchStartX = 0;
        let touchEndX = 0;
        const swipeThreshold = 50; // Distanza minima in pixel per considerare uno swipe

        // Elementi UI
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const homeView = document.getElementById('home-view');
        const dayDetailView = document.getElementById('day-detail-view');
        const backpackView = document.getElementById('backpack-view'); // New backpack view
        const mapView = document.getElementById('map-view'); // New map view
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-btn');
        const translateInputIt = document.getElementById('translate-input-it'); // Added for keyboard toggle
        const translateOutputJp = document.getElementById('translate-output-jp'); // Added for keyboard toggle

        // Logica di autenticazione e navigazione
        onAuthStateChanged(auth, user => {
            if (user) {
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                setupInitialItinerary().then(loadItineraryAndInitApp);
            } else {
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                if (itineraryUnsubscribe) itineraryUnsubscribe();
                if (currentDayUnsubscribeNotes) currentDayUnsubscribeNotes();
                if (currentDayUnsubscribeExpenses) currentDayUnsubscribeExpenses();
                if (currentDayUnsubscribeReservations) currentDayUnsubscribeReservations(); // Clear reservations listener
                if (backpackUnsubscribe) backpackUnsubscribe(); // Clear backpack listener
                if (pinnedPlacesUnsubscribe) pinnedPlacesUnsubscribe(); // Clear pinned places listener
                if(clockInterval) clearInterval(clockInterval);
                if(italianClockInterval) clearInterval(italianClockInterval); // Clear Italian clock interval
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            loginError.textContent = '';
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    console.error("Login failed:", error);
                    loginError.textContent = 'Credenziali non valide. Riprova.';
                });
        });

        logoutButton.addEventListener('click', () => signOut(auth));
        
        // Navigation buttons in the fixed header
        document.getElementById('nav-itinerary-btn').addEventListener('click', () => navigateTo('home'));
        document.getElementById('nav-backpack-btn').addEventListener('click', () => {
            navigateTo('backpack');
            loadAndDisplayBackpackItems(); // Load backpack items when navigating to backpack view
        });
        document.getElementById('nav-map-btn').addEventListener('click', () => {
            navigateTo('map');
            loadGoogleMapsScript(); // Load Google Maps API when navigating to map view
            populateMapCityDropdown(); // Populate dropdown when map view is loaded
            // loadAndDisplayPinnedPlaces will be called by initMap callback
        });


        function navigateTo(viewName) {
            const views = {
                'home': homeView,
                'day-detail': dayDetailView,
                'backpack': backpackView,
                'map': mapView // Add map view
            };

            // Before hiding all views, if current view is map, clear its inputs
            if (!mapView.classList.contains('hidden')) { // If map view is currently active
                clearMapInputs(); // Call function to clear map specific inputs
            }

            // Nascondi tutte le viste con transizione
            Object.values(views).forEach(view => {
                view.classList.add('opacity-0', 'pointer-events-none');
                view.classList.remove('opacity-100');
            });

            setTimeout(() => {
                // Nascondi fisicamente tutte le viste
                Object.values(views).forEach(view => view.classList.add('hidden'));

                // Mostra la vista desiderata e avvia la transizione di entrata
                const nextView = views[viewName];
                if (nextView) {
                    nextView.classList.remove('hidden');
                    // Forza il reflow per assicurare che la transizione venga applicata
                    void nextView.offsetWidth; 
                    nextView.classList.remove('opacity-0', 'pointer-events-none');
                    nextView.classList.add('opacity-100');

                    // Trigger fade-in-up animation for content within the new view
                    nextView.querySelectorAll('.fade-in-up').forEach((el, index) => {
                        el.style.animationDelay = `${index * 0.1}s`;
                        el.classList.remove('fade-in-up'); // Rimuovi per permettere di riapplicare
                        void el.offsetWidth; // Trigger reflow
                        el.classList.add('fade-in-up');
                    });
                }
            }, 300); // Durata della transizione CSS
        }

        async function setupInitialItinerary() {
            const itineraryCol = collection(db, 'itinerary');
            const snapshot = await getDocs(itineraryCol);
            if (snapshot.empty) {
                console.log("Populating itinerary from JSON...");
                try {
                    const response = await fetch('/data/tripData.json');
                    if (!response.ok) throw new Error('Failed to load tripData.json');
                    const initialData = await response.json();

                    const batch = writeBatch(db);
                    initialData.forEach(day => batch.set(doc(db, "itinerary", day.date), day));
                    await batch.commit();
                    console.log("Itinerary populated successfully.");
                } catch (error) {
                    console.error("Error populating initial itinerary:", error);
                }
            }
        }
        
        function loadItineraryAndInitApp() {
            const itineraryCol = collection(db, 'itinerary');
            if (itineraryUnsubscribe) itineraryUnsubscribe();
            
            itineraryUnsubscribe = onSnapshot(query(itineraryCol), (snapshot) => {
                tripData = [];
                snapshot.forEach(doc => tripData.push(doc.data()));
                tripData.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                populateCityTagDropdown(); // Call after tripData is loaded
                populateMapCityDropdown(); // Ensure map city dropdown is populated
                renderHomeView();
                navigateTo('home');
            });
        }
        
        // Mappa delle immagini per le località con percorsi locali
        const locationImages = {
            "Tokyo": "images/tokyo.jpg",
            "Ryokan (Takaragawa Onsen)": "images/takaragawaonsen.jpg",
            "Kanazawa": "images/kanazawa.jpg",
            "Shirakawa-go": "images/shirakawago.jpg",
            "Kyoto": "images/kyoto.jpg",
            "Osaka": "images/osaka.jpeg",
            "Nara / Osaka": "images/nara.jpg",
            "Volo di Ritorno": "https://placehold.co/1200x675/374151/d1d5db?text=Volo+di+Ritorno",
            // Aggiungi altre località se necessario
            "default": "images/giappone.jpg" // Immagine predefinita
        };

        // Mappa delle coordinate per le città (per Open-Meteo e Google Maps)
        const cityCoordinates = {
            "Tokyo": { latitude: 35.6895, longitude: 139.6917, zoom: 12 },
            "Ryokan (Takaragawa Onsen)": { latitude: 36.8528, longitude: 139.0287, zoom: 12 }, // Coordinate approssimative per Takaragawa Onsen
            "Kanazawa": { latitude: 36.5612, longitude: 136.6562, zoom: 12 },
            "Shirakawa-go": { latitude: 36.2575, longitude: 136.8973, zoom: 14 },
            "Kyoto": { latitude: 35.0116, longitude: 135.7681, zoom: 12 },
            "Osaka": { latitude: 34.6937, longitude: 135.5022, zoom: 12 },
            "Nara": { latitude: 34.6851, longitude: 135.8048, zoom: 13 }, // Coordinate per Nara
            "Volo di Ritorno": { latitude: 0, longitude: 0, zoom: 1 }, // Placeholder, non useremo il meteo per questo
            "default": { latitude: 35.6895, longitude: 139.6917, zoom: 12 } // Tokyo come default
        };


        function renderHomeView() {
            const itineraryTableBody = document.getElementById('itinerary-table-body');
            itineraryTableBody.innerHTML = '';
            
            // Imposta l'immagine della home page
            const homeImageEl = document.getElementById('home-title-image');
            if (homeImageEl) {
                homeImageEl.src = locationImages["default"]; // Immagine generica per la home
                homeImageEl.alt = "Paesaggio Giapponese";
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to midnight for comparison

            let firstDayBeforeTripFound = false;
            let firstDayDate = tripData.length > 0 ? new Date(tripData[0].date) : null;
            if (firstDayDate) firstDayDate.setHours(0, 0, 0, 0);

            tripData.forEach(day => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-gray-700/50 cursor-pointer transition-colors duration-200';
                row.dataset.date = day.date;
                
                const dayDate = new Date(day.date);
                dayDate.setHours(0, 0, 0, 0); // Reset time to midnight for comparison

                let isPast = dayDate < today;
                let isToday = dayDate.getTime() === today.getTime();
                let isHighlighted = false;

                if (isToday) {
                    isHighlighted = true;
                } else if (!firstDayBeforeTripFound && firstDayDate && today < firstDayDate && dayDate.getTime() === firstDayDate.getTime()) {
                    isHighlighted = true;
                    firstDayBeforeTripFound = true; // Ensure only the very first day is highlighted if before trip
                }

                if (isHighlighted) {
                    row.classList.add('bg-green-700/30', 'border-green-500'); // Highlight current/first day
                } else if (isPast) {
                    row.classList.add('text-gray-500'); // Dim past days
                } else {
                    row.classList.add('text-gray-200'); // Normal color for future days
                }

                row.innerHTML = `
                    <td class="p-4">${dayDate.toLocaleDateString('it-IT', { weekday: 'long', day: '2-digit', month: '2-digit' })}</td>
                    <td class="p-4">${day.location}</td>
                    <td class="p-4">${day.accommodation.name}</td>
                    <td class="p-4 text-right"><i data-lucide="chevron-right" class="w-5 h-5 inline-block ${isHighlighted ? 'text-green-400' : (isPast ? 'text-gray-600' : 'text-red-400')}"></i></td>
                `;
                row.addEventListener('click', () => {
                    renderDayDetailView(day.date);
                    navigateTo('day-detail');
                });
                itineraryTableBody.appendChild(row);
            });
            lucide.createIcons();
        }

        function renderDayDetailView(dateString, direction = 'none') { // Added direction parameter
            const dayData = tripData.find(d => d.date === dateString);
            if (!dayData) return;

            currentActiveDate = dateString; // Store the current active date

            if (currentDayUnsubscribeNotes) currentDayUnsubscribeNotes();
            if (currentDayUnsubscribeExpenses) currentDayUnsubscribeExpenses();
            if (currentDayUnsubscribeReservations) currentDayUnsubscribeReservations(); // Clear previous reservations listener
            if (backpackUnsubscribe) backpackUnsubscribe(); // Ensure backpack listener is cleared for day view
            if (pinnedPlacesUnsubscribe) pinnedPlacesUnsubscribe(); // Clear pinned places listener
            if (clockInterval) clearInterval(clockInterval);
            if (italianClockInterval) clearInterval(italianClockInterval); // Clear Italian clock interval

            document.getElementById('location').textContent = dayData.location;
            document.getElementById('date').textContent = new Date(dayData.date).toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            // Imposta l'immagine della pagina di dettaglio del giorno
            const dayDetailImageEl = document.getElementById('day-detail-title-image');
            if (dayDetailImageEl) {
                const imageUrl = locationImages[dayData.location.split('/')[0].trim()] || locationImages["default"];
                dayDetailImageEl.src = imageUrl;
                dayDetailImageEl.alt = `Immagine di ${dayData.location}`;
            }

            // Ottieni le coordinate dalla mappa cityCoordinates
            const cityKey = dayData.location.split('/')[0].trim();
            const coords = cityCoordinates[cityKey] || cityCoordinates["default"];
            getWeather(coords.latitude, coords.longitude, dayData.location.split('/')[0].trim()); // Passa lat, lon e nome città

            updateClock('Asia/Tokyo', 'local-time');
            updateClock('Europe/Rome', 'italian-local-time'); // Aggiorna l'orario italiano

            const accommodationEl = document.getElementById('accommodation-widget');
            accommodationEl.innerHTML = `<div class="font-semibold text-white">${dayData.accommodation.name}</div>${dayData.accommodation.details ? `<div class="text-sm text-gray-300">${dayData.accommodation.details}</div>` : ''}${dayData.accommodation.mapLink ? `<a href="${dayData.accommodation.mapLink}" target="_blank" class="text-blue-400 hover:underline text-sm flex items-center gap-1 mt-1"><i data-lucide="map-pin" class="w-4 h-4"></i>Vedi sulla mappa</a>` : ''}`;
            
            const travelEventsEl = document.getElementById('travel-events-widget');
            travelEventsEl.innerHTML = '';
            if (!dayData.travel && !dayData.events || dayData.travel.length === 0 && dayData.events.length === 0) {
                travelEventsEl.innerHTML = `<div class="text-gray-400">Nessuno spostamento o evento principale per oggi.</div>`;
            }
            if(dayData.travel) dayData.travel.forEach(item => {
                travelEventsEl.innerHTML += `<div class="flex items-start gap-3"><i data-lucide="train-front" class="w-5 h-5 text-red-400 mt-1 flex-shrink-0"></i><div><div class="font-medium text-white">${item.type}</div><div class="text-gray-300 text-sm">${item.description}</div></div></div>`;
            });
            if(dayData.events) dayData.events.forEach(item => {
                travelEventsEl.innerHTML += `<div class="flex items-start gap-3 mt-3"><i data-lucide="ticket" class="w-5 h-5 text-green-400 mt-1 flex-shrink-0"></i><div><div class="font-medium text-white">${item.name}</div><div class="text-gray-300 text-sm">${item.details}</div>${item.link ? `<a href="${item.link}" target="_blank" class="text-blue-400 hover:underline text-sm">Link</a>` : ''}</div></div>`;
            });

            loadAndDisplayNotes(dateString);
            loadAndDisplayExpenses(dateString);
            loadAndDisplayTodaysReservations(dateString); // Carica e visualizza le prenotazioni per oggi
            renderTodaysBackpackItems(dayData.location.split('/')[0].trim()); // Render backpack items for today's location
            
            document.getElementById('save-note-btn').onclick = () => saveNote(dateString, null, 'manual'); // Passa 'manual' come sorgente
            document.getElementById('save-expense-btn').onclick = () => saveExpense(dateString);
            document.getElementById('translate-btn').onclick = () => translate();
            document.getElementById('toggle-keyboard-btn').onclick = () => toggleKeyboardLanguage(); // Nuovo listener per il tasto
            
            // Nuovo listener per il pulsante "Pulisci"
            document.getElementById('clear-translation-btn').onclick = () => clearTranslationBoxes();
            // Nuovo listener per il pulsante "Meteo attuale"
            document.getElementById('current-location-weather-btn').onclick = () => getGeolocationWeather();

            // Logica per i pulsanti di navigazione giorno
            const currentIndex = tripData.findIndex(d => d.date === dateString);
            const prevDayBtn = document.getElementById('prev-day-btn');
            const nextDayBtn = document.getElementById('next-day-btn');

            if (prevDayBtn) {
                if (currentIndex > 0) {
                    prevDayBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    prevDayBtn.onclick = () => navigateDay(currentIndex - 1);
                } else {
                    prevDayBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    prevDayBtn.onclick = null;
                }
            }

            if (nextDayBtn) {
                if (currentIndex < tripData.length - 1) {
                    nextDayBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    nextDayBtn.onclick = () => navigateDay(currentIndex + 1);
                } else {
                    nextDayBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    nextDayBtn.onclick = null;
                }
            }

            lucide.createIcons();

            // Apply slide-in animation based on direction
            const dayContentWrapper = document.getElementById('day-content-wrapper');
            if (dayContentWrapper) {
                dayContentWrapper.classList.remove('slide-left-in', 'slide-right-in'); // Remove previous animations
                void dayContentWrapper.offsetWidth; // Trigger reflow
                if (direction === 'next') {
                    dayContentWrapper.classList.add('slide-right-in');
                } else if (direction === 'prev') {
                    dayContentWrapper.classList.add('slide-left-in');
                }
                // Remove the class after animation to allow it to be re-applied
                setTimeout(() => {
                    dayContentWrapper.classList.remove('slide-right-in', 'slide-left-in');
                }, 300); // Match CSS animation duration
            }
        }

        // Funzione per navigare tra i giorni dell'itinerario con transizione
        function navigateDay(index) {
            if (index >= 0 && index < tripData.length) {
                const newDate = tripData[index].date;
                const currentDayContentWrapper = document.getElementById('day-content-wrapper');
                const currentIndex = tripData.findIndex(d => d.date === currentActiveDate);
                const direction = index > currentIndex ? 'next' : 'prev';

                if (currentDayContentWrapper) {
                    currentDayContentWrapper.classList.remove('slide-left-out', 'slide-right-out'); // Ensure no lingering classes
                    void currentDayContentWrapper.offsetWidth; // Trigger reflow
                    currentDayContentWrapper.classList.add(direction === 'next' ? 'slide-left-out' : 'slide-right-out');

                    setTimeout(() => {
                        renderDayDetailView(newDate, direction); // Pass direction to render function
                        currentDayContentWrapper.classList.remove('slide-left-out', 'slide-right-out');
                    }, 300); // Match CSS animation duration
                } else {
                    renderDayDetailView(newDate, direction); // Fallback if wrapper not found
                }
            }
        }
        
        async function getWeather(latitude, longitude, locationName = 'Posizione attuale') {
            const weatherWidget = document.getElementById('weather-widget');
            weatherWidget.innerHTML = `<div class="text-gray-400">Caricamento meteo per ${locationName}...</div>`;
            
            try {
                // Chiamata alla Netlify Function per il meteo
                const response = await fetch('/.netlify/functions/getWeather', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude: latitude, longitude: longitude }) // Passa lat e lon
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Netlify Function Error Body (Weather):", errorBody);
                    throw new Error(`Errore dalla funzione server (Meteo): ${errorBody.message || 'Errore sconosciuto'}`);
                }
                const data = await response.json();
                
                // Mappa i codici icona di Open-Meteo alle icone di OpenWeatherMap o a Lucide Icons se preferisci
                // Per semplicità, useremo un mapping di base o potresti voler integrare un set di icone meteo
                
                weatherWidget.innerHTML = `
                    <h4 class="font-semibold text-lg mb-2 text-white">${locationName}</h4>
                    <div class="flex items-center gap-4 mb-4">
                        <img src="${getWeatherIcon(data.current.weathercode)}" alt="weather icon" class="w-16 h-16 -my-2">
                        <div>
                            <div class="text-3xl font-bold text-white">${Math.round(data.current.temperature)}°C</div>
                            <div class="text-gray-300 capitalize">${data.current.description}</div>
                        </div>
                        <div class="text-sm text-gray-400">
                            <div>Umidità: ${data.current.relativehumidity_2m}%</div>
                            <div>Vento: ${data.current.windspeed_10m} km/h</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center text-sm">
                        <div>
                            <p class="font-medium text-white">Mattino</p>
                            <img src="${getWeatherIcon(data.morning.weathercode)}" alt="morning weather" class="w-10 h-10 mx-auto">
                            <p class="text-gray-300">${Math.round(data.morning.temperature_2m_max)}°C</p>
                        </div>
                        <div>
                            <p class="font-medium text-white">Pomeriggio</p>
                            <img src="${getWeatherIcon(data.afternoon.weathercode)}" alt="afternoon weather" class="w-10 h-10 mx-auto">
                            <p class="text-gray-300">${Math.round(data.afternoon.temperature_2m_max)}°C</p>
                        </div>
                        <div>
                            <p class="font-medium text-white">Sera</p>
                            <img src="${getWeatherIcon(data.evening.weathercode)}" alt="evening weather" class="w-10 h-10 mx-auto">
                            <p class="text-gray-300">${Math.round(data.evening.temperature_2m_max)}°C</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error("Weather error:", error);
                weatherWidget.innerHTML = `<div class="text-red-400">Meteo non disponibile per ${locationName}. ${error.message}</div>`;
            }
        }

        // Funzione per ottenere il meteo della posizione attuale
        function getGeolocationWeather() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        // Chiamata alla Netlify Function per ottenere il nome della località dalla geolocalizzazione
                        const response = await fetch('/.netlify/functions/getWeather', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ latitude: lat, longitude: lon, reverseGeocode: true })
                        });
                        const data = await response.json();
                        const locationName = data.locationName || 'La tua posizione';
                        getWeather(lat, lon, locationName); // Aggiorna il meteo con la posizione attuale
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        document.getElementById('weather-widget').innerHTML = `<div class="text-red-400">Impossibile ottenere la tua posizione. Abilita la geolocalizzazione.</div>`;
                    }
                );
            } else {
                document.getElementById('weather-widget').innerHTML = `<div class="text-red-400">La geolocalizzazione non è supportata dal tuo browser.</div>`;
            }
        }


        // Funzione helper per mappare i codici meteo di Open-Meteo a icone
        // Puoi espandere questa funzione con più codici e icone Lucide o altre
        function getWeatherIcon(weathercode) {
            // Riferimento: https://www.nodc.noaa.gov/archive/arc0021/1993/iso/wmo-code.html
            // O la documentazione WMO di Open-Meteo
            switch (weathercode) {
                case 0: return "https://openweathermap.org/img/wn/01d@2x.png"; // Clear sky
                case 1:
                case 2:
                case 3: return "https://openweathermap.org/img/wn/02d@2x.png"; // Mainly clear, partly cloudy, overcast
                case 45:
                case 48: return "https://openweathermap.org/img/wn/50d@2x.png"; // Fog and depositing rime fog
                case 51:
                case 53:
                case 55: return "https://openweathermap.org/img/wn/09d@2x.png"; // Drizzle
                case 56:
                case 57: return "https://openweathermap.org/img/wn/09d@2x.png"; // Freezing Drizzle
                case 61:
                case 63:
                case 65: return "https://openweathermap.org/img/wn/10d@2x.png"; // Rain
                case 66:
                case 67: return "https://openweathermap.org/img/wn/10d@2x.png"; // Freezing Rain
                case 71:
                case 73:
                case 75: return "https://openweathermap.org/img/wn/13d@2x.png"; // Snow fall
                case 77: return "https://openweathermap.org/img/wn/13d@2x.png"; // Snow grains
                case 80:
                case 81:
                case 82: return "https://openweathermap.org/img/wn/09d@2x.png"; // Rain showers
                case 85:
                case 86: return "https://openweathermap.org/img/wn/13d@2x.png"; // Snow showers
                case 95: return "https://openweathermap.org/img/wn/11d@2x.png"; // Thunderstorm
                case 96:
                case 99: return "https://openweathermap.org/img/wn/11d@2x.png"; // Thunderstorm with hail
                default: return "https://openweathermap.org/img/wn/01d@2x.png"; // Default to clear day icon
            }
        }


        function updateClock(timezone, elementId) {
            const clockEl = document.getElementById(elementId);
            if (!clockEl) return; // Assicurati che l'elemento esista

            // Clear previous interval if it's the main clock
            if (elementId === 'local-time' && clockInterval) {
                clearInterval(clockInterval);
            } else if (elementId === 'italian-local-time' && italianClockInterval) {
                clearInterval(italianClockInterval);
            }

            const intervalId = setInterval(() => {
                clockEl.textContent = new Date().toLocaleTimeString('it-IT', { timeZone: timezone, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            }, 1000);

            if (elementId === 'local-time') {
                clockInterval = intervalId;
            } else if (elementId === 'italian-local-time') {
                italianClockInterval = intervalId;
            }
        }

        function loadAndDisplayNotes(dateString) {
            const notesListEl = document.getElementById('notes-list');
            notesListEl.innerHTML = '<li>Caricamento...</li>';
            const notesQuery = query(collection(db, "trip-notes"), where("date", "==", dateString));
            currentDayUnsubscribeNotes = onSnapshot(notesQuery, (snapshot) => {
                notesListEl.innerHTML = '';
                let notes = [];
                snapshot.forEach(doc => notes.push(doc.data()));
                notes.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());
                if (notes.length === 0) {
                    notesListEl.innerHTML = '<li class="text-gray-400">Nessun appunto.</li>';
                } else {
                    notes.forEach(note => {
                        const li = document.createElement('li');
                        // Applica classi diverse in base alla sorgente della nota
                        const noteClass = note.source === 'translation' ? 'bg-blue-400/10 text-blue-200' : 'bg-red-400/10 text-red-200';
                        li.className = `${noteClass} p-3 rounded-lg text-sm`;
                        li.textContent = note.text;
                        notesListEl.appendChild(li);
                    });
                }
            });
        }

        async function saveNote(dateString, textToSave = null, source = 'manual') { // Aggiungi parametro 'source'
            const input = document.getElementById('note-input');
            const text = textToSave || input.value.trim(); // Usa textToSave se fornito, altrimenti il valore dell'input

            if (text) {
                await addDoc(collection(db, "trip-notes"), { date: dateString, text: text, source: source, createdAt: new Date() }); // Salva anche la sorgente
                if (!textToSave) { // Pulisci l'input solo se il testo proviene dalla textarea degli appunti
                    input.value = '';
                }
            }
        }

        function loadAndDisplayExpenses(dateString) {
            const expensesListEl = document.getElementById('expenses-list');
            const totalExpensesEl = document.getElementById('total-expenses');
            expensesListEl.innerHTML = '<li>Caricamento...</li>';
            const expensesQuery = query(collection(db, "trip-expenses"), where("date", "==", dateString));
            currentDayUnsubscribeExpenses = onSnapshot(expensesQuery, (snapshot) => {
                expensesListEl.innerHTML = '';
                let total = 0;
                let expenses = [];
                snapshot.forEach(doc => expenses.push(doc.data()));
                expenses.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());
                if (expenses.length === 0) {
                    expensesListEl.innerHTML = '<li class="text-gray-400">Nessuna spesa.</li>';
                } else {
                    expenses.forEach(expense => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center text-sm text-gray-300';
                        li.innerHTML = `<span>${expense.description}</span> <span class="font-semibold text-white">${expense.amount} ¥</span>`;
                        expensesListEl.appendChild(li);
                        total += parseFloat(expense.amount);
                    });
                }
                totalExpensesEl.textContent = `${total.toLocaleString('ja-JP')} ¥`;
            });
        }

        async function saveExpense(dateString) {
            const descInput = document.getElementById('expense-description');
            const amountInput = document.getElementById('expense-amount');
            if (descInput.value.trim() && amountInput.value.trim() && !isNaN(amountInput.value)) {
                await addDoc(collection(db, "trip-expenses"), { date: dateString, description: descInput.value.trim(), amount: parseFloat(amountInput.value), createdAt: new Date() });
                descInput.value = '';
                amountInput.value = '';
            }
        }
        
        async function translate() {
            const inputEl = document.getElementById('translate-input-it');
            const outputEl = document.getElementById('translate-output-jp');
            const textToTranslate = inputEl.value.trim();
            if (!textToTranslate) return;

            outputEl.value = "Traduzione in corso...";
            
            // Determina la lingua di destinazione in base alla presenza di caratteri giapponesi nell'input
            const isJapanese = /[一-龠]+|[ぁ-ゔ]+|[ァ-ヴー]+/.test(textToTranslate);
            const targetLanguage = isJapanese ? "Italiano" : "Giapponese";
            const prompt = `Traduci questo in ${targetLanguage}: "${textToTranslate}" Rispondi esclusivamente con la traduzione, senza aggiungere altro.`; 

            try {
                // Chiamata alla Netlify Function invece che direttamente all'API Gemini
                const response = await fetch('/.netlify/functions/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt, model: GEMINI_MODEL_NAME }) // Passa il modello alla funzione
                });
                
                // Gestione degli errori dalla risposta della Netlify Function
                if (!response.ok) {
                    // Tenta di leggere il corpo della risposta come testo per un debug più facile
                    const errorText = await response.text();
                    console.error("Netlify Function Error Raw Response:", errorText);
                    let errorMessage = `Errore dalla funzione server: ${response.status} ${response.statusText}`;
                    try {
                        const errorBody = JSON.parse(errorText);
                        errorMessage = `Errore dalla funzione server: ${errorBody.message || 'Errore sconosciuto'}`;
                    } catch (e) {
                        // Se non è JSON, usa il testo grezzo
                        errorMessage = `Errore dalla funzione server: ${errorText}`;
                    }
                    throw new Error(errorMessage);
                }

                // Parsifica la risposta JSON
                const result = await response.json();
                if (result.translation) {
                    outputEl.value = result.translation;
                    
                    // Salva automaticamente originale e traduzione negli appunti
                    if (currentActiveDate) {
                        await saveNote(currentActiveDate, `Originale: ${textToTranslate}`, 'translation');
                        await saveNote(currentActiveDate, `Traduzione: ${result.translation}`, 'translation');
                    }

                } else {
                    throw new Error("Nessuna traduzione valida ricevuta dalla funzione server.");
                }

            } catch (error) {
                console.error("Translation error:", error);
                outputEl.value = `Errore di traduzione: ${error.message}. Controlla i log della Netlify Function.`;
            }
        }

        // Funzione per attivare/disattivare la tastiera giapponese/italiana
        function toggleKeyboardLanguage() {
            // Controlla la lingua corrente dell'input
            const currentLang = translateInputIt.lang;

            if (currentLang === 'it' || !currentLang) { // Se è italiano o non è impostato, passa a giapponese
                translateInputIt.lang = 'ja';
                translateInputIt.placeholder = 'Scrivi qui in Giapponese...';
                // Potresti voler aggiungere un inputmode specifico per giapponese, ma 'text' con lang='ja' è spesso sufficiente
                // translateInputIt.inputmode = 'kana'; // o 'katakana' per tastiere kana/katakana
                document.getElementById('toggle-keyboard-btn').innerHTML = '<i data-lucide="keyboard" class="w-4 h-4"></i><span class="hidden sm:inline">Tastiera: Giapponese</span>';
            } else { // Se è giapponese, torna a italiano
                translateInputIt.lang = 'it';
                translateInputIt.placeholder = 'Scrivi qui in Italiano...';
                // translateInputIt.inputmode = 'text';
                document.getElementById('toggle-keyboard-btn').innerHTML = '<i data-lucide="keyboard" class="w-4 h-4"></i><span class="hidden sm:inline">Tastiera: Italiano</span>';
            }
            lucide.createIcons(); // Aggiorna l'icona
        }

        // Nuova funzione per pulire i campi di testo della traduzione
        function clearTranslationBoxes() {
            document.getElementById('translate-input-it').value = '';
            document.getElementById('translate-output-jp').value = '';
        }

        // Funzioni per la sezione Zaino
        async function loadAndDisplayBackpackItems() {
            const backpackListEl = document.getElementById('backpack-items-list');
            backpackListEl.innerHTML = '<li>Caricamento...</li>';
            // Usa la collezione dinamica in base a currentBackpackUser
            const backpackQuery = query(collection(db, "backpacks", currentBackpackUser, "items")); 
            
            if (backpackUnsubscribe) backpackUnsubscribe(); // Unsubscribe from previous listener

            backpackUnsubscribe = onSnapshot(backpackQuery, (snapshot) => {
                backpackListEl.innerHTML = '';
                let items = [];
                snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                items.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());

                const filteredItems = currentBackpackFilter === 'Tutti'
                    ? items
                    : items.filter(item => item.type === currentBackpackFilter);

                if (filteredItems.length === 0) {
                    backpackListEl.innerHTML = '<li class="text-gray-400">Nessun oggetto nello zaino per questa tipologia.</li>';
                } else {
                    filteredItems.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'flex items-center justify-between bg-gray-700/30 p-3 rounded-lg text-sm mb-2 hover-shadow-effect';
                        li.dataset.id = item.id; // Add data-id for easier selection
                        li.dataset.editing = 'false'; // Track editing state

                        li.innerHTML = `
                            <div class="flex items-center flex-grow" id="item-display-${item.id}">
                                <input type="checkbox" data-id="${item.id}" ${item.inBackpack ? 'checked' : ''} class="form-checkbox h-5 w-5 text-green-500 rounded-md border-gray-600 bg-gray-800 cursor-pointer transition-colors duration-200">
                                <div class="ml-3">
                                    <span class="font-semibold text-white">${item.name}</span>
                                    <span class="text-gray-400"> (${item.quantity})</span>
                                    <span class="text-red-300 text-xs block">${item.type}</span>
                                    ${item.cityTag ? `<span class="text-gray-500 text-xs block">Città: ${item.cityTag}</span>` : ''}
                                    ${item.fileUrl ? `<a href="${item.fileUrl}" target="_blank" class="text-blue-400 hover:underline text-xs block mt-1">Allegato <i data-lucide="external-link" class="w-3 h-3 inline-block"></i></a>` : ''}
                                </div>
                            </div>
                            <div id="item-edit-${item.id}" class="hidden flex-grow ml-3">
                                <!-- Edit form will go here -->
                            </div>
                            <div class="flex items-center">
                                <button data-id="${item.id}" class="edit-item-btn ml-4 p-2 rounded-full bg-red-600 hover:bg-red-700 text-white transition-colors duration-200">
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                </button>
                                <button data-id="${item.id}" class="delete-item-btn ml-2 p-2 rounded-full bg-red-600 hover:bg-red-700 text-white transition-colors duration-200">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        `;
                        backpackListEl.appendChild(li);
                    });

                    // Add event listeners for checkboxes, edit buttons and delete buttons after rendering
                    backpackListEl.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        checkbox.addEventListener('change', (e) => toggleBackpackItem(e.target.dataset.id, e.target.checked));
                    });
                    backpackListEl.querySelectorAll('.edit-item-btn').forEach(button => {
                        button.addEventListener('click', (e) => editBackpackItem(e.currentTarget.dataset.id, items)); // Pass items array
                    });
                    backpackListEl.querySelectorAll('.delete-item-btn').forEach(button => {
                        button.addEventListener('click', (e) => deleteBackpackItem(e.currentTarget.dataset.id));
                    });
                }
                lucide.createIcons();
            });
        }

        async function saveBackpackItem() {
            const nameInput = document.getElementById('backpack-item-name');
            const typeSelect = document.getElementById('backpack-item-type');
            const quantityInput = document.getElementById('backpack-item-quantity');
            const cityTagSelect = document.getElementById('backpack-item-city-tag'); // New city tag select
            const fileUrlInput = document.getElementById('backpack-item-file-url'); // New file URL input

            const name = nameInput.value.trim();
            const type = typeSelect.value;
            const quantity = parseInt(quantityInput.value, 10);
            const cityTag = cityTagSelect.value; // Get city tag
            const fileUrl = fileUrlInput.value.trim(); // Get file URL

            if (name && type && !isNaN(quantity) && quantity > 0) {
                // Usa la collezione dinamica in base a currentBackpackUser
                await addDoc(collection(db, "backpacks", currentBackpackUser, "items"), {
                    name: name,
                    type: type,
                    quantity: quantity,
                    cityTag: cityTag, // Save city tag
                    fileUrl: fileUrl, // Save file URL
                    inBackpack: false, // Default to not in backpack
                    createdAt: new Date()
                });
                nameInput.value = '';
                quantityInput.value = '1'; // Reset quantity to 1
                typeSelect.value = 'Abbigliamento'; // Reset type
                cityTagSelect.value = 'None'; // Reset city tag
                fileUrlInput.value = ''; // Reset file URL
            } else {
                console.warn("Dati oggetto zaino non validi.");
            }
        }

        async function toggleBackpackItem(itemId, inBackpackStatus) {
            // Usa la collezione dinamica in base a currentBackpackUser
            const itemRef = doc(db, "backpacks", currentBackpackUser, "items", itemId);
            await updateDoc(itemRef, {
                inBackpack: inBackpackStatus
            });
        }

        async function deleteBackpackItem(itemId) {
            if (await showCustomConfirm("Sei sicuro di voler eliminare questo oggetto?")) {
                // Usa la collezione dinamica in base a currentBackpackUser
                const itemRef = doc(db, "backpacks", currentBackpackUser, "items", itemId);
                await deleteDoc(itemRef);
            }
        }

        // Function to handle editing a backpack item
        function editBackpackItem(itemId, items) {
            const itemToEdit = items.find(item => item.id === itemId);
            if (!itemToEdit) return;

            const listItem = document.querySelector(`li[data-id="${itemId}"]`);
            const displayDiv = listItem.querySelector(`#item-display-${itemId}`);
            const editDiv = listItem.querySelector(`#item-edit-${itemId}`);
            const editButton = listItem.querySelector(`.edit-item-btn`);
            const deleteButton = listItem.querySelector(`.delete-item-btn`);

            if (listItem.dataset.editing === 'true') {
                return; // Already in editing mode
            }

            listItem.dataset.editing = 'true';
            displayDiv.classList.add('hidden');
            editDiv.classList.remove('hidden');
            editButton.classList.add('hidden'); // Hide edit button
            deleteButton.classList.add('hidden'); // Hide delete button during edit

            editDiv.innerHTML = `
                <div class="flex flex-col gap-2 w-full">
                    <input type="text" id="edit-name-${itemId}" class="form-input p-2 rounded-md text-sm" value="${itemToEdit.name}">
                    <select id="edit-type-${itemId}" class="form-input p-2 rounded-md text-sm">
                        ${['Abbigliamento', 'Elettronica', 'Igiene Personale', 'Documenti', 'Farmaci', 'Varie'].map(type => `<option value="${type}" ${itemToEdit.type === type ? 'selected' : ''}>${type}</option>`).join('')}
                    </select>
                    <input type="number" id="edit-quantity-${itemId}" class="form-input p-2 rounded-md text-sm" value="${itemToEdit.quantity}" min="1">
                    <select id="edit-city-tag-${itemId}" class="form-input p-2 rounded-md text-sm">
                        <!-- Populated dynamically -->
                    </select>
                    <input type="url" id="edit-file-url-${itemId}" class="form-input p-2 rounded-md text-sm" value="${itemToEdit.fileUrl || ''}" placeholder="Link Allegato (URL)">
                    <div class="flex gap-2 mt-2">
                        <button data-id="${itemId}" class="save-edit-btn flex-1 bg-green-600 hover:bg-green-700 text-white p-2 rounded-md transition-colors duration-200">Salva</button>
                        <button data-id="${itemId}" class="cancel-edit-btn flex-1 bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md transition-colors duration-200">Annulla</button>
                    </div>
                </div>
            `;

            // Populate city tag dropdown for the edit form
            const editCityTagSelect = document.getElementById(`edit-city-tag-${itemId}`);
            editCityTagSelect.innerHTML = ''; // Clear existing options
            const uniqueCities = new Set();
            tripData.forEach(day => {
                const city = day.location.split('/')[0].trim();
                if (city && city !== "Volo di Ritorno") {
                    uniqueCities.add(city);
                }
            });

            const noneOption = document.createElement('option');
            noneOption.value = 'None';
            noneOption.textContent = 'Nessuna città specifica';
            editCityTagSelect.appendChild(noneOption);

            const allOption = document.createElement('option');
            allOption.value = 'All';
            allOption.textContent = 'Tutte le città';
            editCityTagSelect.appendChild(allOption);

            Array.from(uniqueCities).sort().forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                editCityTagSelect.appendChild(option);
            });
            editCityTagSelect.value = itemToEdit.cityTag || 'None'; // Set selected value

            listItem.querySelector(`.save-edit-btn`).onclick = () => saveEditedBackpackItem(itemId);
            listItem.querySelector(`.cancel-edit-btn`).onclick = () => cancelEditBackpackItem(itemId);
            lucide.createIcons();
        }

        async function saveEditedBackpackItem(itemId) {
            const nameInput = document.getElementById(`edit-name-${itemId}`);
            const typeSelect = document.getElementById(`edit-type-${itemId}`);
            const quantityInput = document.getElementById(`edit-quantity-${itemId}`);
            const cityTagSelect = document.getElementById(`edit-city-tag-${itemId}`);
            const fileUrlInput = document.getElementById(`edit-file-url-${itemId}`);

            const newName = nameInput.value.trim();
            const newType = typeSelect.value;
            const newQuantity = parseInt(quantityInput.value, 10);
            const newCityTag = cityTagSelect.value;
            const newFileUrl = fileUrlInput.value.trim();

            if (newName && newType && !isNaN(newQuantity) && newQuantity > 0) {
                const itemRef = doc(db, "backpacks", currentBackpackUser, "items", itemId);
                await updateDoc(itemRef, {
                    name: newName,
                    type: newType,
                    quantity: newQuantity,
                    cityTag: newCityTag,
                    fileUrl: newFileUrl
                });
                cancelEditBackpackItem(itemId); // Exit edit mode
            } else {
                console.warn("Dati oggetto zaino non validi.");
            }
        }

        function cancelEditBackpackItem(itemId) {
            const listItem = document.querySelector(`li[data-id="${itemId}"]`);
            const displayDiv = listItem.querySelector(`#item-display-${itemId}`);
            const editDiv = listItem.querySelector(`#item-edit-${itemId}`);
            const editButton = listItem.querySelector(`.edit-item-btn`);
            const deleteButton = listItem.querySelector(`.delete-item-btn`);

            listItem.dataset.editing = 'false';
            displayDiv.classList.remove('hidden');
            editDiv.classList.add('hidden');
            editButton.classList.remove('hidden');
            deleteButton.classList.remove('hidden');
            editDiv.innerHTML = ''; // Clear edit form content
        }

        // Funzione per cambiare lo zaino attivo
        function switchBackpack(user) {
            currentBackpackUser = user;
            // Rimuovi la classe di evidenziazione da entrambi i pulsanti
            document.getElementById('select-pino-backpack-btn').classList.remove('scale-105', 'ring-2', 'ring-blue-400', 'ring-offset-2', 'ring-offset-gray-900', 'z-10');
            document.getElementById('select-pina-backpack-btn').classList.remove('scale-105', 'ring-2', 'ring-amber-400', 'ring-offset-2', 'ring-offset-gray-900', 'z-10');

            // Aggiungi la classe di evidenziazione al pulsante selezionato
            const selectedButton = document.getElementById(`select-${user}-backpack-btn`);
            if (user === 'pino') {
                selectedButton.classList.add('scale-105', 'ring-2', 'ring-blue-400', 'ring-offset-2', 'ring-offset-gray-900', 'z-10');
            } else {
                selectedButton.classList.add('scale-105', 'ring-2', 'ring-amber-400', 'ring-offset-2', 'ring-offset-gray-900', 'z-10');
            }
            
            document.getElementById('current-backpack-name').textContent = user === 'pino' ? 'Zaino di Pino' : 'Zaino di Pina';

            // Aggiorna l'immagine dello zaino
            const backpackImageEl = document.getElementById('backpack-image');
            if (backpackImageEl) {
                backpackImageEl.src = user === 'pino' ? 'images/zaino_pino.png' : 'images/zaino_pina.png';
                backpackImageEl.alt = user === 'pino' ? 'Zaino di Pino' : 'Zaino di Pina';
            }

            // Apply theme class to backpack-view
            const backpackViewEl = document.getElementById('backpack-view');
            backpackViewEl.classList.remove('backpack-theme-pino', 'backpack-theme-pina');
            backpackViewEl.classList.add(`backpack-theme-${user}`);

            loadAndDisplayBackpackItems(); // Reload items for the new backpack

            // If currently on day detail view, re-render backpack widget for today
            if (!dayDetailView.classList.contains('hidden') && currentActiveDate) {
                const dayData = tripData.find(d => d.date === currentActiveDate);
                if (dayData) {
                    renderTodaysBackpackItems(dayData.location.split('/')[0].trim());
                }
            }
        }

        // Funzione per popolare la tendina delle città
        function populateCityTagDropdown() {
            const cityTagSelect = document.getElementById('backpack-item-city-tag');
            cityTagSelect.innerHTML = ''; // Clear existing options

            const uniqueCities = new Set();
            tripData.forEach(day => {
                const city = day.location.split('/')[0].trim();
                if (city && city !== "Volo di Ritorno") { // Exclude "Volo di Ritorno" and empty strings
                    uniqueCities.add(city);
                }
            });

            // Add default options
            const noneOption = document.createElement('option');
            noneOption.value = 'None';
            noneOption.textContent = 'Nessuna città specifica';
            cityTagSelect.appendChild(noneOption);

            const allOption = document.createElement('option');
            allOption.value = 'All';
            allOption.textContent = 'Tutte le città';
            cityTagSelect.appendChild(allOption);

            // Add unique cities
            Array.from(uniqueCities).sort().forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                cityTagSelect.appendChild(option);
            });
        }

        // Funzione per filtrare gli oggetti dello zaino
        function filterBackpackItems(type) {
            currentBackpackFilter = type;
            // Rimuovi la classe di evidenziazione da tutti i pulsanti di filtro
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-red-500', 'ring-2', 'ring-red-300'); // Changed from purple
            });
            // Aggiungi la classe di evidenziazione al pulsante selezionato
            const selectedFilterBtn = document.getElementById(`filter-${type.toLowerCase().replace(/\s/g, '-')}-btn`);
            selectedFilterBtn.classList.add('bg-red-500', 'ring-2', 'ring-red-300'); // Changed from purple
            
            // Apply backpack theme highlight to the filter button if a theme is active
            const backpackViewEl = document.getElementById('backpack-view');
            if (backpackViewEl.classList.contains('backpack-theme-pino')) {
                selectedFilterBtn.classList.add('bg-blue-500', 'ring-blue-300');
                selectedFilterBtn.classList.remove('bg-red-500', 'ring-red-300');
            } else if (backpackViewEl.classList.contains('backpack-theme-pina')) {
                selectedFilterBtn.classList.add('bg-amber-500', 'ring-amber-300');
                selectedFilterBtn.classList.remove('bg-red-500', 'ring-red-300');
            }

            loadAndDisplayBackpackItems(); // Ricarica gli oggetti con il filtro applicato
        }

        // Funzione per visualizzare gli oggetti dello zaino per il giorno corrente
        async function renderTodaysBackpackItems(currentLocation) {
            const todaysBackpackEl = document.getElementById('todays-backpack-widget');
            todaysBackpackEl.innerHTML = '<div class="text-gray-400">Caricamento oggetti dello zaino...</div>';

            console.log("Rendering Todays Backpack Items for location:", currentLocation);

            // Fetch items for both Pino and Pina's backpacks
            const pinoItemsSnapshot = await getDocs(collection(db, "backpacks", "pino", "items"));
            const pinaItemsSnapshot = await getDocs(collection(db, "backpacks", "pina", "items"));

            let allItems = [];
            pinoItemsSnapshot.forEach(doc => allItems.push({ id: doc.id, user: 'pino', ...doc.data() }));
            pinaItemsSnapshot.forEach(doc => allItems.push({ id: doc.id, user: 'pina', ...doc.data() }));

            console.log("All backpack items fetched:", allItems);

            const relevantItems = allItems.filter(item => {
                const isRelevant = item.inBackpack && (item.cityTag === currentLocation || item.cityTag === 'All');
                if (!isRelevant) {
                    console.log(`Item "${item.name}" (inBackpack: ${item.inBackpack}, cityTag: ${item.cityTag}) not relevant for "${currentLocation}"`);
                }
                return isRelevant;
            });

            console.log("Relevant backpack items for today:", relevantItems);


            if (relevantItems.length === 0) {
                todaysBackpackEl.innerHTML = '<div class="text-gray-400">Nessun oggetto utile per oggi.</div>';
            } else {
                todaysBackpackEl.innerHTML = ''; // Clear loading message
                relevantItems.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex items-start gap-3 bg-gray-700/30 p-3 rounded-lg text-sm mb-2';
                    let content = `<div class="font-medium text-white">${item.name} (${item.quantity})</div>`;
                    if (item.type) content += `<div class="text-red-300 text-xs">${item.type}</div>`;
                    // Aggiungi l'indicazione dello zaino (Pino/Pina)
                    content += `<div class="text-gray-500 text-xs mt-1">Zaino: ${item.user === 'pino' ? 'Pino' : 'Pina'}</div>`;
                    if (item.fileUrl) {
                        const fileExtension = item.fileUrl.split('.').pop().toLowerCase();
                        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension)) {
                            content += `<img src="${item.fileUrl}" alt="${item.name}" class="w-24 h-auto rounded-md mt-2 object-cover">`;
                        } else if (fileExtension === 'pdf') {
                            content += `<a href="${item.fileUrl}" target="_blank" class="text-blue-400 hover:underline text-xs block mt-2">Apri PDF <i data-lucide="file-text" class="w-3 h-3 inline-block"></i></a>`;
                        } else {
                            content += `<a href="${item.fileUrl}" target="_blank" class="text-blue-400 hover:underline text-xs block mt-2">Apri Allegato <i data-lucide="external-link" class="w-3 h-3 inline-block"></i></a>`;
                        }
                    }
                    itemDiv.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 text-green-400 mt-1 flex-shrink-0"></i><div>${content}</div>`;
                    todaysBackpackEl.appendChild(itemDiv);
                });
            }
            lucide.createIcons(); // Re-create icons for dynamically added content
        }

        // =================================================================================
        // GOOGLE MAPS & PINNED PLACES FUNCTIONS
        // =================================================================================

        // Funzione di callback per l'API di Google Maps
        window.initMap = function() {
            console.log("Google Maps API loaded and initMap called.");
            const mapOptions = {
                center: { lat: cityCoordinates.Tokyo.latitude, lng: cityCoordinates.Tokyo.longitude },
                zoom: cityCoordinates.Tokyo.zoom,
                mapId: 'DEMO_MAP_ID' // You can create a Map ID in Google Cloud Console
            };
            map = new google.maps.Map(document.getElementById('map'), mapOptions);

            // Add a click listener to the map to get coordinates for adding a new place
            map.addListener('click', (e) => {
                document.getElementById('pinned-place-name').value = ''; // Clear name
                document.getElementById('pinned-place-lat').value = e.latLng.lat().toFixed(6);
                document.getElementById('pinned-place-lng').value = e.latLng.lng().toFixed(6);
                showCustomAlert(`Coordinate selezionate: Lat ${e.latLng.lat().toFixed(6)}, Lng ${e.latLng.lng().toFixed(6)}`);
            });

            // Load pinned places for the initially selected city
            loadAndDisplayPinnedPlaces(currentMapCity);
        };

        // Function to dynamically load Google Maps API script
        async function loadGoogleMapsScript() {
            if (googleMapsApiLoaded) {
                console.log("Google Maps API already loaded.");
                // If API is already loaded, just re-initialize map if needed
                if (map) {
                    const coords = cityCoordinates[currentMapCity] || cityCoordinates.default;
                    map.setCenter({ lat: coords.latitude, lng: coords.longitude });
                    map.setZoom(coords.zoom);
                } else {
                    // This case should ideally not happen if googleMapsApiLoaded is true,
                    // but as a fallback, call initMap directly.
                    window.initMap();
                }
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/getGoogleMapsApiKey');
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`Errore nel recupero della chiave API di Google Maps: ${errorBody.message || 'Errore sconosciuto'}`);
                }
                const data = await response.json();
                const apiKey = data.apiKey;

                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
                googleMapsApiLoaded = true; // Set flag to true once script is appended
                console.log("Google Maps API script appended to head.");

            } catch (error) {
                console.error("Errore nel caricamento dell'API di Google Maps:", error);
                showCustomAlert(`Errore nel caricamento della mappa: ${error.message}.`);
            }
        }


        // Popola la dropdown delle città per la mappa
        function populateMapCityDropdown() {
            const mapCitySelect = document.getElementById('map-city-select');
            mapCitySelect.innerHTML = ''; // Clear existing options

            const uniqueCities = new Set();
            tripData.forEach(day => {
                const city = day.location.split('/')[0].trim();
                if (city && city !== "Volo di Ritorno") {
                    uniqueCities.add(city);
                }
            });

            Array.from(uniqueCities).sort().forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                mapCitySelect.appendChild(option);
            });

            // Set the current selected city in the dropdown
            mapCitySelect.value = currentMapCity;
        }

        // Cambia la città sulla mappa
        function changeMapCity() {
            const selectedCity = document.getElementById('map-city-select').value;
            currentMapCity = selectedCity;
            const coords = cityCoordinates[selectedCity] || cityCoordinates.default;
            if (map) {
                map.setCenter({ lat: coords.latitude, lng: coords.longitude });
                map.setZoom(coords.zoom);
            }
            loadAndDisplayPinnedPlaces(currentMapCity);
            clearSearchInputs(); // Clear search inputs and results
            clearPinnedPlaceForm(); // Clear pinned place form
        }

        // Ottieni la posizione attuale e centra la mappa
        function getGeolocationForMap() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const radiusKm = parseFloat(document.getElementById('radius-input').value) || 5; // Default 5km
                        const zoom = calculateZoomFromRadius(radiusKm); // Calculate zoom based on radius

                        if (map) {
                            map.setCenter({ lat: lat, lng: lng });
                            map.setZoom(zoom);
                            // Set coordinates in the add new place form
                            document.getElementById('pinned-place-name').value = 'Posizione Attuale';
                            document.getElementById('pinned-place-lat').value = lat.toFixed(6);
                            document.getElementById('pinned-place-lng').value = lng.toFixed(6);
                        }
                        showCustomAlert(`Mappa centrata sulla tua posizione attuale. Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`);
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        showCustomAlert("Impossibile ottenere la tua posizione. Assicurati che la geolocalizzazione sia abilitata.");
                    }
                );
            } else {
                showCustomAlert("La geolocalizzazione non è supportata dal tuo browser.");
            }
        }

        // Helper function to calculate zoom level based on radius (approximate)
        function calculateZoomFromRadius(radiusKm) {
            // This is a rough approximation. Google Maps API has more precise ways.
            // A smaller radius means a higher zoom level.
            // Example: 1km radius -> zoom 15-16, 10km radius -> zoom 11-12
            if (radiusKm <= 1) return 15;
            if (radiusKm <= 5) return 13;
            if (radiusKm <= 10) return 11;
            if (radiusKm <= 20) return 10;
            return 9; // For larger radii
        }


        // Carica e visualizza i luoghi pinnati per la città selezionata
        function loadAndDisplayPinnedPlaces(city) {
            const pinnedPlacesListEl = document.getElementById('pinned-places-list');
            pinnedPlacesListEl.innerHTML = '<li class="text-gray-400">Caricamento luoghi pinnati...</li>';
            document.getElementById('current-map-city-display').textContent = city; // Update city display

            if (pinnedPlacesUnsubscribe) pinnedPlacesUnsubscribe(); // Unsubscribe from previous listener

            const pinnedPlacesQuery = query(collection(db, "pinned-places"), where("city", "==", city));
            pinnedPlacesUnsubscribe = onSnapshot(pinnedPlacesQuery, (snapshot) => {
                pinnedPlacesListEl.innerHTML = '';
                clearMapMarkers(); // Clear existing markers before adding new ones
                let places = [];
                snapshot.forEach(doc => places.push({ id: doc.id, ...doc.data() }));

                if (places.length === 0) {
                    pinnedPlacesListEl.innerHTML = '<li class="text-gray-400">Nessun luogo pinnato per questa città.</li>';
                } else {
                    places.forEach(place => {
                        const li = document.createElement('li');
                        li.className = 'bg-gray-700/30 p-3 rounded-lg text-sm mb-2 flex justify-between items-center hover-shadow-effect';
                        li.innerHTML = `
                            <div>
                                <span class="font-semibold text-white">${place.name}</span>
                                <span class="text-gray-400 block text-xs">Lat: ${place.latitude.toFixed(4)}, Lng: ${place.longitude.toFixed(4)}</span>
                                <span class="text-red-300 text-xs block">${place.tag}</span>
                                ${place.reservationDate ? `<span class="text-blue-300 text-xs block">Prenotazione: ${place.reservationDate} ${place.reservationTime || ''}</span>` : ''}
                                ${place.notes ? `<p class="text-gray-400 text-xs mt-1">${place.notes}</p>` : ''}
                            </div>
                            <button data-id="${place.id}" class="delete-pinned-place-btn ml-4 p-2 rounded-full bg-red-600 hover:bg-red-700 text-white transition-colors duration-200">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        `;
                        pinnedPlacesListEl.appendChild(li);

                        // Add marker to map
                        addMapMarker(place.latitude, place.longitude, place.name, place.notes);
                    });
                }
                lucide.createIcons();
            });
        }

        // Aggiungi un marker alla mappa
        function addMapMarker(lat, lng, title, snippet = '', icon = null) {
            if (!map) return;
            const markerOptions = {
                position: { lat: lat, lng: lng },
                map: map,
                title: title
            };
            if (icon) {
                markerOptions.icon = icon;
            }
            const marker = new google.maps.Marker(markerOptions);

            const infoWindow = new google.maps.InfoWindow({
                content: `<strong>${title}</strong><p>${snippet}</p>`
            });

            marker.addListener('click', () => {
                infoWindow.open(map, marker);
            });
            mapMarkers.push(marker);
        }

        // Pulisci tutti i marker dalla mappa
        function clearMapMarkers() {
            mapMarkers.forEach(marker => marker.setMap(null));
            mapMarkers = [];
        }


        // Salva un nuovo luogo pinnato
        async function savePinnedPlace() {
            const nameInput = document.getElementById('pinned-place-name');
            const latInput = document.getElementById('pinned-place-lat');
            const lngInput = document.getElementById('pinned-place-lng');
            const dateInput = document.getElementById('pinned-place-date');
            const timeInput = document.getElementById('pinned-place-time');
            const tagSelect = document.getElementById('pinned-place-tag');
            const notesInput = document.getElementById('pinned-place-notes');

            const name = nameInput.value.trim();
            const latitude = parseFloat(latInput.value);
            const longitude = parseFloat(lngInput.value);
            const reservationDate = dateInput.value.trim();
            const reservationTime = timeInput.value.trim();
            const tag = tagSelect.value;
            const notes = notesInput.value.trim();

            if (name && !isNaN(latitude) && !isNaN(longitude) && currentMapCity) {
                await addDoc(collection(db, "pinned-places"), {
                    city: currentMapCity,
                    name: name,
                    latitude: latitude,
                    longitude: longitude,
                    reservationDate: reservationDate || null,
                    reservationTime: reservationTime || null,
                    tag: tag,
                    notes: notes || null,
                    createdAt: new Date()
                });
                clearPinnedPlaceForm(); // Clear form after saving
                showCustomAlert('Luogo pinnato aggiunto con successo!');
            } else {
                showCustomAlert('Per favorire, compila tutti i campi obbligatori (Nome, Latitudine, Longitudine) e seleziona una città.');
            }
        }

        // Elimina un luogo pinnato
        async function deletePinnedPlace(id) {
            if (await showCustomConfirm("Sei sicuro di voler eliminare questo luogo pinnato?")) {
                const placeRef = doc(db, "pinned-places", id);
                await deleteDoc(placeRef);
                showCustomAlert('Luogo pinnato eliminato.');
            }
        }

        // Funzione per cercare luoghi tramite Google Places API
        async function searchPlaces() {
            const queryInput = document.getElementById('search-query-input');
            const resultsList = document.getElementById('search-results-list');
            const queryText = queryInput.value.trim();

            if (!queryText) {
                showCustomAlert("Per favore, inserisci un termine di ricerca.");
                return;
            }

            resultsList.innerHTML = '<li class="text-gray-400">Ricerca in corso...</li>';
            clearMapMarkers(); // Clear existing markers

            // Get current map center for biasing search
            const mapCenter = map.getCenter();
            const lat = mapCenter.lat();
            const lng = mapCenter.lng();

            try {
                const response = await fetch('/.netlify/functions/searchPlaces', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: queryText, latitude: lat, longitude: lng })
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`Errore nella ricerca luoghi: ${errorBody.message || 'Errore sconosciuto'}`);
                }

                const data = await response.json();
                const places = data.results;

                resultsList.innerHTML = '';
                if (places.length === 0) {
                    resultsList.innerHTML = '<li class="text-gray-400">Nessun risultato trovato.</li>';
                } else {
                    places.forEach(place => {
                        const li = document.createElement('li');
                        li.className = 'bg-gray-700/30 p-3 rounded-lg text-sm mb-2 cursor-pointer hover-shadow-effect';
                        li.textContent = place.name + (place.vicinity ? ` (${place.vicinity})` : '');
                        li.dataset.name = place.name;
                        li.dataset.lat = place.geometry.location.lat;
                        li.dataset.lng = place.geometry.location.lng;
                        li.dataset.address = place.vicinity || place.formatted_address || '';
                        li.dataset.type = place.types && place.types.includes('restaurant') ? 'Ristorante' : 'Attrazione'; // Basic type inference

                        li.addEventListener('click', (e) => {
                            document.getElementById('pinned-place-name').value = e.target.dataset.name;
                            document.getElementById('pinned-place-lat').value = e.target.dataset.lat;
                            document.getElementById('pinned-place-lng').value = e.target.dataset.lng;
                            document.getElementById('pinned-place-tag').value = e.target.dataset.type;
                            document.getElementById('pinned-place-notes').value = `Indirizzo: ${e.target.dataset.address}`;
                            showCustomAlert(`Modulo precompilato con ${e.target.dataset.name}.`);
                        });
                        resultsList.appendChild(li);

                        // Add marker for search result
                        addMapMarker(place.geometry.location.lat, place.geometry.location.lng, place.name, place.vicinity || place.formatted_address);
                    });
                }
                lucide.createIcons();
            } catch (error) {
                console.error("Search places error:", error);
                resultsList.innerHTML = `<li class="text-red-400">Errore nella ricerca: ${error.message}</li>`;
            }
        }

        // Funzione per caricare e visualizzare le prenotazioni del giorno corrente
        function loadAndDisplayTodaysReservations(dateString) {
            const reservationsListEl = document.getElementById('todays-reservations-list');
            reservationsListEl.innerHTML = '<li class="text-gray-400">Caricamento prenotazioni...</li>';

            if (currentDayUnsubscribeReservations) currentDayUnsubscribeReservations(); // Disiscrivi dal listener precedente

            const reservationsQuery = query(
                collection(db, "pinned-places"),
                where("reservationDate", "==", dateString)
            );

            currentDayUnsubscribeReservations = onSnapshot(reservationsQuery, (snapshot) => {
                reservationsListEl.innerHTML = '';
                let reservations = [];
                snapshot.forEach(doc => reservations.push(doc.data()));
                // Ordina le prenotazioni per ora se disponibile
                reservations.sort((a, b) => {
                    const timeA = a.reservationTime || '00:00';
                    const timeB = b.reservationTime || '00:00';
                    return timeA.localeCompare(timeB);
                });

                if (reservations.length === 0) {
                    reservationsListEl.innerHTML = '<li class="text-gray-400">Nessuna prenotazione per oggi.</li>';
                } else {
                    reservations.forEach(res => {
                        const li = document.createElement('li');
                        li.className = 'bg-blue-400/10 text-blue-200 p-3 rounded-lg text-sm mb-2';
                        li.innerHTML = `
                            <div class="font-semibold text-white">${res.name}</div>
                            <div class="text-gray-300 text-xs">${res.tag}</div>
                            ${res.reservationTime ? `<div class="text-blue-300 text-xs">Ora: ${res.reservationTime}</div>` : ''}
                            ${res.notes ? `<p class="text-gray-400 text-xs mt-1">${res.notes}</p>` : ''}
                        `;
                        reservationsListEl.appendChild(li);
                    });
                }
                lucide.createIcons();
            });
        }

        // Funzione per pulire tutti gli input e i risultati della sezione Mappa
        function clearMapInputs() {
            clearSearchInputs();
            clearPinnedPlaceForm();
            clearMapMarkers(); // Clear markers when leaving map view
        }

        // Funzione per pulire gli input di ricerca e i risultati
        function clearSearchInputs() {
            document.getElementById('search-query-input').value = '';
            document.getElementById('search-results-list').innerHTML = '<li class="text-gray-400">Nessun risultato di ricerca.</li>';
        }

        // Funzione per pulire il modulo di aggiunta luogo pinnato
        function clearPinnedPlaceForm() {
            document.getElementById('pinned-place-name').value = '';
            document.getElementById('pinned-place-lat').value = '';
            document.getElementById('pinned-place-lng').value = '';
            document.getElementById('pinned-place-date').value = '';
            document.getElementById('pinned-place-time').value = '';
            document.getElementById('pinned-place-tag').value = 'Attrazione';
            document.getElementById('pinned-place-notes').value = '';
        }


        // Custom alert/modal implementation (since alert() is forbidden)
        function showCustomAlert(message) {
            const alertModal = document.getElementById('custom-alert-modal');
            const alertMessage = document.getElementById('custom-alert-message');
            const alertCloseBtn = document.getElementById('custom-alert-close-btn');

            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
            alertModal.classList.add('flex'); // Use flex to center

            alertCloseBtn.onclick = () => {
                alertModal.classList.add('hidden');
                alertModal.classList.remove('flex');
            };
        }

        // Custom confirm modal implementation (since confirm() is forbidden)
        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                const confirmModal = document.getElementById('custom-confirm-modal');
                const confirmMessage = document.getElementById('custom-confirm-message');
                const confirmYesBtn = document.getElementById('custom-confirm-yes-btn');
                const confirmNoBtn = document.getElementById('custom-confirm-no-btn');

                confirmMessage.textContent = message;
                confirmModal.classList.remove('hidden');
                confirmModal.classList.add('flex');

                const cleanup = () => {
                    confirmModal.classList.add('hidden');
                    confirmModal.classList.remove('flex');
                    confirmYesBtn.onclick = null;
                    confirmNoBtn.onclick = null;
                };

                confirmYesBtn.onclick = () => {
                    cleanup();
                    resolve(true);
                };

                confirmNoBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };
            });
        }


        // Inizializza la tastiera in italiano all'avvio
        document.addEventListener('DOMContentLoaded', () => {
            translateInputIt.lang = 'it';
            translateInputIt.placeholder = 'Scrivi qui in Italiano...';
            // Imposta l'inputmode iniziale se desiderato
            // translateInputIt.inputmode = 'text';
            // Imposta il testo iniziale del pulsante
            document.getElementById('toggle-keyboard-btn').innerHTML = '<i data-lucide="keyboard" class="w-4 h-4"></i><span class="hidden sm:inline">Tastiera: Italiano</span>';
            
            // Aggiungi listener per il pulsante "Aggiungi Oggetto" dello zaino
            document.getElementById('add-backpack-item-btn').onclick = saveBackpackItem;

            // Inizializza i pulsanti per la selezione dello zaino
            document.getElementById('select-pino-backpack-btn').onclick = () => switchBackpack('pino');
            document.getElementById('select-pina-backpack-btn').onclick = () => switchBackpack('pina');
            
            // Imposta il nome dello zaino iniziale e seleziona il pulsante di Pino
            document.getElementById('current-backpack-name').textContent = currentBackpackUser === 'pino' ? 'Zaino di Pino' : 'Zaino di Pina';
            // Initial theme application
            document.getElementById('backpack-view').classList.add(`backpack-theme-${currentBackpackUser}`);
            document.getElementById('select-pino-backpack-btn').classList.add('scale-105', 'ring-2', 'ring-blue-400', 'ring-offset-2', 'ring-offset-gray-900', 'z-10');

            // Set initial backpack image
            const backpackImageEl = document.getElementById('backpack-image');
            if (backpackImageEl) {
                backpackImageEl.src = currentBackpackUser === 'pino' ? 'images/zaino_pino.png' : 'images/zaino_pina.png';
                backpackImageEl.alt = currentBackpackUser === 'pino' ? 'Zaino di Pino' : 'Zaino di Pina';
            }


            // Inizializza i filtri dello zaino
            document.getElementById('filter-tutti-btn').onclick = () => filterBackpackItems('Tutti');
            document.getElementById('filter-abbigliamento-btn').onclick = () => filterBackpackItems('Abbigliamento');
            document.getElementById('filter-elettronica-btn').onclick = () => filterBackpackItems('Elettronica');
            document.getElementById('filter-igiene-personale-btn').onclick = () => filterBackpackItems('Igiene Personale');
            document.getElementById('filter-documenti-btn').onclick = () => filterBackpackItems('Documenti');
            document.getElementById('filter-farmaci-btn').onclick = () => filterBackpackItems('Farmaci');
            document.getElementById('filter-varie-btn').onclick = () => filterBackpackItems('Varie');

            // Applica il filtro iniziale "Tutti"
            filterBackpackItems('Tutti'); // This will also apply the correct theme highlight


            lucide.createIcons();

            // Aggiungi listener per gli eventi touch allo day-content-wrapper
            const dayContentWrapper = document.getElementById('day-content-wrapper');
            if (dayContentWrapper) {
                dayContentWrapper.addEventListener('touchstart', (e) => {
                    touchStartX = e.touches[0].clientX;
                });

                dayContentWrapper.addEventListener('touchmove', (e) => {
                    // Prevent default scrolling only if a horizontal swipe is detected
                    if (Math.abs(e.touches[0].clientX - touchStartX) > 10) { // Small threshold to differentiate from vertical scroll
                        e.preventDefault();
                    }
                }, { passive: false }); // Use passive: false to allow preventDefault

                dayContentWrapper.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].clientX;
                    handleSwipe();
                });
            }

            // Listener per il pulsante di importazione JSON
            const importJsonBtn = document.getElementById('import-json-btn');
            const importJsonInput = document.getElementById('import-json-input');

            if (importJsonBtn && importJsonInput) {
                importJsonBtn.addEventListener('click', () => {
                    importJsonInput.click(); // Trigger click on hidden file input
                });

                importJsonInput.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            try {
                                const jsonData = JSON.parse(e.target.result);
                                if (Array.isArray(jsonData)) {
                                    await importItineraryFromJson(jsonData);
                                    showCustomAlert('Itinerario importato con successo!');
                                } else {
                                    showCustomAlert('Errore: Il file JSON non contiene un array di giorni valido.');
                                }
                            } catch (error) {
                                console.error("Errore durante la lettura o il parsing del JSON:", error);
                                showCustomAlert('Errore durante l\'importazione del file JSON. Assicurati che sia un formato valido.');
                            }
                        };
                        reader.readAsText(file);
                    }
                });
            }

            // Map specific event listeners
            document.getElementById('map-city-select').addEventListener('change', changeMapCity);
            document.getElementById('get-location-btn').addEventListener('click', getGeolocationForMap);
            document.getElementById('save-pinned-place-btn').addEventListener('click', savePinnedPlace);
            document.getElementById('search-places-btn').addEventListener('click', searchPlaces); // New search button listener
            document.getElementById('clear-search-btn').addEventListener('click', clearSearchInputs); // New clear search button listener
            document.getElementById('clear-pinned-place-form-btn').addEventListener('click', clearPinnedPlaceForm); // New clear pinned place form button

            // Event delegation for delete buttons on pinned places list
            document.getElementById('pinned-places-list').addEventListener('click', (e) => {
                if (e.target.closest('.delete-pinned-place-btn')) {
                    const id = e.target.closest('.delete-pinned-place-btn').dataset.id;
                    deletePinnedPlace(id);
                }
            });
        });

        // Funzione per importare l'itinerario da un array JSON
        async function importItineraryFromJson(data) {
            const batch = writeBatch(db);
            const itineraryCollectionRef = collection(db, "itinerary");

            // Per semplicità, questa implementazione sovrascrive i giorni esistenti
            // e aggiunge nuovi giorni. Non elimina i giorni che non sono nel JSON.
            data.forEach(day => {
                // Usiamo la data come ID del documento per facilitare l'aggiornamento
                const dayRef = doc(itineraryCollectionRef, day.date);
                batch.set(dayRef, day, { merge: true }); // merge: true per non sovrascrivere interamente il documento se ci sono campi extra
            });

            try {
                await batch.commit();
                console.log("Itinerario aggiornato da JSON con successo.");
                loadItineraryAndInitApp(); // Ricarica l'itinerario per aggiornare la vista
            } catch (error) {
                console.error("Errore durante l'aggiornamento di Firestore da JSON:", error);
                throw error; // Rilancia l'errore per gestirlo nel chiamante
            }
        }

        function handleSwipe() {
            const deltaX = touchEndX - touchStartX;
            const currentIndex = tripData.findIndex(d => d.date === currentActiveDate);

            if (Math.abs(deltaX) > swipeThreshold) {
                if (deltaX > 0) { // Swipe right (previous day)
                    if (currentIndex > 0) {
                        navigateDay(currentIndex - 1);
                    }
                } else { // Swipe left (next day)
                    if (currentIndex < tripData.length - 1) {
                        navigateDay(currentIndex + 1);
                    }
                }
            }
        }

    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f8f8f8; padding-top: 64px; } /* Changed to dark background */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; } /* Dark scrollbar track */
        ::-webkit-scrollbar-thumb { background: #ef4444; border-radius: 4px; } /* Red scrollbar thumb */
        ::-webkit-scrollbar-thumb:hover { background: #dc2626; } /* Darker red on hover */

        /* General dark components on dark background - adjusted text colors */
        .bg-gray-800 {
            background-color: #2d3748; /* Dark blue-gray for components */
            color: #f8f8f8; /* Light text inside dark components */
        }
        .bg-gray-700\/50 {
            background-color: rgba(45, 55, 72, 0.5); /* Semi-transparent dark for table header */
        }
        .border-gray-700 {
            border-color: #4a5568;
        }
        .text-gray-300 {
            color: #cbd5e0; /* Lighter gray for secondary text inside dark components */
        }
        .text-gray-400 {
            color: #a0aec0; /* Even lighter gray */
        }
        .text-gray-500 {
            color: #718096; /* For dimming past days */
        }
        .text-white {
            color: #f8f8f8; /* Ensure white text inside dark components */
        }

        /* Form inputs */
        .form-input {
            background-color: #4a5568; /* Darker input background */
            border-color: #6a768f;
            color: #f8f8f8;
        }
        .form-input:focus {
            --tw-ring-color: #ef4444; /* Red focus ring */
            border-color: #ef4444;
        }

        /* Buttons - Main Red Theme */
        .bg-indigo-600, .bg-purple-600, .bg-yellow-600 { /* Changed to red for consistency */
            background-color: #ef4444; /* Red */
        }
        .hover\:bg-indigo-700:hover, .hover\:bg-purple-700:hover, .hover\:bg-yellow-700:hover {
            background-color: #dc2626; /* Darker red on hover */
        }
        .text-indigo-400 { /* For date in day detail */
            color: #ef4444; /* Red */
        }
        .text-red-300 { /* For item type in backpack */
            color: #f87171; /* Lighter red */
        }
        .text-red-400 { /* For error messages */
            color: #ef4444; /* Red */
        }
        .text-red-200 { /* For notes */
            color: #fca5a5; /* Even lighter red */
        }

        .bg-green-600 { /* Keep green for add expense */
            background-color: #22c55e;
        }
        .hover\:bg-green-700:hover {
            background-color: #16a34a;
        }
        .bg-blue-600 { /* Keep blue for current weather button */
            background-color: #3b82f6;
        }
        .hover\:bg-blue-700:hover {
            background-color: #2563eb;
        }
        .bg-gray-600 { /* For keyboard toggle */
            background-color: #4a5568;
        }
        .hover\:bg-gray-700:hover {
            background-color: #2d3748;
        }
        .bg-gray-500 { /* For clear translation */
            background-color: #6a768f;
        }
        .hover\:bg-gray-600:hover {
            background-color: #4a5568;
        }


        /* Specific highlights */
        .bg-green-700\/30 { /* Current day highlight in itinerary table */
            background-color: rgba(239, 68, 68, 0.1); /* Light red transparent */
        }
        .border-green-500 { /* Border for current day highlight */
            border-color: #ef4444; /* Red border */
        }
        .text-green-400 { /* For checkmarks and ticket icons */
            color: #4ade80; /* Keep green */
        }
        .text-blue-400 { /* For links */
            color: #60a5fa; /* Keep blue */
        }

        /* Backpack specific themes */
        #backpack-view.backpack-theme-pino {
            /* Blue theme */
            --backpack-primary: #3b82f6; /* Blue 500 */
            --backpack-secondary: #2563eb; /* Blue 600 */
            --backpack-highlight: #60a5fa; /* Blue 400 */
            --backpack-text: #e0f2fe; /* Blue 100 */
        }

        #backpack-view.backpack-theme-pina {
            /* Yellow/Ochre theme */
            --backpack-primary: #d97706; /* Orange 700 (Ochre-like) */
            --backpack-secondary: #c2410c; /* Orange 800 */
            --backpack-highlight: #fbbf24; /* Amber 400 */
            --backpack-text: #fffbeb; /* Amber 50 */
        }

        /* Apply theme variables to backpack elements */
        #backpack-view .bg-purple-700 { /* Default for backpack buttons */
            background-color: var(--backpack-primary);
        }
        #backpack-view .hover\:bg-purple-800:hover {
            background-color: var(--backpack-secondary);
        }
        #backpack-view .text-purple-400 { /* Icons in backpack section */
            color: var(--backpack-highlight);
        }
        #backpack-view #current-backpack-name {
            color: var(--backpack-highlight);
        }
        
        /* Filter buttons styling */
        #backpack-view .filter-btn {
            background-color: var(--backpack-primary); /* Default to primary theme color */
            color: var(--backpack-text); /* Default to theme text color */
        }
        #backpack-view .filter-btn.bg-red-500 { /* Active filter button, overridden by theme if active */
            background-color: var(--backpack-highlight);
            box-shadow: 0 0 0 2px var(--backpack-highlight), 0 0 0 4px var(--backpack-secondary);
            border-color: transparent; /* Remove default border */
        }
        /* Specific ring colors for backpack select buttons */
        #select-pino-backpack-btn.ring-blue-400 {
            --tw-ring-color: #60a5fa; /* Blue highlight */
        }
        #select-pina-backpack-btn.ring-amber-400 {
            --tw-ring-color: #fbbf24; /* Amber highlight */
        }


        /* Backpack selection buttons highlighting */
        #select-pino-backpack-btn, #select-pina-backpack-btn {
            transition: all 0.3s ease-in-out;
            position: relative; /* Needed for z-index */
        }
        /* No specific ring-purple-400 anymore, using direct blue/amber */

        /* Animazioni per le transizioni di vista */
        .view-transition {
            transition: opacity 0.5s ease-in-out;
        }
        /* Animazioni per gli elementi al passaggio del mouse */
        .hover-scale-effect:hover {
            transform: scale(1.02);
            transition: transform 0.2s ease-in-out;
        }
        .hover-shadow-effect:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s ease-in-out;
        }
        /* Animazione di entrata per i widgets */
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Nuove animazioni per lo scorrimento dei giorni */
        .slide-left-out {
            animation: slideLeftOut 0.3s ease-out forwards;
        }
        .slide-right-in {
            animation: slideRightIn 0.3s ease-out forwards;
        }
        .slide-right-out {
            animation: slideRightOut 0.3s ease-out forwards;
        }
        .slide-left-in {
            animation: slideLeftIn 0.3s ease-out forwards;
        }

        @keyframes slideLeftOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-100%);
            }
        }

        @keyframes slideRightIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideRightOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        @keyframes slideLeftIn {
            from {
                opacity: 0;
                transform: translateX(-100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Map specific styles */
        #map {
            height: 400px; /* Fixed height for the map */
            width: 100%;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
        }
    </style>
</head>
<body class="text-gray-300"> <!-- Changed to text-gray-300 for general text on dark background -->

    <div id="login-container" class="w-full max-w-sm">
        <div class="bg-gray-800 shadow-2xl rounded-lg p-8 border border-gray-700">
            <h2 class="text-2xl font-bold text-center mb-6 text-white">Il Tuo Viaggio in Giappone</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-gray-400 text-sm font-bold mb-2">Email</label>
                    <input type="email" id="email" name="email" class="form-input shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:ring-2" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-400 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="password" name="password" class="form-input shadow appearance-none border rounded w-full py-2 px-3 mb-3 leading-tight focus:outline-none focus:ring-2" required>
                </div>
                <div id="login-error" class="text-red-400 text-xs italic mb-4 h-4"></div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                        Accedi
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="app-container" class="w-full h-full bg-gray-900 hidden"> <!-- Changed to bg-gray-900 -->
        <!-- Fixed Navigation Bar -->
        <nav class="fixed top-0 left-0 right-0 bg-gray-800 p-4 border-b border-gray-700 z-50 flex justify-between items-center shadow-lg">
            <div class="flex items-center gap-4">
                <button id="nav-itinerary-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200 flex items-center gap-2">
                    <i data-lucide="list-checks" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">Itinerario</span>
                </button>
                <button id="nav-backpack-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200 flex items-center gap-2">
                    <i data-lucide="backpack" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">Zaino</span>
                </button>
                <button id="nav-map-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200 flex items-center gap-2">
                    <i data-lucide="map" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">Mappa</span>
                </button>
            </div>
            <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200 flex items-center gap-2">
                <i data-lucide="log-out" class="w-4 h-4"></i>
                <span class="hidden sm:inline">Logout</span>
            </button>
        </nav>

        <!-- Home View -->
        <div id="home-view" class="view-transition opacity-0">
            <header class="p-4 sm:p-6 flex justify-center items-center flex-col sm:flex-row">
                <div class="text-center">
                    <h1 class="text-2xl sm:text-3xl font-bold text-white">Itinerario di Viaggio</h1>
                    <p class="text-gray-400">Giappone 2025</p>
                </div>
            </header>
            <main class="p-4 sm:p-6">
                <!-- Immagine di presentazione per la Home Page -->
                <img id="home-title-image" src="" alt="Immagine di presentazione" class="w-full max-w-3xl mx-auto aspect-video object-cover rounded-lg mb-6 shadow-md">

                <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden border border-gray-700">
                    <table class="w-full text-left">
                        <thead class="bg-gray-700/50">
                            <tr>
                                <th class="p-4 font-semibold text-white">Data</th>
                                <th class="p-4 font-semibold text-white">Luogo</th>
                                <th class="p-4 font-semibold text-white">Alloggio</th>
                                <th class="p-4"></th>
                            </tr>
                        </thead>
                        <tbody id="itinerary-table-body">
                            <!-- Le righe verranno popolate da JS -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-6 bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up hover-shadow-effect">
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white">
                        <i data-lucide="file-json" class="w-5 h-5 text-red-400"></i>Importa Itinerario da JSON
                    </h3>
                    <p class="text-gray-400 text-sm mb-4">Puoi aggiornare l'itinerario caricando un file JSON. I giorni esistenti verranno aggiornati, i nuovi giorni verranno aggiunti.</p>
                    <button id="import-json-btn" class="w-full bg-red-600 hover:bg-red-700 text-white p-2 rounded-md transition-colors duration-200">
                        Seleziona File JSON
                    </button>
                    <input type="file" id="import-json-input" accept=".json" class="hidden">
                </div>
            </main>
        </div>

        <!-- Day Detail View -->
        <div id="day-detail-view" class="view-transition opacity-0 hidden">
            <header class="p-4 sm:p-6 border-b border-gray-700 flex justify-center items-center relative">
                <button id="prev-day-btn" class="absolute left-4 p-2 rounded-full bg-transparent text-white transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-700/30">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </button>
                <div class="flex-grow text-center mx-10">
                    <h2 id="location" class="text-3xl font-bold text-white"></h2>
                    <p id="date" class="text-red-600"></p>
                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 justify-center items-center mt-2">
                        <div>
                            <div id="local-time" class="text-2xl font-semibold text-white"></div>
                            <p class="text-sm text-gray-400">Ora locale (Giappone)</p>
                        </div>
                        <div>
                            <div id="italian-local-time" class="text-2xl font-semibold text-white"></div>
                            <p class="text-sm text-gray-400">Ora locale (Italia)</p>
                        </div>
                    </div>
                </div>
                <button id="next-day-btn" class="absolute right-4 p-2 rounded-full bg-transparent text-white transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-700/30">
                    <i data-lucide="chevron-right" class="w-6 h-6"></i>
                </button>
            </header>
            <main class="p-4 sm:p-6">
                <!-- Immagine di presentazione per la pagina di dettaglio del giorno -->
                <img id="day-detail-title-image" src="" alt="Immagine del luogo" class="w-full max-w-3xl mx-auto aspect-video object-cover rounded-lg mb-6 shadow-md">

                <!-- Wrapper per il contenuto del giorno per le animazioni di scorrimento -->
                <div id="day-content-wrapper">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up hover-shadow-effect"><h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white"><i data-lucide="cloud-sun" class="w-5 h-5 text-red-400"></i>Meteo</h3><div id="weather-widget"></div><button id="current-location-weather-btn" class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-md transition-colors duration-200 flex items-center justify-center gap-2 text-sm">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span class="hidden sm:inline">Meteo attuale</span>
                            </button></div>
                        <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up hover-shadow-effect"><h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white"><i data-lucide="bed-double" class="w-5 h-5 text-red-400"></i>Alloggio</h3><div id="accommodation-widget"></div></div>
                        <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 lg:col-span-2 fade-in-up hover-shadow-effect"><h3 class="font-semibold text-lg mb-4 flex items-center gap-2 text-white"><i data-lucide="map" class="w-5 h-5 text-red-400"></i>Spostamenti ed Eventi</h3><div id="travel-events-widget" class="space-y-4"></div></div>
                        <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up hover-shadow-effect"><h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white"><i data-lucide="wallet" class="w-5 h-5 text-red-400"></i>Spese del Giorno</h3><ul id="expenses-list" class="space-y-2 mb-3 max-h-48 overflow-y-auto pr-2"></ul><div class="border-t border-gray-700 pt-3 mt-3 flex justify-between font-bold text-white"><span>Totale Giorno:</span><span id="total-expenses">0 ¥</span></div><div class="mt-4 flex gap-2"><input type="text" id="expense-description" placeholder="Descrizione" class="form-input w-2/3 p-2 border rounded-md text-sm"><input type="number" id="expense-amount" placeholder="Yen" class="form-input w-1/3 p-2 border rounded-md text-sm"></div><button id="save-expense-btn" class="mt-3 w-full bg-green-600 hover:bg-green-700 text-white p-2 rounded-md transition-colors duration-200">Aggiungi Spesa</button></div>
                        <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up hover-shadow-effect"><h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white"><i data-lucide="notebook-pen" class="w-5 h-5 text-red-400"></i>Appunti</h3><ul id="notes-list" class="space-y-2 mb-3 max-h-48 overflow-y-auto pr-2"></ul><textarea id="note-input" rows="2" class="form-input w-full p-2 border rounded-md text-sm" placeholder="Scrivi un appunto..."></textarea><button id="save-note-btn" class="mt-3 w-full bg-red-600 hover:bg-red-700 text-white p-2 rounded-md transition-colors duration-200">Salva Appunto</button></div>
                        
                        <!-- Nuova sezione: Prenotazioni di oggi -->
                        <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up hover-shadow-effect">
                            <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white">
                                <i data-lucide="calendar-check" class="w-5 h-5 text-blue-400"></i>Prenotazioni di oggi
                            </h3>
                            <ul id="todays-reservations-list" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                                <!-- Le prenotazioni verranno caricate qui da JS -->
                            </ul>
                        </div>

                        <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up hover-shadow-effect"><h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white"><i data-lucide="backpack" class="w-5 h-5 text-red-400"></i>Lo Zaino di Oggi</h3><div id="todays-backpack-widget" class="space-y-2"></div></div>
                        <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 lg:col-span-2 fade-in-up hover-shadow-effect"><h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white"><i data-lucide="languages" class="w-5 h-5 text-red-400"></i>Comunicazione</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="text-gray-300"><label class="text-sm font-medium">Italiano / Giapponese</label><textarea id="translate-input-it" rows="3" class="form-input w-full mt-1 p-2 border rounded-md" placeholder="Scrivi qui..." lang="it"></textarea></div><div><label class="text-sm font-medium">Traduzione</label><textarea id="translate-output-jp" rows="3" class="form-input w-full mt-1 p-2 border rounded-md" readonly placeholder="Traduzione..."></textarea></div></div><button id="translate-btn" class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white p-2 rounded-md transition-colors duration-200">Traduci</button><button id="toggle-keyboard-btn" class="mt-3 w-full bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-md transition-colors duration-200 flex items-center justify-center gap-2">
                            <i data-lucide="keyboard" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">Tastiera: Italiano</span>
                            </button>
                        <button id="clear-translation-btn" class="mt-2 w-full bg-gray-500 hover:bg-gray-600 text-white p-2 rounded-md transition-colors duration-200 flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="eraser" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">Pulisci</span>
                        </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Backpack View (New) -->
        <div id="backpack-view" class="view-transition opacity-0 hidden">
            <header class="p-4 sm:p-6 flex justify-center items-center flex-col sm:flex-row">
                <div class="text-center">
                    <h1 class="text-2xl sm:text-3xl font-bold text-white">Il Mio Zaino</h1>
                    <p class="text-gray-400">Gestisci gli oggetti per il viaggio</p>
                </div>
            </header>
            <main class="p-4 sm:p-6">
                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up hover-shadow-effect">
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white">
                        <i data-lucide="users" class="w-5 h-5 text-purple-400"></i>Seleziona Zaino: <span id="current-backpack-name" class="ml-2">Zaino di Pino</span>
                    </h3>
                    <div class="flex flex-col items-center gap-4 mb-4">
                        <img id="backpack-image" src="" alt="Immagine Zaino" class="w-12 h-12 object-contain rounded-md shadow-md">
                        <div class="flex gap-4 w-full">
                            <button id="select-pino-backpack-btn" class="flex-1 bg-purple-700 hover:bg-purple-800 text-white p-2 rounded-md transition-all duration-300 transform">Zaino di Pino</button>
                            <button id="select-pina-backpack-btn" class="flex-1 bg-purple-700 hover:bg-purple-800 text-white p-2 rounded-md transition-all duration-300 transform">Zaino di Pina</button>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 mt-6 fade-in-up hover-shadow-effect" style="animation-delay: 0.1s;">
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white">
                        <i data-lucide="package" class="w-5 h-5 text-purple-400"></i>Aggiungi Nuovo Oggetto
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="backpack-item-name" class="block text-sm font-medium text-gray-400 mb-1">Nome Oggetto</label>
                            <input type="text" id="backpack-item-name" class="form-input w-full p-2 border rounded-md text-sm" placeholder="Es. Adattatore universale">
                        </div>
                        <div>
                            <label for="backpack-item-type" class="block text-sm font-medium text-gray-400 mb-1">Tipologia</label>
                            <select id="backpack-item-type" class="form-input w-full p-2 border rounded-md text-sm">
                                <option>Abbigliamento</option>
                                <option>Elettronica</option>
                                <option>Igiene Personale</option>
                                <option>Documenti</option>
                                <option>Farmaci</option>
                                <option>Varie</option>
                            </select>
                        </div>
                        <div>
                            <label for="backpack-item-quantity" class="block text-sm font-medium text-gray-400 mb-1">Quantità</label>
                            <input type="number" id="backpack-item-quantity" class="form-input w-full p-2 border rounded-md text-sm" value="1" min="1">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="backpack-item-city-tag" class="block text-sm font-medium text-gray-400 mb-1">Città di Riferimento</label>
                            <select id="backpack-item-city-tag" class="form-input w-full p-2 border rounded-md text-sm">
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="backpack-item-file-url" class="block text-sm font-medium text-gray-400 mb-1">Link Allegato (URL)</label>
                            <input type="url" id="backpack-item-file-url" class="form-input w-full p-2 border rounded-md text-sm" placeholder="Es. https://link.al/documento.pdf">
                        </div>
                    </div>
                    <button id="add-backpack-item-btn" class="mt-3 w-full bg-purple-600 hover:bg-purple-700 text-white p-2 rounded-md transition-colors duration-200">
                        Aggiungi Oggetto
                    </button>
                </div>

                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 mt-6 fade-in-up hover-shadow-effect" style="animation-delay: 0.2s;">
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white">
                        <i data-lucide="filter" class="w-5 h-5 text-purple-400"></i>Filtra per Tipologia
                    </h3>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button id="filter-tutti-btn" class="filter-btn bg-purple-700 hover:bg-purple-800 text-white p-2 rounded-md transition-colors duration-200 text-sm">Tutti</button>
                        <button id="filter-abbigliamento-btn" class="filter-btn bg-purple-700 hover:bg-purple-800 text-white p-2 rounded-md transition-colors duration-200 text-sm">Abbigliamento</button>
                        <button id="filter-elettronica-btn" class="filter-btn bg-purple-700 hover:bg-purple-800 text-white p-2 rounded-md transition-colors duration-200 text-sm">Elettronica</button>
                        <button id="filter-igiene-personale-btn" class="filter-btn bg-purple-700 hover:bg-purple-800 text-white p-2 rounded-md transition-colors duration-200 text-sm">Igiene Personale</button>
                        <button id="filter-documenti-btn" class="filter-btn bg-purple-700 hover:bg-purple-800 text-white p-2 rounded-md transition-colors duration-200 text-sm">Documenti</button>
                        <button id="filter-farmaci-btn" class="filter-btn bg-purple-700 hover:bg-purple-800 text-white p-2 rounded-md transition-colors duration-200 text-sm">Farmaci</button>
                        <button id="filter-varie-btn" class="filter-btn bg-purple-700 hover:bg-purple-800 text-white p-2 rounded-md transition-colors duration-200 text-sm">Varie</button>
                    </div>
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white">
                        <i data-lucide="list-todo" class="w-5 h-5 text-purple-400"></i>Lista Oggetti
                    </h3>
                    <ul id="backpack-items-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                        <!-- Items will be loaded here by JS -->
                    </ul>
                </div>
            </main>
        </div>

        <!-- Map View (New) -->
        <div id="map-view" class="view-transition opacity-0 hidden">
            <header class="p-4 sm:p-6 flex justify-center items-center flex-col sm:flex-row">
                <div class="text-center">
                    <h1 class="text-2xl sm:text-3xl font-bold text-white">Mappa e Luoghi</h1>
                    <p class="text-gray-400">Esplora e salva i tuoi punti di interesse</p>
                </div>
            </header>
            <main class="p-4 sm:p-6">
                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 fade-in-up hover-shadow-effect">
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white">
                        <i data-lucide="map-pin" class="w-5 h-5 text-red-400"></i>Controlli Mappa
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="map-city-select" class="block text-sm font-medium text-gray-400 mb-1">Seleziona Città</label>
                            <select id="map-city-select" class="form-input w-full p-2 border rounded-md text-sm">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="radius-input" class="block text-sm font-medium text-gray-400 mb-1">Raggio (km) per Posizione Attuale</label>
                            <input type="number" id="radius-input" class="form-input w-full p-2 border rounded-md text-sm" value="5" min="1">
                        </div>
                    </div>
                    <button id="get-location-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-md transition-colors duration-200 flex items-center justify-center gap-2">
                        <i data-lucide="locate-fixed" class="w-5 h-5"></i>
                        Ottieni Posizione Attuale
                    </button>
                    <div class="mt-4">
                        <label for="search-query-input" class="block text-sm font-medium text-gray-400 mb-1">Cerca un luogo</label>
                        <input type="text" id="search-query-input" class="form-input w-full p-2 border rounded-md text-sm" placeholder="Es. Ristorante ramen, Tempio, Parco...">
                        <button id="search-places-btn" class="mt-3 w-full bg-red-600 hover:bg-red-700 text-white p-2 rounded-md transition-colors duration-200 flex items-center justify-center gap-2">
                            <i data-lucide="search" class="w-5 h-5"></i>
                            Cerca Luoghi
                        </button>
                        <button id="clear-search-btn" class="mt-2 w-full bg-gray-500 hover:bg-gray-600 text-white p-2 rounded-md transition-colors duration-200 flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="eraser" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">Pulisci Ricerca</span>
                        </button>
                    </div>
                </div>

                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 mt-6 fade-in-up hover-shadow-effect" style="animation-delay: 0.1s;">
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white">
                        <i data-lucide="map" class="w-5 h-5 text-red-400"></i>Mappa
                    </h3>
                    <div id="map"></div>
                </div>

                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 mt-6 fade-in-up hover-shadow-effect" style="animation-delay: 0.2s;">
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white">
                        <i data-lucide="list-checks" class="w-5 h-5 text-red-400"></i>Risultati Ricerca
                    </h3>
                    <ul id="search-results-list" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                        <li class="text-gray-400">Nessun risultato di ricerca.</li>
                    </ul>
                </div>

                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 mt-6 fade-in-up hover-shadow-effect" style="animation-delay: 0.3s;">
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white">
                        <i data-lucide="bookmark" class="w-5 h-5 text-red-400"></i>Aggiungi Nuovo Luogo Pinnato
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="pinned-place-name" class="block text-sm font-medium text-gray-400 mb-1">Nome Luogo</label>
                            <input type="text" id="pinned-place-name" class="form-input w-full p-2 border rounded-md text-sm" placeholder="Es. Tempio Senso-ji">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="pinned-place-lat" class="block text-sm font-medium text-gray-400 mb-1">Latitudine</label>
                                <input type="number" id="pinned-place-lat" class="form-input w-full p-2 border rounded-md text-sm" step="0.000001" placeholder="Latitudine">
                            </div>
                            <div>
                                <label for="pinned-place-lng" class="block text-sm font-medium text-gray-400 mb-1">Longitudine</label>
                                <input type="number" id="pinned-place-lng" class="form-input w-full p-2 border rounded-md text-sm" step="0.000001" placeholder="Longitudine">
                            </div>
                        </div>
                        <div>
                            <label for="pinned-place-date" class="block text-sm font-medium text-gray-400 mb-1">Data Prenotazione (Opz.)</label>
                            <input type="date" id="pinned-place-date" class="form-input w-full p-2 border rounded-md text-sm">
                        </div>
                        <div>
                            <label for="pinned-place-time" class="block text-sm font-medium text-gray-400 mb-1">Ora Prenotazione (Opz.)</label>
                            <input type="time" id="pinned-place-time" class="form-input w-full p-2 border rounded-md text-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label for="pinned-place-tag" class="block text-sm font-medium text-gray-400 mb-1">Tag</label>
                            <select id="pinned-place-tag" class="form-input w-full p-2 border rounded-md text-sm">
                                <option>Attrazione</option>
                                <option>Ristorante</option>
                                <option>Trasporto</option>
                                <option>Alloggio</option>
                                <option>Altro</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="pinned-place-notes" class="block text-sm font-medium text-gray-400 mb-1">Note</label>
                            <textarea id="pinned-place-notes" rows="2" class="form-input w-full p-2 border rounded-md text-sm" placeholder="Es. Non accetta prenotazioni, solo contanti."></textarea>
                        </div>
                    </div>
                    <button id="save-pinned-place-btn" class="mt-3 w-full bg-red-600 hover:bg-red-700 text-white p-2 rounded-md transition-colors duration-200">
                        Salva Luogo Pinnato
                    </button>
                    <button id="clear-pinned-place-form-btn" class="mt-2 w-full bg-gray-500 hover:bg-gray-600 text-white p-2 rounded-md transition-colors duration-200 flex items-center justify-center gap-2 text-sm">
                        <i data-lucide="eraser" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Pulisci Modulo</span>
                    </button>
                </div>

                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 mt-6 fade-in-up hover-shadow-effect" style="animation-delay: 0.4s;">
                    <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-white">
                        <i data-lucide="list-checks" class="w-5 h-5 text-red-400"></i>Luoghi Pinnati per <span id="current-map-city-display" class="ml-1 font-bold">Tokyo</span>
                    </h3>
                    <ul id="pinned-places-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                        <!-- Pinned places will be loaded here by JS -->
                    </ul>
                </div>
            </main>
        </div>
    </div>
    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 max-w-sm w-full text-center">
            <p id="custom-alert-message" class="text-white mb-4"></p>
            <button id="custom-alert-close-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                OK
            </button>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="custom-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 max-w-sm w-full text-center">
            <p id="custom-confirm-message" class="text-white mb-4"></p>
            <div class="flex justify-center gap-4">
                <button id="custom-confirm-yes-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                    Sì
                </button>
                <button id="custom-confirm-no-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                    No
                </button>
            </div>
        </div>
    </div>
    <script>
        lucide.createIcons();
    </script>
</body>
</html>
